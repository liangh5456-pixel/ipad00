<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPadè¨­å‚™é ç´„ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        header {
            background: linear-gradient(90deg, #3498db, #2c3e50);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .content {
            padding: 20px;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        /* é¦–é æ¨£å¼ */
        #home-page {
            text-align: center;
            padding: 30px 15px;
        }
        
        .home-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 30px 0;
        }
        
        .home-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            margin: 0 auto;
            text-align: center;
        }
        
        .home-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }
        
        .appointment-btn {
            background: linear-gradient(135deg, #3498db, #2c3e50);
        }
        
        .view-schedule-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .return-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .home-btn i {
            font-size: 35px;
            margin-bottom: 8px;
        }
        
        .home-btn span {
            font-size: 16px;
            font-weight: bold;
        }
        
        .description {
            margin-top: 20px;
            color: #7f8c8d;
            line-height: 1.5;
            font-size: 14px;
        }
        
        /* é ç´„è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* æ™‚é–“æ®µé¸æ“‡æ¨£å¼ */
        .time-selector {
            margin-top: 15px;
        }
        
        .time-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .time-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-input-group {
            flex: 1 1 45%;
            min-width: 0;
        }
        
        .selected-time {
            margin-top: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .conflict-warning {
            margin-top: 8px;
            padding: 8px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        
        .advance-warning {
            margin-top: 8px;
            padding: 8px;
            background: #fff3cd;
            color: #856404;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-print {
            background: #7d3c98;
            color: white;
        }
        
        .btn-print:hover {
            background: #6c3483;
        }
        
        .btn-disabled {
            background: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
        }
        
        /* å·²é ç´„æ™‚æ®µé é¢æ¨£å¼ */
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .week-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .nav-btn:hover {
            background: #2980b9;
        }
        
        .week-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .time-schedule {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        .time-header-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            background: #f8f9fa;
        }
        
        .time-header-cell {
            padding: 8px 3px;
            text-align: center;
            font-weight: 600;
            border-right: 1px solid #e0e0e0;
            font-size: 11px;
        }
        
        .time-slots-container {
            position: relative;
            height: 600px;
        }
        
        .time-slot-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            height: 30px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .time-label {
            padding: 3px;
            text-align: right;
            font-size: 10px;
            color: #666;
            border-right: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        .time-cell {
            border-right: 1px solid #e0e0e0;
            position: relative;
        }
        
        .appointment-block {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 3px;
            padding: 2px;
            font-size: 9px;
            color: white;
            overflow: hidden;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .appointment-block:hover {
            z-index: 20;
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .appointment-info {
            font-weight: bold;
            margin-bottom: 1px;
        }
        
        .appointment-time {
            font-size: 8px;
            opacity: 0.9;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 6px;
        }
        
        /* å¾Œå°ç®¡ç†æ¨£å¼ */
        .admin-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 3px 6px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .status-approved {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-returned {
            background: #d4edda;
            color: #155724;
        }
        
        /* äºŒç¶­ç¢¼æ¨£å¼ */
        .qrcode-container {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-top: 15px;
        }
        
        #qrcode {
            margin: 0 auto;
            max-width: 200px;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .nav-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }
        
        .nav-tab.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-link {
            color: white;
            text-decoration: none;
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 14px;
        }
        
        /* ç™»å…¥é é¢æ¨£å¼ */
        #login-page {
            text-align: center;
            padding: 30px 15px;
        }
        
        .login-form {
            max-width: 300px;
            margin: 0 auto;
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* ç³»çµ±è¨­å®šæ¨£å¼ */
        .settings-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setting-description {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        /* æ­¸é‚„ç™»è¨˜é é¢æ¨£å¼ */
        .return-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .return-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .return-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .return-item-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .return-actions {
            display: flex;
            gap: 8px;
        }
        
        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .return-check-options {
            margin-bottom: 15px;
        }
        
        .check-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .check-option input {
            width: auto;
            margin-right: 10px;
        }
        
        .check-option label {
            margin-bottom: 0;
            font-weight: normal;
        }
        
        /* é ç´„è©³æƒ…æ¨¡æ…‹æ¡†æ¨£å¼ */
        .appointment-details {
            margin-bottom: 15px;
        }
        
        .detail-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #555;
        }
        
        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 480px) {
            .time-inputs {
                flex-direction: column;
                gap: 8px;
            }
            
            .time-input-group {
                flex: 1 1 100%;
            }
            
            .time-header-cell {
                font-size: 10px;
                padding: 6px 2px;
            }
            
            .time-label {
                font-size: 9px;
            }
            
            .buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
            }
            
            .return-actions {
                flex-direction: column;
            }
        }
        
        /* æ‰“å°æ¨£å¼ */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container,
            .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 9999;
                display: block !important;
                padding: 20px;
            }
            .buttons {
                display: none !important;
            }
        }
        
        /* æ‰“å°å°ˆç”¨å®¹å™¨ */
        .print-container {
            display: none;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .print-details {
            width: 100%;
        }
        
        .print-detail-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .print-label {
            font-weight: bold;
            width: 30%;
        }
        
        .print-value {
            width: 65%;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        /* æˆåŠŸæç¤º */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        /* åŠ è¼‰æŒ‡ç¤ºå™¨ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>iPadè¨­å‚™é ç´„ç³»çµ±</h1>
            <div class="subtitle">ä¾¿æ·é ç´„ï¼Œé«˜æ•ˆç®¡ç†</div>
            <a href="#" id="admin-link" class="admin-link">ç®¡ç†å“¡</a>
        </header>
        
        <div class="content">
            <!-- é¦–é  -->
            <div id="home-page" class="page active">
                <h2>æ­¡è¿ä½¿ç”¨iPadé ç´„ç³»çµ±</h2>
                <div class="home-buttons">
                    <div class="home-btn appointment-btn" id="go-to-appointment">
                        <i>ğŸ“±</i>
                        <span>è¨­å‚™é ç´„</span>
                    </div>
                    <div class="home-btn view-schedule-btn" id="go-to-schedule">
                        <i>ğŸ“…</i>
                        <span>å·²é ç´„æ™‚æ®µ</span>
                    </div>
                    <div class="home-btn return-btn" id="go-to-return">
                        <i>ğŸ“‹</i>
                        <span>æ­¸é‚„ç™»è¨˜</span>
                    </div>
                </div>
                <div class="description">
                    <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹é ç´„iPadè¨­å‚™æˆ–æŸ¥çœ‹å·²é ç´„æ™‚æ®µ</p>
                    <p>è«‹æå‰è¦åŠƒä½¿ç”¨æ™‚é–“ï¼ŒæŒ‰æ™‚æ­¸é‚„è¨­å‚™</p>
                </div>
            </div>
            
            <!-- é ç´„é é¢ -->
            <div id="appointment-page" class="page">
                <h2>iPadè¨­å‚™é ç´„</h2>
                <div class="success-message" id="success-message">
                    é ç´„æˆåŠŸï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ç”³è«‹ã€‚
                </div>
                <form id="appointment-form">
                    <div class="form-group">
                        <label for="applicant">ç”³è«‹äºº</label>
                        <input type="text" id="applicant" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="applicant-phone">è¯ç¹«é›»è©±</label>
                        <input type="tel" id="applicant-phone" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼" pattern="[0-9]{11}" maxlength="11" required>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">è«‹è¼¸å…¥11ä½æ‰‹æ©Ÿè™Ÿç¢¼</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ipad-count">ç”³è«‹iPadæ•¸é‡ (1-48å°)</label>
                        <select id="ipad-count" required>
                            <option value="">è«‹é¸æ“‡æ•¸é‡</option>
                            <!-- é¸é …å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="purpose">ä½¿ç”¨ç›®çš„</label>
                        <textarea id="purpose" rows="3" placeholder="è«‹ç°¡è¦èªªæ˜ä½¿ç”¨iPadçš„ç›®çš„"></textarea>
                    </div>
                    
                    <div class="time-selector">
                        <div class="time-header">é¸æ“‡é ç´„æ™‚æ®µ</div>
                        
                        <div class="time-inputs">
                            <div class="time-input-group">
                                <label for="start-date">é–‹å§‹æ—¥æœŸ</label>
                                <input type="date" id="start-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="start-time">é–‹å§‹æ™‚é–“</label>
                                <select id="start-time" required>
                                    <option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>
                                    <!-- é¸é …å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                                </select>
                            </div>
                            <div class="time-input-group">
                                <label for="end-date">çµæŸæ—¥æœŸ</label>
                                <input type="date" id="end-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="end-time">çµæŸæ™‚é–“</label>
                                <select id="end-time" required>
                                    <option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>
                                    <!-- é¸é …å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="selected-time" id="selected-time">
                            æœªé¸æ“‡æ™‚é–“æ®µ
                        </div>
                        
                        <div class="conflict-warning" id="conflict-warning">
                            <!-- è¡çªè­¦å‘Šå°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        
                        <div class="advance-warning" id="advance-warning">
                            <!-- æå‰é ç´„è­¦å‘Šå°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary" id="submit-btn">æäº¤é ç´„</button>
                    </div>
                </form>
            </div>
            
            <!-- å·²é ç´„æ™‚æ®µé é¢ -->
            <div id="schedule-page" class="page">
                <div class="schedule-header">
                    <h2>å·²é ç´„æ™‚æ®µ</h2>
                    <div class="week-nav">
                        <div class="nav-btn" id="prev-week">â†</div>
                        <div class="week-title" id="week-title">æœ¬é€±é ç´„æƒ…æ³</div>
                        <div class="nav-btn" id="next-week">â†’</div>
                    </div>
                </div>
                
                <div class="time-schedule">
                    <div class="time-header-row" id="schedule-header">
                        <!-- è¡¨é ­å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="time-slots-container" id="time-slots-container">
                        <!-- æ™‚é–“æ®µå°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="legend" id="schedule-legend">
                    <!-- åœ–ä¾‹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-schedule">è¿”å›é¦–é </button>
                </div>
            </div>
            
            <!-- æ­¸é‚„ç™»è¨˜é é¢ -->
            <div id="return-page" class="page">
                <h2>è¨­å‚™æ­¸é‚„ç™»è¨˜</h2>
                <div class="return-list" id="return-list">
                    <!-- æ­¸é‚„åˆ—è¡¨å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-return">è¿”å›é¦–é </button>
                </div>
            </div>
            
            <!-- ç™»å…¥é é¢ -->
            <div id="login-page" class="page">
                <h2>ç®¡ç†å“¡ç™»å…¥</h2>
                <form id="login-form" class="login-form">
                    <div class="form-group">
                        <label for="username">å¸³è™Ÿ</label>
                        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">å¯†ç¢¼</label>
                        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    
                    <div class="login-error" id="login-error">
                        å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home-from-login">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary">ç™»å…¥</button>
                    </div>
                </form>
            </div>
            
            <!-- å¾Œå°ç®¡ç†é é¢ -->
            <div id="admin-page" class="page">
                <h2>é ç´„ç®¡ç†å¾Œå°</h2>
                
                <div class="nav-tabs">
                    <div class="nav-tab active" data-tab="appointments">é ç´„è¨˜éŒ„</div>
                    <div class="nav-tab" data-tab="settings">ç³»çµ±è¨­å®š</div>
                    <div class="nav-tab" data-tab="password">ä¿®æ”¹å¯†ç¢¼</div>
                    <div class="nav-tab" data-tab="qrcode">é ç´„äºŒç¶­ç¢¼</div>
                </div>
                
                <div class="tab-content active" id="appointments-tab">
                    <div class="admin-controls">
                        <button class="btn-primary" id="refresh-appointments">åˆ·æ–°æ•¸æ“š</button>
                        <button class="btn-danger" id="clear-all-appointments">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</button>
                        <button class="btn-secondary" id="back-to-home-admin">è¿”å›é¦–é </button>
                    </div>
                    
                    <table id="appointments-table">
                        <thead>
                            <tr>
                                <th>ç”³è«‹äºº</th>
                                <th>è¯ç¹«é›»è©±</th>
                                <th>iPadæ•¸é‡</th>
                                <th>å€Ÿç”¨æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- é ç´„æ•¸æ“šå°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-content" id="settings-tab">
                    <div class="settings-group">
                        <h3>é ç´„è¨­å®š</h3>
                        <div class="setting-item">
                            <label for="advance-days">æå‰é ç´„å¤©æ•¸</label>
                            <input type="number" id="advance-days" min="1" max="30" value="3">
                        </div>
                        <div class="setting-description">
                            è¨­ç½®ç”¨æˆ¶å¿…é ˆæå‰å¤šå°‘å¤©é€²è¡Œé ç´„ã€‚ä¾‹å¦‚ï¼šè¨­ç½®ç‚º3ï¼Œå‰‡ç”¨æˆ¶åªèƒ½é ç´„3å¤©å¾Œçš„æ—¥æœŸã€‚
                        </div>
                        
                        <div class="setting-item">
                            <label for="admin-phone">ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼</label>
                            <input type="tel" id="admin-phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
                        </div>
                        <div class="setting-description">
                            è¨­ç½®ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œç”¨æ–¼æ¥æ”¶æ–°é ç´„é€šçŸ¥ã€‚
                        </div>
                        
                        <div class="buttons" style="margin-top: 15px;">
                            <button class="btn-primary" id="save-settings">ä¿å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="password-tab">
                    <div class="settings-group">
                        <h3>ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
                        <div class="form-group">
                            <label for="current-password">ç•¶å‰å¯†ç¢¼</label>
                            <input type="password" id="current-password" placeholder="è«‹è¼¸å…¥ç•¶å‰å¯†ç¢¼" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password">æ–°å¯†ç¢¼</label>
                            <input type="password" id="new-password" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm-password" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        
                        <div class="buttons" style="margin-top: 15px;">
                            <button class="btn-primary" id="change-password">ä¿®æ”¹å¯†ç¢¼</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="qrcode-tab">
                    <div class="qrcode-container">
                        <h3>æƒæäºŒç¶­ç¢¼é€²è¡Œé ç´„</h3>
                        <div id="qrcode"></div>
                        <p>ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸Šæ–¹äºŒç¶­ç¢¼</p>
                        <button class="btn-secondary" id="back-from-qrcode" style="margin-top: 15px;">è¿”å›ç®¡ç†</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ­¸é‚„ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="return-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">è¨­å‚™æ­¸é‚„ç¢ºèª</div>
                <button class="close-modal" id="close-return-modal">Ã—</button>
            </div>
            <div id="return-modal-content">
                <!-- å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- é ç´„è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="appointment-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">é ç´„è©³æƒ…</div>
                <button class="close-modal" id="close-appointment-detail-modal">Ã—</button>
            </div>
            <div id="appointment-detail-content">
                <!-- å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- é§å›ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="reject-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">é§å›é ç´„ç”³è«‹</div>
                <button class="close-modal" id="close-reject-modal">Ã—</button>
            </div>
            <div id="reject-modal-content">
                <!-- å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ‰“å°å°ˆç”¨å®¹å™¨ -->
    <div class="print-container" id="print-container">
        <div class="print-header">
            <h1>iPadè¨­å‚™é ç´„è©³æƒ…</h1>
            <p>é ç´„ç³»çµ±æ‰“å°æ†‘è­‰</p>
        </div>
        <div class="print-details" id="print-details">
            <!-- æ‰“å°å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="print-footer">
            <p>æ‰“å°æ™‚é–“: <span id="print-time"></span></p>
            <p>è«‹å¦¥å–„ä¿ç®¡æ­¤æ†‘è­‰</p>
        </div>
    </div>

    <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading"></div>
        <span>æ­£åœ¨åŠ è¼‰æ•¸æ“š...</span>
    </div>

    <script>
        // Google Sheets API é…ç½®
        const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_GOOGLE_APPS_SCRIPT_ID/exec'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„Google Apps Scriptéƒ¨ç½²ID
        
        // ç³»çµ±è¨­å®š
        let systemSettings = {
            enableApproval: false,
            advanceDays: 3,
            adminPhone: ""
        };
        
        // ç®¡ç†å“¡å¯†ç¢¼
        let adminPassword = localStorage.getItem('adminPassword') || 'ipadadmin';
        
        // ç•¶å‰æŸ¥çœ‹çš„é€±æ¬¡
        let currentWeekOffset = 0;
        let isAdminLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
        let lastActivityTime = localStorage.getItem('lastActivityTime') ? parseInt(localStorage.getItem('lastActivityTime')) : Date.now();
        let logoutTimer;
        
        // é ç´„æ•¸æ“š
        let appointments = [];
        
        // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        // åˆå§‹åŒ–å‡½æ•¸
        function init() {
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•ç™»å‡ºï¼ˆ30åˆ†é˜ç„¡æ“ä½œï¼‰
            const currentTime = Date.now();
            if (currentTime - lastActivityTime > 30 * 60 * 1000) {
                isAdminLoggedIn = false;
                localStorage.setItem('adminLoggedIn', 'false');
            }
            updateLastActivityTime();
            
            // åˆå§‹åŒ–é é¢å°èˆª
            initNavigation();
            
            // åˆå§‹åŒ–è¡¨å–®
            initForm();
            
            // åˆå§‹åŒ–æ™‚é–“é¸æ“‡å™¨
            initTimeSelector();
            
            // åˆå§‹åŒ–ç®¡ç†å“¡éˆæ¥
            initAdminLink();
            
            // åŠ è¼‰ç³»çµ±è¨­å®š
            loadSettings();
            
            // åŠ è¼‰é ç´„æ•¸æ“š
            loadAppointments();
            
            // è¨­ç½®å®šæ™‚å™¨æª¢æŸ¥ç™»å‡º
            startLogoutTimer();
        }
        
        // æ›´æ–°æœ€å¾Œæ´»å‹•æ™‚é–“
        function updateLastActivityTime() {
            lastActivityTime = Date.now();
            localStorage.setItem('lastActivityTime', lastActivityTime.toString());
        }
        
        // é–‹å§‹ç™»å‡ºè¨ˆæ™‚å™¨
        function startLogoutTimer() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(() => {
                if (isAdminLoggedIn) {
                    logout();
                }
            }, 30 * 60 * 1000); // 30åˆ†é˜
        }
        
        // ç™»å‡º
        function logout() {
            isAdminLoggedIn = false;
            localStorage.setItem('adminLoggedIn', 'false');
            alert('ç”±æ–¼é•·æ™‚é–“ç„¡æ“ä½œï¼Œæ‚¨å·²è‡ªå‹•ç™»å‡ºã€‚');
            showPage('home-page');
        }
        
        // åˆå§‹åŒ–é é¢å°èˆª
        function initNavigation() {
            // é¦–é æŒ‰éˆ•
            document.getElementById('go-to-appointment').addEventListener('click', () => showPage('appointment-page'));
            document.getElementById('go-to-schedule').addEventListener('click', () => {
                currentWeekOffset = 0;
                renderSchedule();
                showPage('schedule-page');
            });
            document.getElementById('go-to-return').addEventListener('click', () => {
                renderReturnList();
                showPage('return-page');
            });
            
            // è¿”å›é¦–é æŒ‰éˆ•
            document.getElementById('back-to-home').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-from-schedule').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-from-return').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-from-login').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-admin').addEventListener('click', () => showPage('home-page'));
            
            // é€±æ¬¡å°èˆª
            document.getElementById('prev-week').addEventListener('click', () => {
                currentWeekOffset--;
                renderSchedule();
            });
            document.getElementById('next-week').addEventListener('click', () => {
                currentWeekOffset++;
                renderSchedule();
            });
            
            // ç®¡ç†å“¡ç™»å…¥
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // ç®¡ç†é é¢æ¨™ç±¤åˆ‡æ›
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // ç®¡ç†é é¢æ“ä½œ
            document.getElementById('refresh-appointments').addEventListener('click', loadAppointments);
            document.getElementById('clear-all-appointments').addEventListener('click', clearAllAppointments);
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('change-password').addEventListener('click', changePassword);
            document.getElementById('back-from-qrcode').addEventListener('click', () => switchTab('appointments'));
            
            // æ¨¡æ…‹æ¡†é—œé–‰æŒ‰éˆ•
            document.getElementById('close-return-modal').addEventListener('click', () => {
                document.getElementById('return-modal').style.display = 'none';
            });
            document.getElementById('close-appointment-detail-modal').addEventListener('click', () => {
                document.getElementById('appointment-detail-modal').style.display = 'none';
            });
            document.getElementById('close-reject-modal').addEventListener('click', () => {
                document.getElementById('reject-modal').style.display = 'none';
            });
            
            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            document.getElementById('return-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('return-modal')) {
                    document.getElementById('return-modal').style.display = 'none';
                }
            });
            document.getElementById('appointment-detail-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('appointment-detail-modal')) {
                    document.getElementById('appointment-detail-modal').style.display = 'none';
                }
            });
            document.getElementById('reject-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('reject-modal')) {
                    document.getElementById('reject-modal').style.display = 'none';
                }
            });
        }
        
        // åˆå§‹åŒ–ç®¡ç†å“¡éˆæ¥
        function initAdminLink() {
            const adminLink = document.getElementById('admin-link');
            adminLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (isAdminLoggedIn) {
                    showPage('admin-page');
                    loadAppointments();
                } else {
                    showPage('login-page');
                }
            });
        }
        
        // åˆå§‹åŒ–è¡¨å–®
        function initForm() {
            // ç”ŸæˆiPadæ•¸é‡é¸é …
            const ipadCountSelect = document.getElementById('ipad-count');
            for (let i = 1; i <= 48; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + ' å°';
                ipadCountSelect.appendChild(option);
            }
            
            // è¨­ç½®æ—¥æœŸæœ€å°å€¼ç‚ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').min = today;
            document.getElementById('end-date').min = today;
            
            // è¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('appointment-form').addEventListener('submit', handleAppointmentSubmit);
            
            // æ—¥æœŸå’Œæ™‚é–“è®ŠåŒ–äº‹ä»¶
            document.getElementById('start-date').addEventListener('change', updateTimeSelection);
            document.getElementById('end-date').addEventListener('change', updateTimeSelection);
            document.getElementById('start-time').addEventListener('change', updateSelectedTime);
            document.getElementById('end-time').addEventListener('change', updateSelectedTime);
        }
        
        // åˆå§‹åŒ–æ™‚é–“é¸æ“‡å™¨
        function initTimeSelector() {
            const startTimeSelect = document.getElementById('start-time');
            const endTimeSelect = document.getElementById('end-time');
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            startTimeSelect.innerHTML = '<option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>';
            endTimeSelect.innerHTML = '<option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>';
            
            // ç”Ÿæˆæ™‚é–“é¸é …ï¼ˆå¾8:00åˆ°22:00ï¼Œæ¯30åˆ†é˜ä¸€å€‹é¸é …ï¼‰
            for (let hour = 8; hour <= 22; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    const startOption = document.createElement('option');
                    startOption.value = timeString;
                    startOption.textContent = timeString;
                    startTimeSelect.appendChild(startOption);
                    
                    const endOption = document.createElement('option');
                    endOption.value = timeString;
                    endOption.textContent = timeString;
                    endTimeSelect.appendChild(endOption);
                }
            }
        }
        
        // æ›´æ–°æ™‚é–“é¸æ“‡
        function updateTimeSelection() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            // å¦‚æœçµæŸæ—¥æœŸæ—©æ–¼é–‹å§‹æ—¥æœŸï¼Œè‡ªå‹•èª¿æ•´
            if (endDate && startDate && endDate < startDate) {
                document.getElementById('end-date').value = startDate;
            }
            
            // æª¢æŸ¥æå‰é ç´„é™åˆ¶
            checkAdvanceBooking();
            
            // æ›´æ–°å·²é¸æ™‚é–“é¡¯ç¤º
            updateSelectedTime();
        }
        
        // æª¢æŸ¥æå‰é ç´„é™åˆ¶
        function checkAdvanceBooking() {
            const startDate = document.getElementById('start-date').value;
            const advanceWarning = document.getElementById('advance-warning');
            
            if (!startDate) {
                advanceWarning.style.display = 'none';
                return;
            }
            
            const today = new Date();
            const start = new Date(startDate);
            const diffTime = start - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < systemSettings.advanceDays) {
                advanceWarning.textContent = `æ³¨æ„ï¼šæ‚¨åªèƒ½é ç´„${systemSettings.advanceDays}å¤©å¾Œçš„æ—¥æœŸï¼Œè«‹é‡æ–°é¸æ“‡ã€‚`;
                advanceWarning.style.display = 'block';
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').classList.add('btn-disabled');
            } else {
                advanceWarning.style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('submit-btn').classList.remove('btn-disabled');
            }
        }
        
        // æ›´æ–°å·²é¸æ™‚é–“é¡¯ç¤º
        function updateSelectedTime() {
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            
            const selectedTimeElement = document.getElementById('selected-time');
            
            if (startDate && startTime && endDate && endTime) {
                selectedTimeElement.textContent = `å·²é¸æ“‡: ${startDate} ${startTime} è‡³ ${endDate} ${endTime}`;
                
                // æª¢æŸ¥æ™‚é–“è¡çª
                checkTimeConflict();
            } else {
                selectedTimeElement.textContent = 'æœªé¸æ“‡æ™‚é–“æ®µ';
            }
        }
        
        // æª¢æŸ¥æ™‚é–“è¡çª
        function checkTimeConflict() {
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            const ipadCount = parseInt(document.getElementById('ipad-count').value);
            
            if (!startDate || !startTime || !endDate || !endTime || !ipadCount) {
                return;
            }
            
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(`${endDate}T${endTime}`);
            
            // æª¢æŸ¥æ™‚é–“æ˜¯å¦æœ‰æ•ˆ
            if (endDateTime <= startDateTime) {
                document.getElementById('conflict-warning').textContent = 'éŒ¯èª¤ï¼šçµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“';
                document.getElementById('conflict-warning').style.display = 'block';
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').classList.add('btn-disabled');
                return;
            }
            
            // æª¢æŸ¥ç¸½æ™‚é•·æ˜¯å¦è¶…éé™åˆ¶ï¼ˆä¾‹å¦‚24å°æ™‚ï¼‰
            const durationHours = (endDateTime - startDateTime) / (1000 * 60 * 60);
            if (durationHours > 24) {
                document.getElementById('conflict-warning').textContent = 'éŒ¯èª¤ï¼šå–®æ¬¡é ç´„æ™‚é•·ä¸èƒ½è¶…é24å°æ™‚';
                document.getElementById('conflict-warning').style.display = 'block';
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').classList.add('btn-disabled');
                return;
            }
            
            // æª¢æŸ¥èˆ‡ç¾æœ‰é ç´„çš„è¡çª
            let totalRequested = ipadCount;
            
            for (const appointment of appointments) {
                if (appointment.status === 'rejected' || appointment.status === 'returned') {
                    continue;
                }
                
                const appStart = new Date(appointment.startTime);
                const appEnd = new Date(appointment.endTime);
                
                // æª¢æŸ¥æ™‚é–“æ˜¯å¦æœ‰é‡ç–Š
                if (startDateTime < appEnd && endDateTime > appStart) {
                    totalRequested += appointment.ipadCount;
                }
            }
            
            // æª¢æŸ¥ç¸½æ•¸æ˜¯å¦è¶…é48å°
            if (totalRequested > 48) {
                document.getElementById('conflict-warning').textContent = `è­¦å‘Šï¼šè©²æ™‚æ®µå·²æœ‰ ${totalRequested - ipadCount} å°iPadè¢«é ç´„ï¼ŒåŠ ä¸Šæ‚¨çš„ ${ipadCount} å°å°‡è¶…éç¸½æ•¸48å°`;
                document.getElementById('conflict-warning').style.display = 'block';
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').classList.add('btn-disabled');
            } else {
                document.getElementById('conflict-warning').style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('submit-btn').classList.remove('btn-disabled');
            }
        }
        
        // è™•ç†é ç´„æäº¤
        function handleAppointmentSubmit(e) {
            e.preventDefault();
            
            const applicant = document.getElementById('applicant').value;
            const applicantPhone = document.getElementById('applicant-phone').value;
            const ipadCount = parseInt(document.getElementById('ipad-count').value);
            const purpose = document.getElementById('purpose').value;
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            
            // å‰µå»ºé ç´„å°è±¡
            const appointment = {
                id: Date.now().toString(),
                applicant,
                applicantPhone,
                ipadCount,
                purpose,
                startTime: `${startDate}T${startTime}`,
                endTime: `${endDate}T${endTime}`,
                status: systemSettings.enableApproval ? 'pending' : 'approved',
                createTime: new Date().toISOString()
            };
            
            // ä¿å­˜é ç´„
            saveAppointment(appointment);
            
            // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
            document.getElementById('success-message').style.display = 'block';
            
            // é‡ç½®è¡¨å–®
            document.getElementById('appointment-form').reset();
            document.getElementById('selected-time').textContent = 'æœªé¸æ“‡æ™‚é–“æ®µ';
            document.getElementById('conflict-warning').style.display = 'none';
            document.getElementById('advance-warning').style.display = 'none';
            
            // 3ç§’å¾Œéš±è—æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                document.getElementById('success-message').style.display = 'none';
            }, 3000);
        }
        
        // ä¿å­˜é ç´„åˆ°Google Sheets
        function saveAppointment(appointment) {
            showLoading();
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'addAppointment',
                    data: appointment
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    // æ·»åŠ åˆ°æœ¬åœ°æ•¸çµ„
                    appointments.push(appointment);
                    
                    // å¦‚æœå•Ÿç”¨äº†å¯©æ‰¹ï¼Œç™¼é€é€šçŸ¥
                    if (systemSettings.enableApproval && systemSettings.adminPhone) {
                        sendNotification(appointment);
                    }
                } else {
                    alert('ä¿å­˜å¤±æ•—: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('ä¿å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
            });
        }
        
        // ç™¼é€é€šçŸ¥
        function sendNotification(appointment) {
            // é€™è£¡å¯ä»¥é›†æˆçŸ­ä¿¡APIæˆ–éƒµä»¶API
            // ç¤ºä¾‹ï¼šä½¿ç”¨Twilioç™¼é€çŸ­ä¿¡
            console.log('ç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡:', systemSettings.adminPhone);
            console.log('æ–°é ç´„ç”³è«‹:', appointment);
        }
        
        // å¾Google SheetsåŠ è¼‰é ç´„æ•¸æ“š
        function loadAppointments() {
            showLoading();
            
            fetch(SCRIPT_URL + '?action=getAppointments')
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    appointments = data.data || [];
                    
                    // æ›´æ–°ç®¡ç†é é¢çš„è¡¨æ ¼
                    if (document.getElementById('admin-page').classList.contains('active')) {
                        renderAppointmentsTable();
                    }
                    
                    // æ›´æ–°é ç´„æ™‚æ®µé é¢
                    if (document.getElementById('schedule-page').classList.contains('active')) {
                        renderSchedule();
                    }
                } else {
                    console.error('åŠ è¼‰å¤±æ•—:', data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('åŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
            });
        }
        
        // æ¸²æŸ“é ç´„è¡¨æ ¼ï¼ˆç®¡ç†é é¢ï¼‰
        function renderAppointmentsTable() {
            const tableBody = document.querySelector('#appointments-table tbody');
            tableBody.innerHTML = '';
            
            // æŒ‰å‰µå»ºæ™‚é–“å€’åºæ’åˆ—
            const sortedAppointments = [...appointments].sort((a, b) => 
                new Date(b.createTime) - new Date(a.createTime)
            );
            
            sortedAppointments.forEach(appointment => {
                const row = document.createElement('tr');
                
                // ç”³è«‹äºº
                const applicantCell = document.createElement('td');
                applicantCell.textContent = appointment.applicant;
                row.appendChild(applicantCell);
                
                // è¯ç¹«é›»è©±
                const phoneCell = document.createElement('td');
                phoneCell.textContent = appointment.applicantPhone;
                row.appendChild(phoneCell);
                
                // iPadæ•¸é‡
                const countCell = document.createElement('td');
                countCell.textContent = appointment.ipadCount + ' å°';
                row.appendChild(countCell);
                
                // å€Ÿç”¨æ™‚é–“
                const timeCell = document.createElement('td');
                const start = new Date(appointment.startTime);
                const end = new Date(appointment.endTime);
                timeCell.textContent = `${formatDate(start)} ${formatTime(start)} - ${formatTime(end)}`;
                row.appendChild(timeCell);
                
                // ç‹€æ…‹
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.className = `status status-${appointment.status}`;
                
                let statusText = '';
                switch (appointment.status) {
                    case 'pending':
                        statusText = 'å¾…å¯©æ ¸';
                        break;
                    case 'approved':
                        statusText = 'å·²æ‰¹å‡†';
                        break;
                    case 'rejected':
                        statusText = 'å·²é§å›';
                        break;
                    case 'returned':
                        statusText = 'å·²æ­¸é‚„';
                        break;
                }
                
                statusSpan.textContent = statusText;
                statusCell.appendChild(statusSpan);
                row.appendChild(statusCell);
                
                // æ“ä½œ
                const actionsCell = document.createElement('td');
                
                // è©³æƒ…æŒ‰éˆ•
                const detailBtn = document.createElement('button');
                detailBtn.className = 'btn-secondary';
                detailBtn.textContent = 'è©³æƒ…';
                detailBtn.style.marginRight = '5px';
                detailBtn.addEventListener('click', () => showAppointmentDetail(appointment));
                actionsCell.appendChild(detailBtn);
                
                // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºä¸åŒæ“ä½œ
                if (appointment.status === 'pending') {
                    // æ‰¹å‡†æŒ‰éˆ•
                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'btn-success';
                    approveBtn.textContent = 'æ‰¹å‡†';
                    approveBtn.style.marginRight = '5px';
                    approveBtn.addEventListener('click', () => updateAppointmentStatus(appointment.id, 'approved'));
                    actionsCell.appendChild(approveBtn);
                    
                    // é§å›æŒ‰éˆ•
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'btn-danger';
                    rejectBtn.textContent = 'é§å›';
                    rejectBtn.addEventListener('click', () => showRejectModal(appointment.id));
                    actionsCell.appendChild(rejectBtn);
                } else if (appointment.status === 'approved') {
                    // æ­¸é‚„æŒ‰éˆ•
                    const returnBtn = document.createElement('button');
                    returnBtn.className = 'btn-warning';
                    returnBtn.textContent = 'æ­¸é‚„';
                    returnBtn.addEventListener('click', () => showReturnModal(appointment));
                    actionsCell.appendChild(returnBtn);
                }
                
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // æ¸²æŸ“é ç´„æ™‚æ®µé é¢
        function renderSchedule() {
            // è¨ˆç®—ç•¶å‰é€±çš„æ—¥æœŸç¯„åœ
            const now = new Date();
            const currentDay = now.getDay(); // 0 = æ˜ŸæœŸæ—¥, 1 = æ˜ŸæœŸä¸€, ..., 6 = æ˜ŸæœŸå…­
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - currentDay + (currentDay === 0 ? -6 : 1) + (currentWeekOffset * 7));
            
            // æ›´æ–°é€±æ¨™é¡Œ
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const weekTitle = document.getElementById('week-title');
            weekTitle.textContent = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
            
            // æ¸²æŸ“è¡¨é ­
            renderScheduleHeader(startOfWeek);
            
            // æ¸²æŸ“æ™‚é–“æ®µ
            renderTimeSlots(startOfWeek);
            
            // æ¸²æŸ“åœ–ä¾‹
            renderLegend();
        }
        
        // æ¸²æŸ“é ç´„æ™‚æ®µè¡¨é ­
        function renderScheduleHeader(startOfWeek) {
            const headerRow = document.getElementById('schedule-header');
            headerRow.innerHTML = '';
            
            // æ™‚é–“æ¨™ç±¤
            const timeLabel = document.createElement('div');
            timeLabel.className = 'time-header-cell';
            timeLabel.textContent = 'æ™‚é–“';
            headerRow.appendChild(timeLabel);
            
            // æ—¥æœŸæ¨™ç±¤
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                
                const dateCell = document.createElement('div');
                dateCell.className = 'time-header-cell';
                
                const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
                dateCell.textContent = `${formatDate(date)} ${dayNames[date.getDay()]}`;
                
                headerRow.appendChild(dateCell);
            }
        }
        
        // æ¸²æŸ“æ™‚é–“æ®µ
        function renderTimeSlots(startOfWeek) {
            const container = document.getElementById('time-slots-container');
            container.innerHTML = '';
            
            // å‰µå»ºæ™‚é–“æ®µï¼ˆå¾8:00åˆ°22:00ï¼Œæ¯30åˆ†é˜ä¸€å€‹æ™‚æ®µï¼‰
            for (let hour = 8; hour <= 22; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    const row = document.createElement('div');
                    row.className = 'time-slot-row';
                    
                    // æ™‚é–“æ¨™ç±¤
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'time-label';
                    timeLabel.textContent = timeString;
                    row.appendChild(timeLabel);
                    
                    // æ—¥æœŸå–®å…ƒæ ¼
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + i);
                        
                        const cell = document.createElement('div');
                        cell.className = 'time-cell';
                        cell.setAttribute('data-date', formatDate(date));
                        cell.setAttribute('data-time', timeString);
                        row.appendChild(cell);
                    }
                    
                    container.appendChild(row);
                }
            }
            
            // æ¸²æŸ“é ç´„å¡Š
            renderAppointmentBlocks(startOfWeek);
        }
        
        // æ¸²æŸ“é ç´„å¡Š
        function renderAppointmentBlocks(startOfWeek) {
            // è¨ˆç®—ç•¶å‰é€±çš„é–‹å§‹å’ŒçµæŸæ™‚é–“
            const weekStart = new Date(startOfWeek);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 7);
            weekEnd.setHours(23, 59, 59, 999);
            
            // éæ¿¾å‡ºç•¶å‰é€±çš„é ç´„
            const weekAppointments = appointments.filter(appointment => {
                const start = new Date(appointment.startTime);
                const end = new Date(appointment.endTime);
                
                return (start < weekEnd && end > weekStart) && 
                       (appointment.status === 'approved' || appointment.status === 'pending');
            });
            
            // æ¸²æŸ“æ¯å€‹é ç´„å¡Š
            weekAppointments.forEach(appointment => {
                renderAppointmentBlock(appointment, startOfWeek);
            });
        }
        
        // æ¸²æŸ“å–®å€‹é ç´„å¡Š
        function renderAppointmentBlock(appointment, startOfWeek) {
            const start = new Date(appointment.startTime);
            const end = new Date(appointment.endTime);
            
            // è¨ˆç®—é ç´„å¡Šçš„ä½ç½®å’Œå°ºå¯¸
            const startDate = formatDate(start);
            const startTime = formatTime(start);
            const endTime = formatTime(end);
            
            // æŸ¥æ‰¾å°æ‡‰çš„æ—¥æœŸå–®å…ƒæ ¼
            const dateCells = document.querySelectorAll(`.time-cell[data-date="${startDate}"]`);
            if (dateCells.length === 0) return;
            
            // è¨ˆç®—é–‹å§‹å’ŒçµæŸçš„è¡Œç´¢å¼•
            const startHour = start.getHours();
            const startMinute = start.getMinutes();
            const endHour = end.getHours();
            const endMinute = end.getMinutes();
            
            const startRowIndex = (startHour - 8) * 2 + (startMinute === 30 ? 1 : 0);
            const endRowIndex = (endHour - 8) * 2 + (endMinute === 30 ? 1 : 0);
            
            // è¨ˆç®—é«˜åº¦ï¼ˆæ¯å€‹æ™‚é–“æ®µ30pxï¼‰
            const height = (endRowIndex - startRowIndex) * 30;
            
            // è¨ˆç®—é ‚éƒ¨ä½ç½®
            const top = startRowIndex * 30;
            
            // å‰µå»ºé ç´„å¡Š
            const block = document.createElement('div');
            block.className = 'appointment-block';
            block.style.top = `${top}px`;
            block.style.height = `${height}px`;
            
            // æ ¹æ“šç‹€æ…‹è¨­ç½®èƒŒæ™¯é¡è‰²
            if (appointment.status === 'approved') {
                block.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            } else if (appointment.status === 'pending') {
                block.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            }
            
            // æ·»åŠ å…§å®¹
            const info = document.createElement('div');
            info.className = 'appointment-info';
            info.textContent = `${appointment.applicant} (${appointment.ipadCount}å°)`;
            
            const time = document.createElement('div');
            time.className = 'appointment-time';
            time.textContent = `${startTime}-${endTime}`;
            
            block.appendChild(info);
            block.appendChild(time);
            
            // æ·»åŠ åˆ°å°æ‡‰çš„æ—¥æœŸå–®å…ƒæ ¼
            const dayIndex = start.getDay() === 0 ? 6 : start.getDay() - 1; // èª¿æ•´é€±æ—¥ç´¢å¼•
            if (dateCells[dayIndex]) {
                dateCells[dayIndex].appendChild(block);
            }
        }
        
        // æ¸²æŸ“åœ–ä¾‹
        function renderLegend() {
            const legend = document.getElementById('schedule-legend');
            legend.innerHTML = '';
            
            const legendItems = [
                { color: 'linear-gradient(135deg, #3498db, #2980b9)', text: 'å·²æ‰¹å‡†' },
                { color: 'linear-gradient(135deg, #f39c12, #e67e22)', text: 'å¾…å¯©æ ¸' }
            ];
            
            legendItems.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.background = item.color;
                
                const text = document.createElement('span');
                text.textContent = item.text;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(text);
                legend.appendChild(legendItem);
            });
        }
        
        // æ¸²æŸ“æ­¸é‚„åˆ—è¡¨
        function renderReturnList() {
            const returnList = document.getElementById('return-list');
            returnList.innerHTML = '';
            
            // éæ¿¾å‡ºå·²æ‰¹å‡†ä½†æœªæ­¸é‚„çš„é ç´„
            const approvedAppointments = appointments.filter(app => 
                app.status === 'approved'
            );
            
            if (approvedAppointments.length === 0) {
                returnList.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">æš«ç„¡éœ€è¦æ­¸é‚„çš„è¨­å‚™</p>';
                return;
            }
            
            approvedAppointments.forEach(appointment => {
                const returnItem = document.createElement('div');
                returnItem.className = 'return-item';
                
                const header = document.createElement('div');
                header.className = 'return-item-header';
                
                const name = document.createElement('div');
                name.textContent = appointment.applicant;
                name.style.fontWeight = 'bold';
                
                const count = document.createElement('div');
                count.textContent = `${appointment.ipadCount} å°iPad`;
                count.style.color = '#3498db';
                
                header.appendChild(name);
                header.appendChild(count);
                
                const details = document.createElement('div');
                details.className = 'return-item-details';
                
                const start = new Date(appointment.startTime);
                const end = new Date(appointment.endTime);
                details.textContent = `å€Ÿç”¨æ™‚é–“: ${formatDate(start)} ${formatTime(start)} - ${formatTime(end)}`;
                
                const actions = document.createElement('div');
                actions.className = 'return-actions';
                
                const returnBtn = document.createElement('button');
                returnBtn.className = 'btn-warning';
                returnBtn.textContent = 'æ­¸é‚„è¨­å‚™';
                returnBtn.addEventListener('click', () => showReturnModal(appointment));
                
                actions.appendChild(returnBtn);
                
                returnItem.appendChild(header);
                returnItem.appendChild(details);
                returnItem.appendChild(actions);
                
                returnList.appendChild(returnItem);
            });
        }
        
        // é¡¯ç¤ºæ­¸é‚„æ¨¡æ…‹æ¡†
        function showReturnModal(appointment) {
            const modal = document.getElementById('return-modal');
            const content = document.getElementById('return-modal-content');
            
            content.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">ç”³è«‹äºº</div>
                        <div class="detail-value">${appointment.applicant}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¯ç¹«é›»è©±</div>
                        <div class="detail-value">${appointment.applicantPhone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">iPadæ•¸é‡</div>
                        <div class="detail-value">${appointment.ipadCount} å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å€Ÿç”¨æ™‚é–“</div>
                        <div class="detail-value">${formatDateTime(new Date(appointment.startTime))} - ${formatTime(new Date(appointment.endTime))}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä½¿ç”¨ç›®çš„</div>
                        <div class="detail-value">${appointment.purpose || 'æœªå¡«å¯«'}</div>
                    </div>
                </div>
                
                <div class="return-check-options">
                    <div class="check-option">
                        <input type="checkbox" id="check-device-count">
                        <label for="check-device-count">è¨­å‚™æ•¸é‡æ­£ç¢º</label>
                    </div>
                    <div class="check-option">
                        <input type="checkbox" id="check-device-condition">
                        <label for="check-device-condition">è¨­å‚™ç‹€æ³è‰¯å¥½</label>
                    </div>
                    <div class="check-option">
                        <input type="checkbox" id="check-accessories">
                        <label for="check-accessories">é…ä»¶é½Šå…¨</label>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn-secondary" id="cancel-return">å–æ¶ˆ</button>
                    <button class="btn-success" id="confirm-return">ç¢ºèªæ­¸é‚„</button>
                </div>
            `;
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById('cancel-return').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('confirm-return').addEventListener('click', () => {
                const deviceCountChecked = document.getElementById('check-device-count').checked;
                const deviceConditionChecked = document.getElementById('check-device-condition').checked;
                const accessoriesChecked = document.getElementById('check-accessories').checked;
                
                if (!deviceCountChecked || !deviceConditionChecked || !accessoriesChecked) {
                    alert('è«‹ç¢ºèªæ‰€æœ‰æª¢æŸ¥é …å·²å®Œæˆ');
                    return;
                }
                
                updateAppointmentStatus(appointment.id, 'returned');
                modal.style.display = 'none';
            });
            
            modal.style.display = 'flex';
        }
        
        // é¡¯ç¤ºé ç´„è©³æƒ…æ¨¡æ…‹æ¡†
        function showAppointmentDetail(appointment) {
            const modal = document.getElementById('appointment-detail-modal');
            const content = document.getElementById('appointment-detail-content');
            
            const start = new Date(appointment.startTime);
            const end = new Date(appointment.endTime);
            
            let statusText = '';
            switch (appointment.status) {
                case 'pending':
                    statusText = 'å¾…å¯©æ ¸';
                    break;
                case 'approved':
                    statusText = 'å·²æ‰¹å‡†';
                    break;
                case 'rejected':
                    statusText = 'å·²é§å›';
                    break;
                case 'returned':
                    statusText = 'å·²æ­¸é‚„';
                    break;
            }
            
            content.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">ç”³è«‹äºº</div>
                        <div class="detail-value">${appointment.applicant}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¯ç¹«é›»è©±</div>
                        <div class="detail-value">${appointment.applicantPhone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">iPadæ•¸é‡</div>
                        <div class="detail-value">${appointment.ipadCount} å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å€Ÿç”¨æ™‚é–“</div>
                        <div class="detail-value">${formatDateTime(start)} - ${formatDateTime(end)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä½¿ç”¨ç›®çš„</div>
                        <div class="detail-value">${appointment.purpose || 'æœªå¡«å¯«'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ç‹€æ…‹</div>
                        <div class="detail-value">${statusText}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ™‚é–“</div>
                        <div class="detail-value">${formatDateTime(new Date(appointment.createTime))}</div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn-secondary" id="close-detail-modal">é—œé–‰</button>
                    <button class="btn-print" id="print-appointment">æ‰“å°æ†‘è­‰</button>
                </div>
            `;
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById('close-detail-modal').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('print-appointment').addEventListener('click', () => {
                printAppointment(appointment);
            });
            
            modal.style.display = 'flex';
        }
        
        // é¡¯ç¤ºé§å›æ¨¡æ…‹æ¡†
        function showRejectModal(appointmentId) {
            const modal = document.getElementById('reject-modal');
            const content = document.getElementById('reject-modal-content');
            
            content.innerHTML = `
                <div class="form-group">
                    <label for="reject-reason">é§å›åŸå› </label>
                    <textarea id="reject-reason" rows="3" placeholder="è«‹ç°¡è¦èªªæ˜é§å›åŸå› "></textarea>
                </div>
                
                <div class="buttons">
                    <button class="btn-secondary" id="cancel-reject">å–æ¶ˆ</button>
                    <button class="btn-danger" id="confirm-reject">ç¢ºèªé§å›</button>
                </div>
            `;
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById('cancel-reject').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('confirm-reject').addEventListener('click', () => {
                const reason = document.getElementById('reject-reason').value;
                if (!reason.trim()) {
                    alert('è«‹å¡«å¯«é§å›åŸå› ');
                    return;
                }
                
                updateAppointmentStatus(appointmentId, 'rejected', reason);
                modal.style.display = 'none';
            });
            
            modal.style.display = 'flex';
        }
        
        // æ›´æ–°é ç´„ç‹€æ…‹
        function updateAppointmentStatus(appointmentId, status, reason = '') {
            showLoading();
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'updateAppointmentStatus',
                    id: appointmentId,
                    status: status,
                    reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    // æ›´æ–°æœ¬åœ°æ•¸æ“š
                    const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
                    if (appointmentIndex !== -1) {
                        appointments[appointmentIndex].status = status;
                        if (reason) {
                            appointments[appointmentIndex].rejectReason = reason;
                        }
                    }
                    
                    // åˆ·æ–°é¡¯ç¤º
                    if (document.getElementById('admin-page').classList.contains('active')) {
                        renderAppointmentsTable();
                    }
                    
                    if (document.getElementById('schedule-page').classList.contains('active')) {
                        renderSchedule();
                    }
                    
                    if (document.getElementById('return-page').classList.contains('active')) {
                        renderReturnList();
                    }
                    
                    alert('æ“ä½œæˆåŠŸ');
                } else {
                    alert('æ“ä½œå¤±æ•—: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
            });
        }
        
        // æ‰“å°é ç´„æ†‘è­‰
        function printAppointment(appointment) {
            const printContainer = document.getElementById('print-container');
            const printDetails = document.getElementById('print-details');
            const printTime = document.getElementById('print-time');
            
            const start = new Date(appointment.startTime);
            const end = new Date(appointment.endTime);
            
            let statusText = '';
            switch (appointment.status) {
                case 'pending':
                    statusText = 'å¾…å¯©æ ¸';
                    break;
                case 'approved':
                    statusText = 'å·²æ‰¹å‡†';
                    break;
                case 'rejected':
                    statusText = 'å·²é§å›';
                    break;
                case 'returned':
                    statusText = 'å·²æ­¸é‚„';
                    break;
            }
            
            printDetails.innerHTML = `
                <div class="print-detail-item">
                    <div class="print-label">ç”³è«‹äºº</div>
                    <div class="print-value">${appointment.applicant}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">è¯ç¹«é›»è©±</div>
                    <div class="print-value">${appointment.applicantPhone}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">iPadæ•¸é‡</div>
                    <div class="print-value">${appointment.ipadCount} å°</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">å€Ÿç”¨æ™‚é–“</div>
                    <div class="print-value">${formatDateTime(start)} - ${formatDateTime(end)}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">ä½¿ç”¨ç›®çš„</div>
                    <div class="print-value">${appointment.purpose || 'æœªå¡«å¯«'}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">ç‹€æ…‹</div>
                    <div class="print-value">${statusText}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">é ç´„æ™‚é–“</div>
                    <div class="print-value">${formatDateTime(new Date(appointment.createTime))}</div>
                </div>
            `;
            
            printTime.textContent = formatDateTime(new Date());
            
            // é¡¯ç¤ºæ‰“å°å®¹å™¨ä¸¦æ‰“å°
            printContainer.style.display = 'block';
            window.print();
            printContainer.style.display = 'none';
        }
        
        // è™•ç†ç®¡ç†å“¡ç™»å…¥
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // ç°¡å–®çš„é©—è­‰ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼‰
            if (username === 'admin' && password === adminPassword) {
                isAdminLoggedIn = true;
                localStorage.setItem('adminLoggedIn', 'true');
                updateLastActivityTime();
                startLogoutTimer();
                
                showPage('admin-page');
                loadAppointments();
                
                // ç”ŸæˆäºŒç¶­ç¢¼
                generateQRCode();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }
        
        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(tabId) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„æ´»å‹•ç‹€æ…‹
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // è¨­ç½®é¸ä¸­çš„æ¨™ç±¤ç‚ºæ´»å‹•ç‹€æ…‹
            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            
            // å¦‚æœæ˜¯äºŒç¶­ç¢¼æ¨™ç±¤ï¼Œç”ŸæˆäºŒç¶­ç¢¼
            if (tabId === 'qrcode') {
                generateQRCode();
            }
        }
        
        // ç”ŸæˆäºŒç¶­ç¢¼
        function generateQRCode() {
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            // ç²å–ç•¶å‰é é¢çš„URL
            const url = window.location.href;
            
            // ç”ŸæˆäºŒç¶­ç¢¼
            QRCode.toCanvas(url, { width: 200 }, function(err, canvas) {
                if (err) {
                    console.error(err);
                    qrcodeContainer.innerHTML = '<p>ç”ŸæˆäºŒç¶­ç¢¼å¤±æ•—</p>';
                    return;
                }
                qrcodeContainer.appendChild(canvas);
            });
        }
        
        // ä¿å­˜ç³»çµ±è¨­å®š
        function saveSettings() {
            systemSettings.advanceDays = parseInt(document.getElementById('advance-days').value);
            systemSettings.adminPhone = document.getElementById('admin-phone').value;
            
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            alert('è¨­å®šå·²ä¿å­˜');
        }
        
        // åŠ è¼‰ç³»çµ±è¨­å®š
        function loadSettings() {
            const savedSettings = localStorage.getItem('systemSettings');
            if (savedSettings) {
                systemSettings = JSON.parse(savedSettings);
            }
            
            // æ›´æ–°è¡¨å–®
            document.getElementById('advance-days').value = systemSettings.advanceDays;
            document.getElementById('admin-phone').value = systemSettings.adminPhone;
        }
        
        // ä¿®æ”¹å¯†ç¢¼
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (currentPassword !== adminPassword) {
                alert('ç•¶å‰å¯†ç¢¼ä¸æ­£ç¢º');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('æ–°å¯†ç¢¼é•·åº¦ä¸èƒ½å°‘æ–¼6ä½');
                return;
            }
            
            adminPassword = newPassword;
            localStorage.setItem('adminPassword', newPassword);
            
            alert('å¯†ç¢¼ä¿®æ”¹æˆåŠŸ');
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }
        
        // æ¸…ç©ºæ‰€æœ‰é ç´„è¨˜éŒ„
        function clearAllAppointments() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é ç´„è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼')) {
                return;
            }
            
            showLoading();
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'clearAllAppointments'
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    appointments = [];
                    renderAppointmentsTable();
                    renderSchedule();
                    alert('æ‰€æœ‰é ç´„è¨˜éŒ„å·²æ¸…ç©º');
                } else {
                    alert('æ¸…ç©ºå¤±æ•—: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('æ¸…ç©ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
            });
        }
        
        // é¡¯ç¤ºé é¢
        function showPage(pageId) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // é¡¯ç¤ºç›®æ¨™é é¢
            document.getElementById(pageId).classList.add('active');
            
            // æ›´æ–°æœ€å¾Œæ´»å‹•æ™‚é–“
            updateLastActivityTime();
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ (YYYY-MM-DD)
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        // æ ¼å¼åŒ–æ™‚é–“ (HH:MM)
        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        function formatDateTime(date) {
            return `${formatDate(date)} ${formatTime(date)}`;
        }
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', init);
        
        // ç›£è½ç”¨æˆ¶æ´»å‹•ï¼Œæ›´æ–°æœ€å¾Œæ´»å‹•æ™‚é–“
        document.addEventListener('mousemove', updateLastActivityTime);
        document.addEventListener('keypress', updateLastActivityTime);
        document.addEventListener('click', updateLastActivityTime);
    </script>
</body>
</html>
