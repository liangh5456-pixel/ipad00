<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPadè¨­å‚™é ç´„ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* ä¿æŒåŸæœ‰çš„æ‰€æœ‰CSSæ ·å¼ä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        /* ... ä¿æŒæ‰€æœ‰CSSæ ·å¼ä¸å˜ ... */
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- ä¿æŒåŸæœ‰çš„HTMLç»“æ„ä¸å˜ -->
    <div class="container">
        <header>
            <h1>iPadè¨­å‚™é ç´„ç³»çµ±</h1>
            <div class="subtitle">ä¾¿æ·é ç´„ï¼Œé«˜æ•ˆç®¡ç†</div>
            <a href="#" id="admin-link" class="admin-link">ç®¡ç†å“¡</a>
        </header>
        
        <div class="content">
            <!-- é¦–é  -->
            <div id="home-page" class="page active">
                <h2>æ­¡è¿ä½¿ç”¨iPadé ç´„ç³»çµ±</h2>
                <div class="home-buttons">
                    <div class="home-btn appointment-btn" id="go-to-appointment">
                        <i>ğŸ“±</i>
                        <span>è¨­å‚™é ç´„</span>
                    </div>
                    <div class="home-btn view-schedule-btn" id="go-to-schedule">
                        <i>ğŸ“…</i>
                        <span>å·²é ç´„æ™‚æ®µ</span>
                    </div>
                    <div class="home-btn return-btn" id="go-to-return">
                        <i>ğŸ“‹</i>
                        <span>æ­¸é‚„ç™»è¨˜</span>
                    </div>
                </div>
                <div class="description">
                    <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹é ç´„iPadè¨­å‚™æˆ–æŸ¥çœ‹å·²é ç´„æ™‚æ®µ</p>
                    <p>è«‹æå‰è¦åŠƒä½¿ç”¨æ™‚é–“ï¼ŒæŒ‰æ™‚æ­¸é‚„è¨­å‚™</p>
                </div>
            </div>
            
            <!-- é ç´„é é¢ -->
            <div id="appointment-page" class="page">
                <h2>iPadè¨­å‚™é ç´„</h2>
                <div class="success-message" id="success-message">
                    é ç´„æˆåŠŸï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ç”³è«‹ã€‚
                </div>
                <form id="appointment-form">
                    <div class="form-group">
                        <label for="applicant">ç”³è«‹äºº</label>
                        <input type="text" id="applicant" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="applicant-phone">è¯ç¹«é›»è©±</label>
                        <input type="tel" id="applicant-phone" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼" pattern="[0-9]{11}" maxlength="11" required>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">è«‹è¼¸å…¥11ä½æ‰‹æ©Ÿè™Ÿç¢¼</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ipad-count">ç”³è«‹iPadæ•¸é‡ (1-48å°)</label>
                        <select id="ipad-count" required>
                            <option value="">è«‹é¸æ“‡æ•¸é‡</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="purpose">ä½¿ç”¨ç›®çš„</label>
                        <textarea id="purpose" rows="3" placeholder="è«‹ç°¡è¦èªªæ˜ä½¿ç”¨iPadçš„ç›®çš„"></textarea>
                    </div>
                    
                    <div class="time-selector">
                        <div class="time-header">é¸æ“‡é ç´„æ™‚æ®µ</div>
                        
                        <div class="time-inputs">
                            <div class="time-input-group">
                                <label for="start-date">é–‹å§‹æ—¥æœŸ</label>
                                <input type="date" id="start-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="start-time">é–‹å§‹æ™‚é–“</label>
                                <select id="start-time" required>
                                    <option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>
                                </select>
                            </div>
                            <div class="time-input-group">
                                <label for="end-date">çµæŸæ—¥æœŸ</label>
                                <input type="date" id="end-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="end-time">çµæŸæ™‚é–“</label>
                                <select id="end-time" required>
                                    <option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="selected-time" id="selected-time">
                            æœªé¸æ“‡æ™‚é–“æ®µ
                        </div>
                        
                        <div class="conflict-warning" id="conflict-warning">
                        </div>
                        
                        <div class="advance-warning" id="advance-warning">
                        </div>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary" id="submit-btn">æäº¤é ç´„</button>
                    </div>
                </form>
            </div>
            
            <!-- å·²é ç´„æ™‚æ®µé é¢ -->
            <div id="schedule-page" class="page">
                <div class="schedule-header">
                    <h2>å·²é ç´„æ™‚æ®µ</h2>
                    <div class="week-nav">
                        <div class="nav-btn" id="prev-week">â†</div>
                        <div class="week-title" id="week-title">æœ¬é€±é ç´„æƒ…æ³</div>
                        <div class="nav-btn" id="next-week">â†’</div>
                    </div>
                </div>
                
                <div class="time-schedule">
                    <div class="time-header-row" id="schedule-header">
                    </div>
                    <div class="time-slots-container" id="time-slots-container">
                    </div>
                </div>
                
                <div class="legend" id="schedule-legend">
                </div>
                
                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-schedule">è¿”å›é¦–é </button>
                </div>
            </div>
            
            <!-- æ­¸é‚„ç™»è¨˜é é¢ -->
            <div id="return-page" class="page">
                <h2>è¨­å‚™æ­¸é‚„ç™»è¨˜</h2>
                <div class="return-list" id="return-list">
                </div>
                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-return">è¿”å›é¦–é </button>
                </div>
            </div>
            
            <!-- ç™»å…¥é é¢ -->
            <div id="login-page" class="page">
                <h2>ç®¡ç†å“¡ç™»å…¥</h2>
                <form id="login-form" class="login-form">
                    <div class="form-group">
                        <label for="username">å¸³è™Ÿ</label>
                        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">å¯†ç¢¼</label>
                        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    
                    <div class="login-error" id="login-error">
                        å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home-from-login">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary">ç™»å…¥</button>
                    </div>
                </form>
            </div>
            
            <!-- å¾Œå°ç®¡ç†é é¢ -->
            <div id="admin-page" class="page">
                <h2>é ç´„ç®¡ç†å¾Œå°</h2>
                
                <div class="nav-tabs">
                    <div class="nav-tab active" data-tab="appointments">é ç´„è¨˜éŒ„</div>
                    <div class="nav-tab" data-tab="settings">ç³»çµ±è¨­å®š</div>
                    <div class="nav-tab" data-tab="password">ä¿®æ”¹å¯†ç¢¼</div>
                    <div class="nav-tab" data-tab="qrcode">é ç´„äºŒç¶­ç¢¼</div>
                </div>
                
                <div class="tab-content active" id="appointments-tab">
                    <div class="admin-controls">
                        <button class="btn-primary" id="refresh-appointments">åˆ·æ–°æ•¸æ“š</button>
                        <button class="btn-secondary" id="back-to-home-admin">è¿”å›é¦–é </button>
                    </div>
                    
                    <table id="appointments-table">
                        <thead>
                            <tr>
                                <th>ç”³è«‹äºº</th>
                                <th>è¯ç¹«é›»è©±</th>
                                <th>iPadæ•¸é‡</th>
                                <th>å€Ÿç”¨æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-content" id="settings-tab">
                    <div class="settings-group">
                        <h3>é ç´„è¨­å®š</h3>
                        <div class="setting-item">
                            <label for="advance-days">æå‰é ç´„å¤©æ•¸</label>
                            <input type="number" id="advance-days" min="1" max="30" value="3">
                        </div>
                        <div class="setting-description">
                            è¨­ç½®ç”¨æˆ¶å¿…é ˆæå‰å¤šå°‘å¤©é€²è¡Œé ç´„ã€‚ä¾‹å¦‚ï¼šè¨­ç½®ç‚º3ï¼Œå‰‡ç”¨æˆ¶åªèƒ½é ç´„3å¤©å¾Œçš„æ—¥æœŸã€‚
                        </div>
                        
                        <div class="setting-item">
                            <label for="admin-phone">ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼</label>
                            <input type="tel" id="admin-phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
                        </div>
                        <div class="setting-description">
                            è¨­ç½®ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œç”¨æ–¼æ¥æ”¶æ–°é ç´„é€šçŸ¥ã€‚
                        </div>
                        
                        <div class="buttons" style="margin-top: 15px;">
                            <button class="btn-primary" id="save-settings">ä¿å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="password-tab">
                    <div class="settings-group">
                        <h3>ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
                        <div class="form-group">
                            <label for="current-password">ç•¶å‰å¯†ç¢¼</label>
                            <input type="password" id="current-password" placeholder="è«‹è¼¸å…¥ç•¶å‰å¯†ç¢¼" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password">æ–°å¯†ç¢¼</label>
                            <input type="password" id="new-password" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm-password" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        
                        <div class="buttons" style="margin-top: 15px;">
                            <button class="btn-primary" id="change-password">ä¿®æ”¹å¯†ç¢¼</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="qrcode-tab">
                    <div class="qrcode-container">
                        <h3>æƒæäºŒç¶­ç¢¼é€²è¡Œé ç´„</h3>
                        <div id="qrcode"></div>
                        <p>ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸Šæ–¹äºŒç¶­ç¢¼</p>
                        <button class="btn-secondary" id="back-from-qrcode" style="margin-top: 15px;">è¿”å›ç®¡ç†</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ­¸é‚„ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="return-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">è¨­å‚™æ­¸é‚„ç¢ºèª</div>
                <button class="close-modal" id="close-return-modal">Ã—</button>
            </div>
            <div id="return-modal-content">
            </div>
        </div>
    </div>

    <!-- é ç´„è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="appointment-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">é ç´„è©³æƒ…</div>
                <button class="close-modal" id="close-appointment-detail-modal">Ã—</button>
            </div>
            <div id="appointment-detail-content">
            </div>
        </div>
    </div>

    <!-- é§å›ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="reject-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">é§å›é ç´„ç”³è«‹</div>
                <button class="close-modal" id="close-reject-modal">Ã—</button>
            </div>
            <div id="reject-modal-content">
            </div>
        </div>
    </div>

    <!-- æ‰“å°å°ˆç”¨å®¹å™¨ -->
    <div class="print-container" id="print-container">
        <div class="print-header">
            <h1>iPadè¨­å‚™é ç´„è©³æƒ…</h1>
            <p>é ç´„ç³»çµ±æ‰“å°æ†‘è­‰</p>
        </div>
        <div class="print-details" id="print-details">
        </div>
        <div class="print-footer">
            <p>æ‰“å°æ™‚é–“: <span id="print-time"></span></p>
            <p>è«‹å¦¥å–„ä¿ç®¡æ­¤æ†‘è­‰</p>
        </div>
    </div>

    <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading"></div>
        <span>æ­£åœ¨åŠ è¼‰æ•¸æ“š...</span>
    </div>

    <script>
        // ç§»é™¤GitHubé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨
        const USE_LOCAL_STORAGE = true;
        
        // ç³»ç»Ÿè®¾ç½®
        let systemSettings = {
            enableApproval: false,
            advanceDays: 3,
            adminPhone: ""
        };
        
        // ç®¡ç†å‘˜å¯†ç 
        let adminPassword = 'ipadadmin';
        
        // å½“å‰æŸ¥çœ‹çš„å‘¨æ¬¡
        let currentWeekOffset = 0;
        let isAdminLoggedIn = false;
        
        // é¢„çº¦æ•°æ®
        let appointments = [];
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadFromLocalStorage() {
            try {
                const savedAppointments = localStorage.getItem('ipadAppointments');
                const savedSettings = localStorage.getItem('ipadSystemSettings');
                const savedPassword = localStorage.getItem('adminPassword');
                
                if (savedAppointments) {
                    appointments = JSON.parse(savedAppointments);
                }
                
                if (savedSettings) {
                    systemSettings = JSON.parse(savedSettings);
                    updateSettingsForm();
                }
                
                if (savedPassword) {
                    adminPassword = savedPassword;
                }
                
                console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            try {
                localStorage.setItem('ipadAppointments', JSON.stringify(appointments));
                localStorage.setItem('ipadSystemSettings', JSON.stringify(systemSettings));
                localStorage.setItem('adminPassword', adminPassword);
                console.log('æ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ›´æ–°ç³»ç»Ÿè®¾ç½®è¡¨å•
        function updateSettingsForm() {
            if (document.getElementById('advance-days')) {
                document.getElementById('advance-days').value = systemSettings.advanceDays;
            }
            if (document.getElementById('admin-phone')) {
                document.getElementById('admin-phone').value = systemSettings.adminPhone || '';
            }
        }
        
        // é¡µé¢åˆ‡æ¢å‡½æ•°
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(pageId).classList.add('active');
        }
        
        // æ›´æ–°æ—¥æœŸè¾“å…¥çš„æœ€å°å€¼
        function updateDateInputMin() {
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + systemSettings.advanceDays);
            
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            if (startDateInput) {
                startDateInput.min = minDate.toISOString().split('T')[0];
            }
            if (endDateInput) {
                endDateInput.min = minDate.toISOString().split('T')[0];
            }
        }
        
        // æ›´æ–°é€‰æ‹©çš„æ—¶é—´æ˜¾ç¤º
        function updateSelectedTimeDisplay() {
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            
            if (startDate && startTime && endDate && endTime) {
                document.getElementById('selected-time').textContent = 
                    `${startDate} ${startTime} - ${endDate} ${endTime}`;
            } else {
                document.getElementById('selected-time').textContent = 'æœªé¸æ“‡æ™‚é–“æ®µ';
            }
        }
        
        // æ£€æŸ¥æ—¶é—´å†²çª
        function checkTimeConflict(newAppointment) {
            const newStart = new Date(`${newAppointment.startDate} ${newAppointment.startTime}`);
            const newEnd = new Date(`${newAppointment.endDate} ${newAppointment.endTime}`);
            
            for (const appointment of appointments) {
                if (appointment.status === 'rejected' || appointment.status === 'returned') {
                    continue;
                }
                
                const existingStart = new Date(`${appointment.startDate} ${appointment.startTime}`);
                const existingEnd = new Date(`${appointment.endDate} ${appointment.endTime}`);
                
                // æ£€æŸ¥æ—¶é—´é‡å 
                if (newStart < existingEnd && newEnd > existingStart) {
                    return {
                        conflict: true,
                        withAppointment: appointment
                    };
                }
            }
            
            return { conflict: false };
        }
        
        // æäº¤é¢„çº¦è¡¨å•
        function handleAppointmentSubmit(e) {
            e.preventDefault();
            
            const applicant = document.getElementById('applicant').value;
            const applicantPhone = document.getElementById('applicant-phone').value;
            const ipadCount = document.getElementById('ipad-count').value;
            const purpose = document.getElementById('purpose').value;
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            
            // åˆ›å»ºé¢„çº¦å¯¹è±¡
            const newAppointment = {
                id: Date.now().toString(),
                applicant: applicant,
                applicantPhone: applicantPhone,
                ipadCount: parseInt(ipadCount),
                purpose: purpose,
                startDate: startDate,
                startTime: startTime,
                endDate: endDate,
                endTime: endTime,
                status: systemSettings.enableApproval ? 'pending' : 'approved',
                createdAt: new Date().toISOString()
            };
            
            // æ£€æŸ¥æ—¶é—´å†²çª
            const conflictCheck = checkTimeConflict(newAppointment);
            if (conflictCheck.conflict) {
                document.getElementById('conflict-warning').style.display = 'block';
                document.getElementById('conflict-warning').textContent = 
                    `æ™‚é–“è¡çªï¼šèˆ‡ ${conflictCheck.withAppointment.applicant} çš„é ç´„æ™‚é–“é‡ç–Š`;
                return;
            } else {
                document.getElementById('conflict-warning').style.display = 'none';
            }
            
            // æ·»åŠ é¢„çº¦
            appointments.push(newAppointment);
            saveToLocalStorage();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            document.getElementById('success-message').style.display = 'block';
            
            // é‡ç½®è¡¨å•
            document.getElementById('appointment-form').reset();
            document.getElementById('selected-time').textContent = 'æœªé¸æ“‡æ™‚é–“æ®µ';
            
            // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                document.getElementById('success-message').style.display = 'none';
            }, 3000);
        }
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            console.log('åˆå§‹åŒ–å¼€å§‹...');
            
            // ç”ŸæˆiPadæ•°é‡é€‰é¡¹
            const ipadCountSelect = document.getElementById('ipad-count');
            if (ipadCountSelect) {
                ipadCountSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ•¸é‡</option>';
                for (let i = 1; i <= 48; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}å°`;
                    ipadCountSelect.appendChild(option);
                }
            }
            
            // ç”Ÿæˆæ—¶é—´é€‰é¡¹
            const startTimeSelect = document.getElementById('start-time');
            const endTimeSelect = document.getElementById('end-time');
            
            if (startTimeSelect && endTimeSelect) {
                startTimeSelect.innerHTML = '<option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>';
                endTimeSelect.innerHTML = '<option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>';
                
                for (let hour = 8; hour <= 18; hour++) {
                    for (let minute of [0, 10, 20, 30, 40, 50]) {
                        if (hour === 18 && minute > 0) continue;
                        
                        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        
                        const startOption = document.createElement('option');
                        startOption.value = timeString;
                        startOption.textContent = timeString;
                        startTimeSelect.appendChild(startOption);
                        
                        const endOption = document.createElement('option');
                        endOption.value = timeString;
                        endOption.textContent = timeString;
                        endTimeSelect.appendChild(endOption);
                    }
                }
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            loadFromLocalStorage();
            
            // è®¾ç½®æ—¥æœŸæœ€å°å€¼
            updateDateInputMin();
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            console.log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
            
            // é¦–é¡µæŒ‰é’®
            document.getElementById('go-to-appointment').addEventListener('click', () => {
                showPage('appointment-page');
            });
            
            document.getElementById('go-to-schedule').addEventListener('click', () => {
                currentWeekOffset = 0;
                updateScheduleView();
                showPage('schedule-page');
            });
            
            document.getElementById('go-to-return').addEventListener('click', () => {
                if (!isAdminLoggedIn) {
                    showPage('login-page');
                } else {
                    updateReturnList();
                    showPage('return-page');
                }
            });
            
            // è¿”å›é¦–é¡µæŒ‰é’®
            document.getElementById('back-to-home').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-from-schedule').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-from-return').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-from-login').addEventListener('click', () => showPage('home-page'));
            document.getElementById('back-to-home-admin').addEventListener('click', () => showPage('home-page'));
            
            // ç®¡ç†å‘˜é“¾æ¥
            document.getElementById('admin-link').addEventListener('click', (e) => {
                e.preventDefault();
                if (isAdminLoggedIn) {
                    showPage('admin-page');
                    updateAppointmentsTable();
                } else {
                    showPage('login-page');
                }
            });
            
            // ç™»å½•è¡¨å•
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (username === 'admin' && password === adminPassword) {
                    isAdminLoggedIn = true;
                    document.getElementById('login-error').style.display = 'none';
                    showPage('admin-page');
                    updateAppointmentsTable();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            });
            
            // é¢„çº¦è¡¨å•
            document.getElementById('appointment-form').addEventListener('submit', handleAppointmentSubmit);
            
            // æ—¶é—´é€‰æ‹©å™¨äº‹ä»¶
            const timeInputs = ['start-date', 'start-time', 'end-date', 'end-time'];
            timeInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', updateSelectedTimeDisplay);
                }
            });
            
            // å‘¨å¯¼èˆª
            document.getElementById('prev-week').addEventListener('click', () => {
                currentWeekOffset--;
                updateScheduleView();
            });
            
            document.getElementById('next-week').addEventListener('click', () => {
                currentWeekOffset++;
                updateScheduleView();
            });
            
            // ç®¡ç†å‘˜æ ‡ç­¾é¡µ
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                    document.querySelectorAll('.nav-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºæ´»åŠ¨çŠ¶æ€
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // å¦‚æœæ˜¯äºŒç»´ç æ ‡ç­¾ï¼Œç”ŸæˆäºŒç»´ç 
                    if (tabId === 'qrcode') {
                        generateQRCode();
                    }
                });
            });
            
            // ä¿å­˜è®¾ç½®
            document.getElementById('save-settings').addEventListener('click', () => {
                systemSettings.advanceDays = parseInt(document.getElementById('advance-days').value);
                systemSettings.adminPhone = document.getElementById('admin-phone').value;
                
                saveToLocalStorage();
                updateDateInputMin();
                
                alert('è¨­å®šå·²ä¿å­˜');
            });
            
            // ä¿®æ”¹å¯†ç 
            document.getElementById('change-password').addEventListener('click', () => {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (currentPassword !== adminPassword) {
                    alert('ç•¶å‰å¯†ç¢¼ä¸æ­£ç¢º');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸åŒ¹é…');
                    return;
                }
                
                adminPassword = newPassword;
                saveToLocalStorage();
                
                alert('å¯†ç¢¼ä¿®æ”¹æˆåŠŸ');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            });
            
            // åˆ·æ–°é¢„çº¦åˆ—è¡¨
            document.getElementById('refresh-appointments').addEventListener('click', () => {
                updateAppointmentsTable();
            });
            
            console.log('äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }
        
        // æ›´æ–°é¢„çº¦è¡¨æ ¼
        function updateAppointmentsTable() {
            const tableBody = document.querySelector('#appointments-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            appointments.forEach(appointment => {
                const row = document.createElement('tr');
                
                // çŠ¶æ€æ ·å¼
                let statusClass = '';
                let statusText = '';
                switch (appointment.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = 'å¾…å¯©æ ¸';
                        break;
                    case 'approved':
                        statusClass = 'status-approved';
                        statusText = 'å·²æ‰¹å‡†';
                        break;
                    case 'rejected':
                        statusClass = 'status-rejected';
                        statusText = 'å·²é§å›';
                        break;
                    case 'returned':
                        statusClass = 'status-returned';
                        statusText = 'å·²æ­¸é‚„';
                        break;
                }
                
                row.innerHTML = `
                    <td>${appointment.applicant}</td>
                    <td>${appointment.applicantPhone}</td>
                    <td>${appointment.ipadCount}å°</td>
                    <td>${appointment.startDate} ${appointment.startTime} - ${appointment.endDate} ${appointment.endTime}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn-primary view-detail" data-id="${appointment.id}">è©³æƒ…</button>
                        ${appointment.status === 'pending' ? 
                            `<button class="btn-success approve-btn" data-id="${appointment.id}">æ‰¹å‡†</button>
                             <button class="btn-danger reject-btn" data-id="${appointment.id}">é§å›</button>` : ''}
                        ${appointment.status === 'approved' ? 
                            `<button class="btn-warning return-btn-admin" data-id="${appointment.id}">æ­¸é‚„</button>` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // æ·»åŠ è¯¦æƒ…æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.view-detail').forEach(btn => {
                btn.addEventListener('click', () => {
                    const appointmentId = btn.getAttribute('data-id');
                    showAppointmentDetail(appointmentId);
                });
            });
            
            // æ·»åŠ æ‰¹å‡†æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const appointmentId = btn.getAttribute('data-id');
                    approveAppointment(appointmentId);
                });
            });
            
            // æ·»åŠ é©³å›æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const appointmentId = btn.getAttribute('data-id');
                    showRejectModal(appointmentId);
                });
            });
            
            // æ·»åŠ å½’è¿˜æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.return-btn-admin').forEach(btn => {
                btn.addEventListener('click', () => {
                    const appointmentId = btn.getAttribute('data-id');
                    showReturnModal(appointmentId);
                });
            });
        }
        
        // æ˜¾ç¤ºé¢„çº¦è¯¦æƒ…
        function showAppointmentDetail(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (!appointment) return;
            
            const modalContent = document.getElementById('appointment-detail-content');
            modalContent.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">ç”³è«‹äºº</div>
                        <div class="detail-value">${appointment.applicant}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¯ç¹«é›»è©±</div>
                        <div class="detail-value">${appointment.applicantPhone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">iPadæ•¸é‡</div>
                        <div class="detail-value">${appointment.ipadCount}å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä½¿ç”¨ç›®çš„</div>
                        <div class="detail-value">${appointment.purpose || 'æœªå¡«å¯«'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ™‚é–“</div>
                        <div class="detail-value">${appointment.startDate} ${appointment.startTime} - ${appointment.endDate} ${appointment.endTime}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ç‹€æ…‹</div>
                        <div class="detail-value">
                            ${appointment.status === 'pending' ? 'å¾…å¯©æ ¸' : 
                              appointment.status === 'approved' ? 'å·²æ‰¹å‡†' : 
                              appointment.status === 'rejected' ? 'å·²é§å›' : 'å·²æ­¸é‚„'}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å‰µå»ºæ™‚é–“</div>
                        <div class="detail-value">${new Date(appointment.createdAt).toLocaleString()}</div>
                    </div>
                </div>
                <div class="buttons">
                    <button class="btn-secondary" id="close-detail-modal">é—œé–‰</button>
                    <button class="btn-print" id="print-appointment" data-id="${appointment.id}">æ‰“å°æ†‘è­‰</button>
                </div>
            `;
            
            document.getElementById('appointment-detail-modal').style.display = 'flex';
            
            // å…³é—­æŒ‰é’®äº‹ä»¶
            document.getElementById('close-detail-modal').addEventListener('click', () => {
                document.getElementById('appointment-detail-modal').style.display = 'none';
            });
            
            // æ‰“å°æŒ‰é’®äº‹ä»¶
            document.getElementById('print-appointment').addEventListener('click', () => {
                printAppointment(appointmentId);
            });
        }
        
        // æ‰¹å‡†é¢„çº¦
        function approveAppointment(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (appointment) {
                appointment.status = 'approved';
                saveToLocalStorage();
                updateAppointmentsTable();
                alert('é ç´„å·²æ‰¹å‡†');
            }
        }
        
        // æ˜¾ç¤ºé©³å›æ¨¡æ€æ¡†
        function showRejectModal(appointmentId) {
            const modalContent = document.getElementById('reject-modal-content');
            modalContent.innerHTML = `
                <p>ç¢ºå®šè¦é§å›æ­¤é ç´„ç”³è«‹å—ï¼Ÿ</p>
                <div class="buttons">
                    <button class="btn-secondary" id="cancel-reject">å–æ¶ˆ</button>
                    <button class="btn-danger" id="confirm-reject" data-id="${appointmentId}">ç¢ºèªé§å›</button>
                </div>
            `;
            
            document.getElementById('reject-modal').style.display = 'flex';
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-reject').addEventListener('click', () => {
                document.getElementById('reject-modal').style.display = 'none';
            });
            
            // ç¡®è®¤é©³å›æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-reject').addEventListener('click', () => {
                const id = document.getElementById('confirm-reject').getAttribute('data-id');
                rejectAppointment(id);
                document.getElementById('reject-modal').style.display = 'none';
            });
        }
        
        // é©³å›é¢„çº¦
        function rejectAppointment(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (appointment) {
                appointment.status = 'rejected';
                saveToLocalStorage();
                updateAppointmentsTable();
                alert('é ç´„å·²é§å›');
            }
        }
        
        // æ˜¾ç¤ºå½’è¿˜æ¨¡æ€æ¡†
        function showReturnModal(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (!appointment) return;
            
            const modalContent = document.getElementById('return-modal-content');
            modalContent.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">ç”³è«‹äºº</div>
                        <div class="detail-value">${appointment.applicant}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">iPadæ•¸é‡</div>
                        <div class="detail-value">${appointment.ipadCount}å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ™‚é–“</div>
                        <div class="detail-value">${appointment.startDate} ${appointment.startTime} - ${appointment.endDate} ${appointment.endTime}</div>
                    </div>
                </div>
                <div class="return-check-options">
                    <div class="check-option">
                        <input type="checkbox" id="check-device-count">
                        <label for="check-device-count">è¨­å‚™æ•¸é‡æ­£ç¢º</label>
                    </div>
                    <div class="check-option">
                        <input type="checkbox" id="check-device-condition">
                        <label for="check-device-condition">è¨­å‚™ç‹€æ³è‰¯å¥½</label>
                    </div>
                    <div class="check-option">
                        <input type="checkbox" id="check-accessories">
                        <label for="check-accessories">é…ä»¶é½Šå…¨</label>
                    </div>
                </div>
                <div class="buttons">
                    <button class="btn-secondary" id="cancel-return">å–æ¶ˆ</button>
                    <button class="btn-success" id="confirm-return" data-id="${appointmentId}">ç¢ºèªæ­¸é‚„</button>
                </div>
            `;
            
            document.getElementById('return-modal').style.display = 'flex';
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-return').addEventListener('click', () => {
                document.getElementById('return-modal').style.display = 'none';
            });
            
            // ç¡®è®¤å½’è¿˜æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-return').addEventListener('click', () => {
                const deviceCountChecked = document.getElementById('check-device-count').checked;
                const deviceConditionChecked = document.getElementById('check-device-condition').checked;
                const accessoriesChecked = document.getElementById('check-accessories').checked;
                
                if (!deviceCountChecked || !deviceConditionChecked || !accessoriesChecked) {
                    alert('è«‹ç¢ºèªæ‰€æœ‰æª¢æŸ¥é …ç›®éƒ½å·²å®Œæˆ');
                    return;
                }
                
                const id = document.getElementById('confirm-return').getAttribute('data-id');
                returnAppointment(id);
                document.getElementById('return-modal').style.display = 'none';
            });
        }
        
        // å½’è¿˜è®¾å¤‡
        function returnAppointment(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (appointment) {
                appointment.status = 'returned';
                appointment.returnedAt = new Date().toISOString();
                saveToLocalStorage();
                updateAppointmentsTable();
                updateReturnList();
                alert('è¨­å‚™æ­¸é‚„ç™»è¨˜å®Œæˆ');
            }
        }
        
        // æ‰“å°é¢„çº¦å‡­è¯
        function printAppointment(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (!appointment) return;
            
            const printDetails = document.getElementById('print-details');
            printDetails.innerHTML = `
                <div class="print-detail-item">
                    <div class="print-label">ç”³è«‹äºº</div>
                    <div class="print-value">${appointment.applicant}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">è¯ç¹«é›»è©±</div>
                    <div class="print-value">${appointment.applicantPhone}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">iPadæ•¸é‡</div>
                    <div class="print-value">${appointment.ipadCount}å°</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">ä½¿ç”¨ç›®çš„</div>
                    <div class="print-value">${appointment.purpose || 'æœªå¡«å¯«'}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">é ç´„æ™‚é–“</div>
                    <div class="print-value">${appointment.startDate} ${appointment.startTime} - ${appointment.endDate} ${appointment.endTime}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">ç‹€æ…‹</div>
                    <div class="print-value">
                        ${appointment.status === 'pending' ? 'å¾…å¯©æ ¸' : 
                          appointment.status === 'approved' ? 'å·²æ‰¹å‡†' : 
                          appointment.status === 'rejected' ? 'å·²é§å›' : 'å·²æ­¸é‚„'}
                    </div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">é ç´„ç·¨è™Ÿ</div>
                    <div class="print-value">${appointment.id}</div>
                </div>
            `;
            
            document.getElementById('print-time').textContent = new Date().toLocaleString();
            
            // æ˜¾ç¤ºæ‰“å°å®¹å™¨å¹¶æ‰“å°
            document.getElementById('print-container').style.display = 'block';
            window.print();
            document.getElementById('print-container').style.display = 'none';
        }
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            const qrcodeContainer = document.getElementById('qrcode');
            if (!qrcodeContainer) return;
            
            qrcodeContainer.innerHTML = '';
            
            // ç”Ÿæˆå½“å‰é¡µé¢çš„URLä½œä¸ºäºŒç»´ç å†…å®¹
            const url = window.location.href;
            QRCode.toCanvas(qrcodeContainer, url, function (error) {
                if (error) console.error(error);
            });
        }
        
        // æ›´æ–°é¢„çº¦è§†å›¾
        function updateScheduleView() {
            // ç®€åŒ–å®ç° - åœ¨å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥æ˜¾ç¤ºæ—¶é—´è¡¨
            const weekTitle = document.getElementById('week-title');
            if (weekTitle) {
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
                
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                
                weekTitle.textContent = 
                    `${startOfWeek.getFullYear()}/${startOfWeek.getMonth()+1}/${startOfWeek.getDate()} - ${endOfWeek.getFullYear()}/${endOfWeek.getMonth()+1}/${endOfWeek.getDate()}`;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ç”Ÿæˆæ—¶é—´è¡¨ç½‘æ ¼
            console.log('æ›´æ–°é¢„çº¦è§†å›¾');
        }
        
        // æ›´æ–°å½’è¿˜åˆ—è¡¨
        function updateReturnList() {
            const returnList = document.getElementById('return-list');
            if (!returnList) return;
            
            // åªæ˜¾ç¤ºå·²æ‰¹å‡†ä½†æœªå½’è¿˜çš„é¢„çº¦
            const pendingReturns = appointments.filter(a => a.status === 'approved');
            
            if (pendingReturns.length === 0) {
                returnList.innerHTML = '<p>æš«ç„¡å¾…æ­¸é‚„è¨­å‚™</p>';
                return;
            }
            
            returnList.innerHTML = '';
            
            pendingReturns.forEach(appointment => {
                const returnItem = document.createElement('div');
                returnItem.className = 'return-item';
                returnItem.innerHTML = `
                    <div class="return-item-header">
                        <strong>${appointment.applicant}</strong>
                        <span>${appointment.ipadCount}å° iPad</span>
                    </div>
                    <div class="return-item-details">
                        <div>é ç´„æ™‚é–“: ${appointment.startDate} ${appointment.startTime} - ${appointment.endDate} ${appointment.endTime}</div>
                        <div>è¯ç¹«é›»è©±: ${appointment.applicantPhone}</div>
                    </div>
                    <div class="return-actions">
                        <button class="btn-warning return-item-btn" data-id="${appointment.id}">æ­¸é‚„ç™»è¨˜</button>
                    </div>
                `;
                
                returnList.appendChild(returnItem);
            });
            
            // æ·»åŠ å½’è¿˜æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.return-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const appointmentId = btn.getAttribute('data-id');
                    showReturnModal(appointmentId);
                });
            });
        }
        
        // å…³é—­æ¨¡æ€æ¡†çš„äº‹ä»¶
        document.getElementById('close-return-modal').addEventListener('click', () => {
            document.getElementById('return-modal').style.display = 'none';
        });
        
        document.getElementById('close-appointment-detail-modal').addEventListener('click', () => {
            document.getElementById('appointment-detail-modal').style.display = 'none';
        });
        
        document.getElementById('close-reject-modal').addEventListener('click', () => {
            document.getElementById('reject-modal').style.display = 'none';
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆ');
            init();
            setupEventListeners();
        });
    </script>
</body>
</html>
