<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iPadè¨­å‚™é ç´„ç³»çµ±</title>

  <!-- QRCode lib (ç”¨äºç”ŸæˆäºŒç»´ç ) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Firebase compat SDKs: app, database, storage -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <style>
    /* ========== åŸºæœ¬æ ·å¼ï¼ˆä¿ç•™å’Œå…¼å®¹ä½ åŸæ¥çš„ UIï¼‰ ========== */
    *{box-sizing:border-box;margin:0;padding:0;font-family:'PingFang TC','Microsoft JhengHei',sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:15px}
    .container{width:100%;max-width:1000px;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden;margin-bottom:20px}
    header{background:linear-gradient(90deg,#3498db,#2c3e50);color:#fff;padding:15px;text-align:center;position:relative}
    h1{font-size:20px;margin-bottom:8px} .subtitle{font-size:12px;opacity:.9}
    .content{padding:20px}
    .page{display:none} .active{display:block}

    /* æŒ‰é’®å’Œè¡¨å• */
    .buttons{display:flex;justify-content:space-between;margin-top:15px;gap:10px}
    button{padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-size:14px}
    .btn-primary{background:#3498db;color:#fff} .btn-secondary{background:#e0e0e0} .btn-danger{background:#e74c3c;color:#fff}
    .btn-success{background:#27ae60;color:#fff} .btn-print{background:#7d3c98;color:#fff}

    .form-group{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#2c3e50}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    input:focus,select:focus,textarea:focus{border-color:#3498db;outline:none}

    .success-message{background:#d4edda;color:#155724;padding:10px;border-radius:6px;margin-bottom:10px;display:none}

    /* é¦–é¡µæŒ‰é’® */
    .home-buttons{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin:20px 0}
    .home-btn{width:140px;height:140px;border-radius:50%;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;cursor:pointer;box-shadow:0 8px 15px rgba(0,0,0,.15);text-align:center}
    .home-btn i{font-size:36px;margin-bottom:8px} .home-btn span{font-weight:700}
    .appointment-btn{background:linear-gradient(135deg,#3498db,#2c3e50)} .view-schedule-btn{background:linear-gradient(135deg,#2ecc71,#27ae60)} .return-btn{background:linear-gradient(135deg,#f39c12,#e67e22)}

    /* ç®¡ç†é¡µè¡¨æ ¼ */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    th{background:#f8f9fa;font-weight:700;color:#2c3e50}

    .status{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:700}
    .status-approved{background:#d1ecf1;color:#0c5460} .status-pending{background:#fff3cd;color:#856404}
    .status-rejected{background:#f8d7da;color:#721c24} .status-returned{background:#d4edda;color:#155724}

    /* æ¨¡æ€ */
    .modal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:2000}
    .modal-content{background:#fff;padding:18px;border-radius:8px;width:92%;max-width:520px;max-height:85vh;overflow:auto}
    .close-modal{background:none;border:none;font-size:20px;cursor:pointer;color:#7f8c8d}

    /* æ—¥å†æ ·å¼ï¼ˆå‘¨è§†å›¾ï¼‰ */
    .schedule-wrapper{border:1px solid #eaeef2;border-radius:6px;overflow:hidden}
    .week-header{display:grid;grid-template-columns:60px repeat(7,1fr);background:#f8f9fa}
    .week-header .time-label{padding:8px;border-right:1px solid #eaeef2;font-weight:700;text-align:center}
    .week-header .day-cell{padding:8px;text-align:center;border-left:1px solid #eaeef2;font-weight:700}
    /* grid å®¹å™¨ï¼šè‡ªåŠ¨è¡Œé«˜30px */
    .grid-container{position:relative;display:grid;grid-template-columns:60px repeat(7,1fr);grid-auto-rows:30px}
    .grid-time-cell{padding:6px;text-align:right;padding-right:10px;border-bottom:1px solid #f1f4f7;border-right:1px solid #eaeef2;font-size:12px;color:#666}
    .grid-day-cell{border-bottom:1px solid #f1f4f7;border-right:1px solid #eaeef2;position:relative}
    /* é¢„çº¦å—ä½¿ç”¨ grid-row / grid-column */
    .appointment-block{position:relative;border-radius:3px;padding:4px 6px;font-size:11px;color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.12);overflow:hidden}
    .appointment-info{font-weight:700;font-size:12px}
    .appointment-time{font-size:10px;opacity:.9}

    /* æ—¶é—´é€‰é¡¹ä¸å¯ç‚¹å‡»æ—¶æ˜¾ç¤ºç°è‰² */
    select option.disabled-opt { color:#999; background:#f3f3f3; }
    select option[disabled] { color:#999; }

    /* Return UI è°ƒæ•´ */
    .return-item{padding:12px;border:1px solid #e6eaee;border-radius:6px;margin-bottom:10px;background:#fbfcfd}
    .return-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .return-item-details{font-size:13px;color:#666;margin-bottom:8px}
    .return-actions{display:flex;gap:8px}
    .return-photos-container{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{width:80px;height:80px;border-radius:6px;object-fit:cover;border:1px solid #ddd}

    /* æ¸…ç©ºç¡®è®¤å¼¹çª— */
    .confirm-clear { display:flex;flex-direction:column;gap:10px }

    @media (max-width:720px){
      .home-buttons{gap:12px}
      .home-btn{width:120px;height:120px}
      .grid-container{grid-auto-rows:28px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>iPadè¨­å‚™é ç´„ç³»çµ±ï¼ˆFirebaseï¼‰</h1>
      <div class="subtitle">ä¾¿æ·é ç´„ï¼Œé«˜æ•ˆç®¡ç†</div>
      <a id="admin-link" href="#" style="position:absolute;right:16px;top:16px;color:#fff;text-decoration:none;font-weight:700">ç®¡ç†å“¡</a>
    </header>

    <div class="content">
      <!-- Home -->
      <div id="home-page" class="page active">
        <h2>æ­¡è¿ä½¿ç”¨ iPad é ç´„ç³»çµ±</h2>
        <div class="home-buttons">
          <div class="home-btn appointment-btn" id="go-to-appointment"><i>ğŸ“±</i><span>è¨­å‚™é ç´„</span></div>
          <div class="home-btn view-schedule-btn" id="go-to-schedule"><i>ğŸ“…</i><span>å·²é ç´„æ™‚æ®µ</span></div>
          <div class="home-btn return-btn" id="go-to-return"><i>ğŸ“‹</i><span>æ­¸é‚„ç™»è¨˜</span></div>
        </div>
        <div style="text-align:center;color:#7f8c8d">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹é ç´„æˆ–ç®¡ç†è¨­å‚™</div>
      </div>

      <!-- Appointment Page -->
      <div id="appointment-page" class="page">
        <h2>iPadè¨­å‚™é ç´„</h2>
        <div class="success-message" id="success-message">é ç´„å·²æäº¤ï¼ˆå¦‚å•Ÿç”¨å¯©æ ¸å‰‡ç­‰å¾…å¯©æ ¸ï¼‰</div>

        <form id="appointment-form">
          <div class="form-group">
            <label for="applicant">ç”³è«‹äºº</label>
            <input id="applicant" type="text" placeholder="è«‹è¼¸å…¥å§“å" required />
          </div>

          <div class="form-group">
            <label for="applicant-phone">è¯ç¹«é›»è©±</label>
            <input id="applicant-phone" type="tel" placeholder="11ä½æ‰‹æ©Ÿè™Ÿç¢¼" pattern="[0-9]{11}" maxlength="11" required />
          </div>

          <div class="form-group">
            <label for="ipad-count">ç”³è«‹ iPad æ•¸é‡</label>
            <select id="ipad-count" required><option value="">è«‹é¸æ“‡æ•¸é‡</option></select>
          </div>

          <div class="form-group">
            <label for="purpose">ä½¿ç”¨ç›®çš„</label>
            <textarea id="purpose" rows="3" placeholder="ç°¡è¦èªªæ˜ç”¨é€”"></textarea>
          </div>

          <div class="time-selector">
            <div class="form-group" style="display:flex;gap:12px;flex-wrap:wrap">
              <div style="flex:1;min-width:160px">
                <label for="start-date">é–‹å§‹æ—¥æœŸ</label>
                <input id="start-date" type="date" required />
              </div>
              <div style="flex:1;min-width:160px">
                <label for="start-time">é–‹å§‹æ™‚é–“</label>
                <select id="start-time" required><option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option></select>
              </div>
              <div style="flex:1;min-width:160px">
                <label for="end-date">çµæŸæ—¥æœŸ</label>
                <input id="end-date" type="date" required />
              </div>
              <div style="flex:1;min-width:160px">
                <label for="end-time">çµæŸæ™‚é–“</label>
                <select id="end-time" required><option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option></select>
              </div>
            </div>
            <div style="margin-top:10px;">
              <div id="selected-time" style="font-size:14px;color:#333">æœªé¸æ“‡æ™‚é–“æ®µ</div>
              <div id="conflict-warning" style="display:none;margin-top:6px;padding:8px;background:#f8d7da;color:#721c24;border-radius:6px"></div>
              <div id="advance-warning" style="display:none;margin-top:6px;padding:8px;background:#fff3cd;color:#856404;border-radius:6px"></div>
            </div>
          </div>

          <div class="buttons" style="margin-top:18px">
            <button type="button" id="back-to-home" class="btn-secondary">è¿”å›é¦–é </button>
            <button type="submit" id="submit-btn" class="btn-primary">æäº¤é ç´„</button>
          </div>
        </form>
      </div>

      <!-- Schedule Page (é€±è¦–åœ–) -->
      <div id="schedule-page" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2>å·²é ç´„æ™‚æ®µ</h2>
          <div style="display:flex;gap:10px;align-items:center">
            <button id="prev-week" class="btn-secondary">â†</button>
            <div id="week-title" style="font-weight:700"></div>
            <button id="next-week" class="btn-secondary">â†’</button>
            <button id="back-to-home-from-schedule" class="btn-secondary">è¿”å›é¦–é </button>
          </div>
        </div>

        <div class="schedule-wrapper">
          <div class="week-header" id="week-header"></div>
          <!-- grid å®¹å™¨ï¼šgrid-auto-rows:30px -->
          <div id="calendar-grid" class="grid-container" style="position:relative"></div>
        </div>
      </div>

      <!-- Return Page -->
      <div id="return-page" class="page">
        <h2>è¨­å‚™æ­¸é‚„ç™»è¨˜</h2>
        <div id="return-list" style="margin-top:12px"></div>
        <div style="margin-top:12px">
          <button id="back-to-home-from-return" class="btn-secondary">è¿”å›é¦–é </button>
        </div>
      </div>

      <!-- Login Page -->
      <div id="login-page" class="page">
        <h2>ç®¡ç†å“¡ç™»å…¥</h2>
        <form id="login-form" style="max-width:360px;margin:10px auto">
          <div class="form-group"><label for="username">å¸³è™Ÿ</label><input id="username" type="text" required placeholder="admin" /></div>
          <div class="form-group"><label for="password">å¯†ç¢¼</label><input id="password" type="password" required /></div>
          <div id="login-error" style="display:none;color:#e74c3c;margin-bottom:8px">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</div>
          <div class="buttons"><button type="button" id="back-to-home-from-login" class="btn-secondary">è¿”å›é¦–é </button><button type="submit" class="btn-primary">ç™»å…¥</button></div>
        </form>
      </div>

      <!-- Admin Page -->
      <div id="admin-page" class="page">
        <h2>é ç´„ç®¡ç†å¾Œå°</h2>
        <div class="nav-tabs" style="display:flex;gap:12px;border-bottom:1px solid #eaeef2;margin-bottom:12px">
          <div class="nav-tab active" data-tab="appointments">é ç´„è¨˜éŒ„</div>
          <div class="nav-tab" data-tab="settings">ç³»çµ±è¨­å®š</div>
          <div class="nav-tab" data-tab="password">ä¿®æ”¹å¯†ç¢¼</div>
          <div class="nav-tab" data-tab="qrcode">é ç´„äºŒç¶­ç¢¼</div>
        </div>

        <div id="appointments-tab" class="tab-content" style="display:block">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="display:flex;gap:8px">
              <button id="refresh-appointments" class="btn-primary">åˆ·æ–°æ•¸æ“š</button>
              <button id="clear-all-appointments" class="btn-danger">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</button>
            </div>
            <div><button id="back-to-home-admin" class="btn-secondary">è¿”å›é¦–é </button></div>
          </div>

          <table id="appointments-table">
            <thead><tr><th>ç”³è«‹äºº</th><th>è¯ç¹«é›»è©±</th><th>iPadæ•¸é‡</th><th>å€Ÿç”¨æ™‚é–“</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="settings-tab" class="tab-content" style="display:none;margin-top:10px">
          <div style="padding:12px;background:#f8f9fa;border-radius:8px">
            <h3>é ç´„è¨­å®š</h3>
            <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
              <label for="advance-days" style="min-width:160px">æå‰é ç´„å¤©æ•¸</label>
              <input id="advance-days" type="number" min="0" max="30" value="3" />
            </div>
            <div style="margin-bottom:6px;color:#7f8c8d">è¨­ç½®ç”¨æˆ¶å¿…é ˆæå‰å¤šå°‘å¤©é€²è¡Œé ç´„ï¼ˆ0 è¡¨ç¤ºç•¶æ—¥å¯é ç´„ï¼‰</div>

            <div style="display:flex;gap:12px;align-items:center;margin-top:10px">
              <label for="admin-phone" style="min-width:160px">ç®¡ç†å“¡æ‰‹æ©Ÿ</label>
              <input id="admin-phone" type="tel" placeholder="é¸å¡«" />
            </div>

            <div style="margin-top:12px"><button id="save-settings" class="btn-primary">ä¿å­˜è¨­å®š</button></div>
          </div>
        </div>

        <div id="password-tab" class="tab-content" style="display:none;margin-top:10px">
          <div style="padding:12px;background:#f8f9fa;border-radius:8px">
            <h3>ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
            <div class="form-group"><label for="current-password">ç•¶å‰å¯†ç¢¼</label><input id="current-password" type="password" /></div>
            <div class="form-group"><label for="new-password">æ–°å¯†ç¢¼</label><input id="new-password" type="password" /></div>
            <div class="form-group"><label for="confirm-password">ç¢ºèªæ–°å¯†ç¢¼</label><input id="confirm-password" type="password" /></div>
            <div><button id="change-password" class="btn-primary">ä¿®æ”¹å¯†ç¢¼</button></div>
          </div>
        </div>

        <div id="qrcode-tab" class="tab-content" style="display:none;margin-top:10px">
          <div style="padding:12px;background:#fff;border-radius:8px">
            <h3>æƒæäºŒç¶­ç¢¼é€²è¡Œé ç´„</h3>
            <div id="qrcode" style="margin-top:10px"></div>
            <div style="margin-top:10px"><button id="back-from-qrcode" class="btn-secondary">è¿”å›ç®¡ç†</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è¿”å›æ¨¡æ€ -->
  <div id="return-modal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>è¨­å‚™æ­¸é‚„ç¢ºèª</h3>
        <button class="close-modal" id="close-return-modal">Ã—</button>
      </div>
      <div id="return-modal-body"></div>
    </div>
  </div>

  <!-- é ç´„è©³æƒ…æ¨¡æ€ -->
  <div id="appointment-detail-modal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>é ç´„è©³æƒ…</h3>
        <button class="close-modal" id="close-appointment-detail-modal">Ã—</button>
      </div>
      <div id="appointment-detail-body"></div>
    </div>
  </div>

  <!-- é§å›æ¨¡æ€ -->
  <div id="reject-modal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>é§å›é ç´„ç”³è«‹</h3>
        <button class="close-modal" id="close-reject-modal">Ã—</button>
      </div>
      <div id="reject-modal-body"></div>
    </div>
  </div>

  <!-- æ¸…ç©ºç¡®è®¤å¯†ç æ¨¡æ€ -->
  <div id="clear-confirm-modal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <h3>è«‹è¼¸å…¥ç¢ºèªå¯†ç¢¼ä»¥æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</h3>
      <div class="confirm-clear" style="margin-top:12px">
        <input id="clear-confirm-input" type="password" placeholder="è«‹è¼¸å…¥ç¢ºèªå¯†ç¢¼" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="clear-confirm-cancel" class="btn-secondary">å–æ¶ˆ</button>
          <button id="clear-confirm-ok" class="btn-danger">ç¢ºèªæ¸…ç©º</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‰“å°å®¹å™¨ -->
  <div id="print-container" style="display:none">
    <div id="print-details"></div>
  </div>

<script>
/* ================== Firebase åˆå§‹åŒ–ï¼ˆä½¿ç”¨ä½ æä¾›çš„é…ç½®ï¼‰ ================== */
const firebaseConfig = {
  apiKey: "AIzaSyAyHaxW3X-ksmb7AZCeeGO2E2qoLjiCsB4",
  authDomain: "ipad-booking-e3a24.firebaseapp.com",
  databaseURL: "https://ipad-booking-e3a24-default-rtdb.firebaseio.com",
  projectId: "ipad-booking-e3a24",
  storageBucket: "ipad-booking-e3a24.firebasestorage.app",
  messagingSenderId: "245625966955",
  appId: "1:245625966955:web:fdd713996f51fe97d03c2e",
  measurementId: "G-2Y59M64G47"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();
const appointmentsRef = db.ref('appointments');
const settingsRef = db.ref('settings');

/* ================== æœ¬åœ°çŠ¶æ€ ================== */
let appointments = []; // ä»äº‘ç«¯åŒæ­¥
let systemSettings = { enableApproval:false, advanceDays:3, adminPhone:'' };
let adminPassword = 'ipadadmin'; // é»˜è®¤å¯†ç ï¼Œäº‘ç«¯ settings è¦†ç›–åä¼šä½¿ç”¨äº‘ç«¯å€¼
let isAdminLoggedIn = false;
let currentWeekOffset = 0;

/* ================== åˆå§‹åŒ– UI é€‰é¡¹ï¼ˆiPad æ•°é‡ã€æ—¶é—´ï¼‰ ================== */
function generateIpadCountOptions(){
  const sel = document.getElementById('ipad-count');
  sel.innerHTML = '<option value="">è«‹é¸æ“‡æ•¸é‡</option>';
  for (let i=1;i<=48;i++){
    const opt = document.createElement('option'); opt.value = i; opt.textContent = i + 'å°';
    sel.appendChild(opt);
  }
}
function generateTimeOptions(){
  const start = document.getElementById('start-time');
  const end = document.getElementById('end-time');
  start.innerHTML = '<option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>';
  end.innerHTML = '<option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>';
  for (let hour=8; hour<=18; hour++){
    for (let minute of [0,10,20,30,40,50]){
      if (hour===18 && minute>0) continue;
      const t = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
      const o1 = document.createElement('option'); o1.value=t; o1.textContent=t;
      const o2 = document.createElement('option'); o2.value=t; o2.textContent=t;
      start.appendChild(o1); end.appendChild(o2);
    }
  }
}
generateIpadCountOptions();
generateTimeOptions();

/* ================== ç›‘å¬ settingsï¼ˆå®æ—¶ï¼‰ ================== */
settingsRef.on('value', snap => {
  const data = snap.val();
  if (data) {
    systemSettings = Object.assign(systemSettings, data);
    if (data.adminPassword) adminPassword = data.adminPassword;
  } else {
    // å¦‚æœæ²¡æœ‰ settingsï¼Œå†™å…¥é»˜è®¤è®¾ç½®ï¼ˆç¡®ä¿ cloud æœ‰å€¼ï¼‰
    settingsRef.set(systemSettings).catch(()=>{});
  }
  // æ›´æ–°é¡µé¢ä¸Š advance-days / admin-phone æ§ä»¶ä¸ date min
  document.getElementById('advance-days').value = systemSettings.advanceDays || 0;
  document.getElementById('admin-phone').value = systemSettings.adminPhone || '';
  updateDateMinConstraints();
});

/* ================== ç›‘å¬ appointmentsï¼ˆå®æ—¶ï¼‰ ================== */
appointmentsRef.on('value', snap => {
  const data = snap.val();
  if (!data) appointments = [];
  else appointments = Object.keys(data).map(k => {
    const o = data[k]; o.id = o.id || k; return o;
  });
  updateAppointmentsTable();
  updateReturnList();
  updateScheduleView();
});

/* ================== å·¥å…·å‡½æ•° ================ */
function formatAppointmentTime(startTime, endTime){
  const s = new Date(startTime), e = new Date(endTime);
  const sdate = `${s.getMonth()+1}/${s.getDate()}`;
  const st = `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}`;
  const et = `${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`;
  return `${sdate} ${st}-${et}`;
}
function getRandomColor(){
  const colors = ['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c','#d35400','#34495e'];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* ================== æ—¶é—´å†²çªä¸æå‰é¢„çº¦æ£€æŸ¥ ================ */
function checkTimeConflict(startDate, startTime, endDate, endTime, ignoreId=null){
  const s = new Date(`${startDate}T${startTime}`);
  const e = new Date(`${endDate}T${endTime}`);
  if (s >= e) return { conflict:true, message:'çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“' };
  for (const a of appointments){
    if (a.status !== 'approved') continue;
    if (ignoreId && a.id === ignoreId) continue;
    const as = new Date(a.startTime), ae = new Date(a.endTime);
    if ((s >= as && s < ae) || (e > as && e <= ae) || (s <= as && e >= ae)){
      return { conflict:true, message:`èˆ‡ ${a.applicant} çš„é ç´„è¡çª (${formatAppointmentTime(a.startTime, a.endTime)})` };
    }
  }
  return { conflict:false, message:'' };
}

function checkAdvanceBooking(startDate){
  const adv = Number(systemSettings.advanceDays || 0);
  if (adv <= 0) return { warning:false, message:'' };
  const today = new Date(); today.setHours(0,0,0,0);
  const start = new Date(startDate); start.setHours(0,0,0,0);
  const diffDays = Math.ceil((start - today) / (1000*60*60*24));
  if (diffDays < adv) {
    return { warning:true, message:`éœ€æå‰ ${adv} å¤©é ç´„ï¼Œè«‹é¸æ“‡ ${adv} å¤©å¾Œæˆ–æ›´æ™š` };
  }
  return { warning:false, message:'' };
}

/* ================== æ—¥æœŸ/æ—¶é—´é€‰æ‹©ç¦ç”¨ï¼ˆæŒ‰ advanceDaysï¼‰ ================ */
function updateDateMinConstraints(){
  const adv = Number(systemSettings.advanceDays || 0);
  const minDate = new Date();
  minDate.setDate(minDate.getDate() + adv);
  const minStr = minDate.toISOString().split('T')[0];
  document.getElementById('start-date').min = minStr;
  document.getElementById('end-date').min = minStr;
  // è‹¥å½“å‰å·²é€‰æ—¥æœŸæ—©äº minï¼Œåˆ™æ¸…ç©ºå¹¶æç¤º
  ['start-date','end-date'].forEach(id=>{
    const el = document.getElementById(id);
    if (el.value && el.value < minStr) el.value = '';
  });
  // æ›´æ–°æ—¶é—´ä¸‹æ‹‰çš„ä¸å¯é€‰é¡¹ï¼ˆæ—¶é—´æœ¬èº«é€šå¸¸ä¸å— advanceDays é™åˆ¶ï¼Œä½†å¦‚æœç”¨æˆ·é€‰æ‹©äº†ä¸€ä¸ªè¢«ç¦ç”¨çš„æ—¥æœŸåˆ™ç¦ç”¨æ—¶é—´é€‰é¡¹ï¼‰
  refreshTimeOptionStates();
}

function refreshTimeOptionStates(){
  // If selected date is earlier than allowed -> disable times; else allow.
  const adv = Number(systemSettings.advanceDays || 0);
  const allowedDate = new Date(); allowedDate.setDate(allowedDate.getDate() + adv);
  const allowedStr = allowedDate.toISOString().split('T')[0];
  ['start','end'].forEach(()=>{}); // no-op to satisfy linter
  // start-time / end-time: if start-date exists and is < allowedStr -> disable all options
  const sDate = document.getElementById('start-date').value;
  const eDate = document.getElementById('end-date').value;
  const startTimeSel = document.getElementById('start-time');
  const endTimeSel = document.getElementById('end-time');

  [startTimeSel, endTimeSel].forEach(sel => {
    for (let i=0;i<sel.options.length;i++){
      sel.options[i].disabled = false;
      sel.options[i].classList.remove('disabled-opt');
    }
  });

  // If browser allowed selecting earlier dates (unlikely), handle defensive: if selected date < min, disable times
  if (sDate && sDate < document.getElementById('start-date').min){
    // disable all start-time options
    for (let i=0;i<startTimeSel.options.length;i++){
      startTimeSel.options[i].disabled = true;
      startTimeSel.options[i].classList.add('disabled-opt');
    }
  }
  if (eDate && eDate < document.getElementById('end-date').min){
    for (let i=0;i<endTimeSel.options.length;i++){
      endTimeSel.options[i].disabled = true;
      endTimeSel.options[i].classList.add('disabled-opt');
    }
  }
}

/* ç»‘å®šæ—¥æœŸ/æ—¶é—´ change äº‹ä»¶ */
['start-date','start-time','end-date','end-time'].forEach(id=>{
  document.getElementById(id).addEventListener('change', ()=>{
    updateSelectedTimeDisplay();
    refreshTimeOptionStates();
  });
});

/* æ›´æ–°å·²é€‰æ‹©æ—¶é—´æ–‡æœ¬å¹¶æ£€æµ‹å†²çª/æå‰è§„åˆ™ */
function updateSelectedTimeDisplay(){
  const sd = document.getElementById('start-date').value;
  const st = document.getElementById('start-time').value;
  const ed = document.getElementById('end-date').value;
  const et = document.getElementById('end-time').value;
  const selDiv = document.getElementById('selected-time');
  const conflictDiv = document.getElementById('conflict-warning');
  const advDiv = document.getElementById('advance-warning');
  if (sd && st && ed && et){
    selDiv.textContent = `${sd} ${st} - ${ed} ${et}`;
    const c = checkTimeConflict(sd,st,ed,et);
    if (c.conflict){ conflictDiv.textContent = c.message; conflictDiv.style.display='block'; } else { conflictDiv.style.display='none'; }
    const a = checkAdvanceBooking(sd);
    if (a.warning){ advDiv.textContent = a.message; advDiv.style.display='block'; } else { advDiv.style.display='none'; }
  } else {
    selDiv.textContent = 'æœªé¸æ“‡æ™‚é–“æ®µ';
    conflictDiv.style.display='none'; advDiv.style.display='none';
  }
}

/* ================== æäº¤é¢„çº¦ï¼ˆå†™å…¥ Firebaseï¼‰ ================== */
document.getElementById('appointment-form').addEventListener('submit', function(e){
  e.preventDefault();
  const applicant = document.getElementById('applicant').value.trim();
  const phone = document.getElementById('applicant-phone').value.trim();
  const count = parseInt(document.getElementById('ipad-count').value);
  const purpose = document.getElementById('purpose').value.trim();
  const sd = document.getElementById('start-date').value;
  const st = document.getElementById('start-time').value;
  const ed = document.getElementById('end-date').value;
  const et = document.getElementById('end-time').value;

  // ç®€å•éªŒè¯
  if (!applicant || !phone || !count || !sd || !st || !ed || !et) { alert('è«‹å¡«å¯«å®Œæ•´'); return; }
  if (!/^[0-9]{11}$/.test(phone)) { alert('è«‹è¼¸å…¥11ä½æ‰‹æ©Ÿè™Ÿç¢¼'); return; }
  const c = checkTimeConflict(sd,st,ed,et);
  if (c.conflict) { alert(c.message); return; }
  const a = checkAdvanceBooking(sd);
  if (a.warning) { alert(a.message); return; }

  const newRef = appointmentsRef.push();
  const id = newRef.key;
  const obj = {
    id: id,
    applicant, phone, count: count,
    startTime: `${sd}T${st}`,
    endTime: `${ed}T${et}`,
    purpose, status: systemSettings.enableApproval ? 'pending' : 'approved',
    color: getRandomColor(),
    returned: false,
    returnNotes: '',
    returnChecks: {},
    returnPhotos: [], // will hold photo URLs after upload
    returnTime: null,
    timeCreated: new Date().toISOString()
  };

  newRef.set(obj)
    .then(()=> {
      document.getElementById('success-message').style.display='block';
      setTimeout(()=>document.getElementById('success-message').style.display='none',3000);
      document.getElementById('appointment-form').reset();
      updateSelectedTimeDisplay();
    })
    .catch(err=>alert('æäº¤å¤±æ•—ï¼š' + err.message));
});

/* ================== æ›´æ–°ç®¡ç†è¡¨æ ¼ ================ */
function updateAppointmentsTable(){
  const tbody = document.querySelector('#appointments-table tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!appointments || appointments.length===0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:12px">æš«ç„¡é ç´„è¨˜éŒ„</td></tr>'; return;
  }
  // æŒ‰æ—¶é—´æ’åºï¼ˆå¼€å§‹æ—¶é—´ï¼‰
  const sorted = appointments.slice().sort((a,b)=> new Date(a.startTime) - new Date(b.startTime));
  sorted.forEach(a=>{
    let statusText=''; let cls='';
    if (a.returned){ statusText='å·²æ­¸é‚„'; cls='status-returned'; }
    else if (a.status==='approved'){ statusText='å·²æ‰¹å‡†'; cls='status-approved'; }
    else if (a.status==='pending'){ statusText='å¾…å¯©æ ¸'; cls='status-pending'; }
    else if (a.status==='rejected'){ statusText='å·²é§å›'; cls='status-rejected'; }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.applicant}</td>
      <td>${a.phone}</td>
      <td>${a.count}å°</td>
      <td>${formatAppointmentTime(a.startTime,a.endTime)}</td>
      <td><span class="status ${cls}">${statusText}</span></td>
      <td>
        <button class="btn-primary view-detail-btn" data-id="${a.id}">æŸ¥çœ‹è©³æƒ…</button>
        ${(!a.returned && a.status!=='rejected') ? `<button class="btn-danger reject-btn" data-id="${a.id}">é§å›</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });

  // ç»‘å®šæ“ä½œ
  document.querySelectorAll('.view-detail-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> showAppointmentDetail(btn.getAttribute('data-id')));
  });
  document.querySelectorAll('.reject-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> showRejectModal(btn.getAttribute('data-id')));
  });
}

/* ================== æŸ¥çœ‹è©³æƒ…ã€æ‰“å° ================ */
function showAppointmentDetail(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  const body = document.getElementById('appointment-detail-body');
  let returnPhotosHtml = '';
  if (a.returnPhotos && a.returnPhotos.length>0){
    returnPhotosHtml = `<div style="margin-top:8px"><strong>æ­¸é‚„ç…§ç‰‡ï¼š</strong><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">` +
      a.returnPhotos.map(url=>`<img src="${url}" style="width:120px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #ddd" />`).join('') + `</div></div>`;
  }
  body.innerHTML = `
    <div><strong>ç”³è«‹äººï¼š</strong> ${a.applicant}</div>
    <div><strong>è¯ç¹«ï¼š</strong> ${a.phone}</div>
    <div><strong>æ•¸é‡ï¼š</strong> ${a.count} å°</div>
    <div><strong>ç›®çš„ï¼š</strong> ${a.purpose || 'ç„¡'}</div>
    <div><strong>æ™‚é–“ï¼š</strong> ${formatAppointmentTime(a.startTime,a.endTime)}</div>
    <div><strong>ç‹€æ…‹ï¼š</strong> ${a.returned ? 'å·²æ­¸é‚„' : a.status}</div>
    ${a.status==='rejected' && a.rejectReason ? `<div><strong>é§å›åŸå› ï¼š</strong>${a.rejectReason}</div>` : ''}
    ${a.returned ? `<div><strong>æ­¸é‚„æ™‚é–“ï¼š</strong>${a.returnTime ? new Date(a.returnTime).toLocaleString() : 'æœªè¨˜éŒ„'}</div>
      <div><strong>æ­¸é‚„å‚™è¨»ï¼š</strong>${a.returnNotes || 'ç„¡'}</div>
      ${a.returnChecks ? `<div><strong>æª¢æŸ¥é …ç›®ï¼š</strong>${Object.keys(a.returnChecks).filter(k=>a.returnChecks[k]).join('ã€') || 'ç„¡'}</div>` : '' }
      ${returnPhotosHtml}` : ''}
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="close-detail" class="btn-secondary">é—œé–‰</button>
      <button id="print-detail" class="btn-print" data-id="${a.id}">æ‰“å°</button>
    </div>
  `;
  document.getElementById('appointment-detail-modal').style.display='flex';
  document.getElementById('close-detail').addEventListener('click', ()=> document.getElementById('appointment-detail-modal').style.display='none');
  document.getElementById('print-detail').addEventListener('click', ()=> { printAppointment(a.id); });
}
function printAppointment(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  let html = `<h1>é ç´„è©³æƒ…</h1>`;
  html += `<div>ç”³è«‹äººï¼š${a.applicant}</div><div>è¯ç¹«ï¼š${a.phone}</div><div>æ•¸é‡ï¼š${a.count}å°</div><div>æ™‚é–“ï¼š${formatAppointmentTime(a.startTime,a.endTime)}</div><div>ç‹€æ…‹ï¼š${a.status}</div>`;
  const w = window.open('about:blank','print');
  w.document.write(`<html><head><title>æ‰“å°</title></head><body>${html}</body></html>`);
  w.document.close(); w.print();
}

/* ================== é§å›æµç¨‹ ================ */
function showRejectModal(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  const body = document.getElementById('reject-modal-body');
  body.innerHTML = `
    <div><strong>ç”³è«‹ï¼š</strong>${a.applicant} (${a.count}å°)</div>
    <div style="margin-top:8px"><label>é§å›åŸå› </label><textarea id="reject-reason" rows="3" style="width:100%"></textarea></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="cancel-reject" class="btn-secondary">å–æ¶ˆ</button>
      <button id="confirm-reject" class="btn-danger">ç¢ºèªé§å›</button>
    </div>
  `;
  document.getElementById('reject-modal').style.display='flex';
  document.getElementById('cancel-reject').addEventListener('click', ()=> document.getElementById('reject-modal').style.display='none');
  document.getElementById('confirm-reject').addEventListener('click', ()=>{
    const reason = document.getElementById('reject-reason').value.trim();
    if (!reason){ alert('è«‹å¡«å¯«åŸå› '); return; }
    appointmentsRef.child(id).update({ status:'rejected', rejectReason: reason }).then(()=> {
      alert('å·²é§å›');
      document.getElementById('reject-modal').style.display='none';
    }).catch(err=>alert('éŒ¯èª¤ï¼š'+err.message));
  });
}

/* ================== æ­¸é‚„æµç¨‹ï¼ˆæ”¯æŒæ‹ç…§ä¸Šå‚³ï¼‰ ================ */
function updateReturnList(){
  const list = document.getElementById('return-list'); list.innerHTML='';
  const pending = appointments.filter(a => a.status === 'approved' && !a.returned).sort((x,y)=> new Date(x.startTime)-new Date(y.startTime));
  if (pending.length===0){ list.innerHTML='<p style="text-align:center;padding:18px;color:#666">æš«ç„¡å¾…æ­¸é‚„è¨­å‚™</p>'; return; }
  pending.forEach(a=>{
    const div = document.createElement('div'); div.className='return-item';
    div.innerHTML = `<div class="return-item-header"><div><strong>${a.applicant}</strong></div><div>${a.count}å°</div></div>
      <div class="return-item-details">è¯ç¹«ï¼š${a.phone}<br>æ™‚é–“ï¼š${formatAppointmentTime(a.startTime,a.endTime)}<br>ç”¨é€”ï¼š${a.purpose || 'ç„¡'}</div>
      <div class="return-actions"><button class="btn-success return-btn" data-id="${a.id}">æ­¸é‚„ç™»è¨˜</button></div>`;
    list.appendChild(div);
  });
  document.querySelectorAll('.return-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> showReturnModal(btn.getAttribute('data-id')));
  });
}

function showReturnModal(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  const body = document.getElementById('return-modal-body');
  body.innerHTML = `
    <div><strong>ç”³è«‹äººï¼š</strong>${a.applicant}</div>
    <div><strong>æ•¸é‡ï¼š</strong>${a.count}å°</div>
    <div style="margin-top:8px">
      <label>æª¢æŸ¥é …ç›®</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <label style="display:flex;align-items:center;gap:6px"><input id="check-device-count" type="checkbox" /> è¨­å‚™æ•¸é‡æ­£ç¢º</label>
        <label style="display:flex;align-items:center;gap:6px"><input id="check-device-condition" type="checkbox" /> è¨­å‚™å¤–è§€å®Œå¥½</label>
        <label style="display:flex;align-items:center;gap:6px"><input id="check-accessories" type="checkbox" /> é…ä»¶é½Šå…¨</label>
      </div>
    </div>
    <div style="margin-top:10px"><label>æ­¸é‚„å‚™è¨»</label><textarea id="return-notes" rows="3" style="width:100%"></textarea></div>
    <div style="margin-top:10px"><label>ä¸Šå‚³ç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</label>
      <input id="return-photos" type="file" accept="image/*" multiple capture="environment" style="margin-top:6px" />
      <div id="return-photo-previews" class="return-photos-container"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="cancel-return" class="btn-secondary">å–æ¶ˆ</button>
      <button id="confirm-return" class="btn-success">ç¢ºèªæ­¸é‚„</button>
    </div>
  `;
  document.getElementById('return-modal').style.display='flex';

  const photoInput = document.getElementById('return-photos');
  const previews = document.getElementById('return-photo-previews');
  // é¢„è§ˆæœ¬åœ°é€‰ä¸­å›¾ç‰‡
  photoInput.addEventListener('change', ()=>{
    previews.innerHTML = '';
    const files = Array.from(photoInput.files || []);
    files.forEach((file, idx)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        const img = document.createElement('img'); img.src = e.target.result; img.className='thumb';
        // æ·»åŠ åˆ é™¤æŒ‰é’®
        const wrap = document.createElement('div'); wrap.style.position='relative';
        const del = document.createElement('button'); del.textContent='Ã—'; del.style.position='absolute'; del.style.right='4px'; del.style.top='4px'; del.style.background='rgba(0,0,0,0.5)'; del.style.color='#fff'; del.style.border='none'; del.style.borderRadius='50%'; del.style.width='22px'; del.style.height='22px'; del.style.cursor='pointer';
        del.addEventListener('click', ()=>{
          // ç§»é™¤è¯¥æ–‡ä»¶ â€”â€” ä¸èƒ½ç›´æ¥ä¿®æ”¹ FileListï¼Œå› æ­¤é‡å»º FileList éœ€è¦ DataTransfer
          const dt = new DataTransfer();
          files.splice(idx,1);
          files.forEach(f=>dt.items.add(f));
          photoInput.files = dt.files;
          // é‡æ–°è§¦å‘ change æ˜¾ç¤º
          const ev = new Event('change'); photoInput.dispatchEvent(ev);
        });
        wrap.appendChild(img); wrap.appendChild(del);
        previews.appendChild(wrap);
      };
      reader.readAsDataURL(file);
    });
  });

  document.getElementById('cancel-return').addEventListener('click', ()=> document.getElementById('return-modal').style.display='none');

  document.getElementById('confirm-return').addEventListener('click', async ()=>{
    const checks = { deviceCount: document.getElementById('check-device-count').checked,
                     deviceCondition: document.getElementById('check-device-condition').checked,
                     accessories: document.getElementById('check-accessories').checked };
    const notes = document.getElementById('return-notes').value.trim();
    const files = Array.from(photoInput.files || []);

    // è‹¥æœ‰ç…§ç‰‡ï¼Œå…ˆä¸Šä¼ åˆ° Firebase Storageï¼šè·¯å¾„ returns/{appointmentId}/{timestamp}_{name}
    let uploadedUrls = [];
    try {
      for (const file of files){
        const path = `returns/${id}/${Date.now()}_${file.name}`;
        const ref = storage.ref().child(path);
        const snap = await ref.put(file);
        const url = await snap.ref.getDownloadURL();
        uploadedUrls.push(url);
      }
    } catch (err) {
      alert('ç…§ç‰‡ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
      return;
    }

    // æ›´æ–° appointment
    const updateObj = { returned:true, returnChecks:checks, returnNotes:notes, returnTime:new Date().toISOString() };
    if (uploadedUrls.length>0) updateObj.returnPhotos = uploadedUrls;
    appointmentsRef.child(id).update(updateObj).then(()=>{
      alert('æ­¸é‚„ç™»è¨˜æˆåŠŸ');
      document.getElementById('return-modal').style.display='none';
    }).catch(err=>alert('æ›´æ–°å¤±æ•—ï¼š' + err.message));
  });
}

/* ================== æ—¥æ›†ï¼šç½‘æ ¼æ¸²æŸ“ï¼Œä½¿ç”¨ grid-row / grid-column æ¥å®šä½é¢„çº¦å— ================ */
function updateScheduleView(){
  const cal = document.getElementById('calendar-grid');
  const header = document.getElementById('week-header');
  cal.innerHTML=''; header.innerHTML='';

  // è®¡ç®—æœ¬å‘¨èµ·å§‹ï¼ˆæ—¥æ›œä¸º0ï¼‰
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay() + currentWeekOffset*7);
  weekStart.setHours(0,0,0,0);
  const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
  document.getElementById('week-title').textContent = `${weekStart.getMonth()+1}/${weekStart.getDate()} - ${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;

  // header: æ—¶é—´åˆ— + 7 å¤©
  const timeHeader = document.createElement('div'); timeHeader.className='time-label'; timeHeader.textContent='æ™‚é–“';
  header.appendChild(timeHeader);
  for (let i=0;i<7;i++){
    const day = new Date(weekStart); day.setDate(weekStart.getDate()+i);
    const dCell = document.createElement('div'); dCell.className='day-cell';
    const dayNames = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];
    dCell.textContent = `${dayNames[day.getDay()]} ${day.getMonth()+1}/${day.getDate()}`;
    header.appendChild(dCell);
  }

  // grid åŸºç¡€ï¼šç”Ÿæˆæ—¶é—´è¡Œï¼ˆ08:00 - 18:00 æ¯ 30 åˆ†ï¼‰
  const rows = [];
  for (let hour=8; hour<=18; hour++){
    for (let minute of [0,30]){
      if (hour===18 && minute===30) continue;
      const rowIndex = rows.length + 1;
      // æ—¶é—´æ ‡ç­¾åˆ—
      const timeCell = document.createElement('div'); timeCell.className='grid-time-cell'; timeCell.style.gridColumn='1';
      timeCell.textContent = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
      timeCell.style.gridRow = rowIndex;
      cal.appendChild(timeCell);
      // 7 å¤©çš„ç©ºç™½å•å…ƒæ ¼
      for (let d=0; d<7; d++){
        const cell = document.createElement('div'); cell.className='grid-day-cell';
        cell.style.gridColumn = (d+2);
        cell.style.gridRow = rowIndex;
        cal.appendChild(cell);
      }
      rows.push({hour, minute});
    }
  }

  // å°† appointments ä¸­çš„å·²æ‰¹å‡†é¡¹ç»˜åˆ¶ä¸ºå—ï¼ˆè·¨å¤šè¡Œï¼‰
  // grid-row start/endï¼šè®¡ç®— startRow, endRow
  const rowCount = rows.length;
  const slotsStartMinutes = 8*60; // 08:00
  appointments.forEach(a=>{
    if (a.status !== 'approved') return;
    const s = new Date(a.startTime);
    const e = new Date(a.endTime);

    // å¦‚æœä¸åœ¨æœ¬å‘¨èŒƒå›´åˆ™è·³è¿‡
    if (e <= weekStart || s >= new Date(weekStart.getTime() + 7*24*3600*1000)) return;

    // dayIndex relative to weekStart (0..6)
    const dayIndex = (s.getDay() + 7 - weekStart.getDay()) % 7;

    const sMinutes = s.getHours()*60 + s.getMinutes();
    const eMinutes = e.getHours()*60 + e.getMinutes();

    let startRow = Math.floor((sMinutes - slotsStartMinutes) / 30) + 1;
    let endRow = Math.ceil((eMinutes - slotsStartMinutes) / 30) + 1;
    if (startRow < 1) startRow = 1;
    if (endRow > rowCount+1) endRow = rowCount+1;

    const block = document.createElement('div');
    block.className = 'appointment-block';
    block.style.gridColumn = (dayIndex + 2);
    block.style.gridRow = `${startRow} / ${endRow}`;
    block.style.backgroundColor = a.color || getRandomColor();
    block.innerHTML = `<div class="appointment-info">${a.applicant}</div><div class="appointment-time">${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}-${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}</div>`;
    // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
    block.addEventListener('click', ()=> showAppointmentDetail(a.id));
    cal.appendChild(block);
  });
}

/* ================== ç®¡ç†å‘˜ç™»å½•ä¸è®¾ç½® ================ */
document.getElementById('admin-link').addEventListener('click', (e)=>{ e.preventDefault(); if (isAdminLoggedIn) showAdmin(); else showPage('login-page'); });

function showAdmin(){ showPage('admin-page'); updateAppointmentsTable(); renderQRCode(); }

document.getElementById('login-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const user = document.getElementById('username').value.trim();
  const pwd = document.getElementById('password').value;
  const err = document.getElementById('login-error');
  if (user==='admin' && pwd === adminPassword){
    isAdminLoggedIn = true; err.style.display='none'; showAdmin();
  } else { err.style.display='block'; }
});

document.querySelectorAll('.nav-tab').forEach(tab=>{
  tab.addEventListener('click', function(){
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    this.classList.add('active');
    const name = this.getAttribute('data-tab');
    document.querySelectorAll('.tab-content').forEach(tc=>tc.style.display='none');
    const el = document.getElementById(name + '-tab');
    if (el) el.style.display='block';
    // legacy qrcode tab id mapping
    if (name==='qrcode') { document.getElementById('qrcode-tab') && (document.getElementById('qrcode-tab').style.display='block'); }
  });
});

/* ä¿å­˜è®¾ç½® */
document.getElementById('save-settings').addEventListener('click', ()=>{
  const adv = Number(document.getElementById('advance-days').value || 0);
  const phone = document.getElementById('admin-phone').value.trim();
  systemSettings.advanceDays = adv;
  systemSettings.adminPhone = phone;
  settingsRef.update({ advanceDays: adv, adminPhone: phone }).then(()=> {
    alert('è¨­ç½®å·²ä¿å­˜');
    updateDateMinConstraints();
  }).catch(err=>alert('ä¿å­˜å¤±æ•—ï¼š' + err.message));
});

/* ä¿®æ”¹ç®¡ç†å‘˜å¯†ç  -> åŒæ­¥å†™å…¥ settings.adminPassword */
document.getElementById('change-password').addEventListener('click', ()=>{
  const cur = document.getElementById('current-password').value;
  const nw = document.getElementById('new-password').value;
  const cf = document.getElementById('confirm-password').value;
  if (cur !== adminPassword){ alert('ç•¶å‰å¯†ç¢¼éŒ¯èª¤'); return; }
  if (!nw || nw !== cf){ alert('æ–°å¯†ç¢¼ä¸ä¸€è‡´æˆ–ç‚ºç©º'); return; }
  adminPassword = nw;
  settingsRef.update({ adminPassword: adminPassword }).then(()=> alert('å¯†ç¢¼å·²ä¿®æ”¹')).catch(err=>alert('ä¿®æ”¹å¤±æ•—ï¼š' + err.message));
});

/* render QRCode */
function renderQRCode(){
  const q = document.getElementById('qrcode');
  q.innerHTML='';
  QRCode.toCanvas(q, location.href, { width:200 }, function(err){});
}

/* ================== admin: åˆ·æ–°ã€æ¸…ç©ºï¼ˆæ¸…ç©ºéœ€å¯†ç ç¡®è®¤ï¼‰ ================ */
document.getElementById('refresh-appointments').addEventListener('click', ()=>{
  // ç”±äºå®æ—¶ç›‘å¬ï¼Œrefresh åªæ˜¯æ‹‰å–å¿«ç…§ä»¥ç¡®è®¤æ— è¯¯
  appointmentsRef.once('value').then(()=> alert('å·²åˆ·æ–°')).catch(err=>alert('åˆ·æ–°å¤±æ•—ï¼š'+err.message));
});

const CLEAR_CONFIRM_PASSWORD = '545600';
document.getElementById('clear-all-appointments').addEventListener('click', ()=>{
  document.getElementById('clear-confirm-modal').style.display='flex';
});
document.getElementById('clear-confirm-cancel').addEventListener('click', ()=> document.getElementById('clear-confirm-modal').style.display='none');
document.getElementById('clear-confirm-ok').addEventListener('click', ()=>{
  const val = document.getElementById('clear-confirm-input').value;
  if (val !== CLEAR_CONFIRM_PASSWORD){ alert('ç¢ºèªå¯†ç¢¼éŒ¯èª¤'); return; }
  // proceed to remove
  appointmentsRef.remove().then(()=> {
    alert('å·²æ¸…ç©ºæ‰€æœ‰é ç´„è¨˜éŒ„');
    document.getElementById('clear-confirm-input').value='';
    document.getElementById('clear-confirm-modal').style.display='none';
  }).catch(err=>alert('æ“ä½œå¤±æ•—ï¼š'+err.message));
});

/* ================== é¡µé¢å¯¼èˆª ================== */
document.getElementById('go-to-appointment').addEventListener('click', ()=> showPage('appointment-page'));
document.getElementById('go-to-schedule').addEventListener('click', ()=> { showPage('schedule-page'); updateScheduleView(); });
document.getElementById('go-to-return').addEventListener('click', ()=> { if (!isAdminLoggedIn) showPage('login-page'); else { showPage('return-page'); updateReturnList(); }});
document.getElementById('back-to-home').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-from-schedule').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-from-return').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-from-login').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-admin').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-from-qrcode').addEventListener('click', ()=> renderQRCode());

document.getElementById('prev-week').addEventListener('click', ()=> { currentWeekOffset--; updateScheduleView(); });
document.getElementById('next-week').addEventListener('click', ()=> { currentWeekOffset++; updateScheduleView(); });

document.getElementById('close-return-modal').addEventListener('click', ()=> document.getElementById('return-modal').style.display='none');
document.getElementById('close-appointment-detail-modal').addEventListener('click', ()=> document.getElementById('appointment-detail-modal').style.display='none');
document.getElementById('close-reject-modal').addEventListener('click', ()=> document.getElementById('reject-modal').style.display='none');

/* ================== åˆ é™¤é¢„çº¦ï¼ˆåœ¨éœ€è¦å¤„ä½¿ç”¨ï¼‰ ================ */
function deleteAppointment(id){
  if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é ç´„ï¼Ÿ')) return;
  appointmentsRef.child(id).remove().catch(err=>alert('åˆªé™¤å¤±æ•—ï¼š'+err.message));
}
/* æš´éœ²ç»™å…¨å±€ï¼ˆè‹¥éœ€è¦ï¼‰ */
window.deleteAppointment = deleteAppointment;

/* ================== é¦–æ¬¡çº¦æŸè®¾ç½® ================== */
updateDateMinConstraints();
updateSelectedTimeDisplay();
updateScheduleView();

function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

/* ================== ç»“æŸ ================== */
/* æç¤ºï¼šå¦‚æœä½ å¸Œæœ›æˆ‘æ¥ç€åšï¼š
   - ç»™ Storage / Database å†™æ›´ä¸¥æ ¼çš„å®‰å…¨è§„åˆ™ï¼ˆä»¥ä¿æŠ¤æ•°æ®ä¸ç…§ç‰‡ï¼‰
   - æŠŠç®¡ç†å‘˜ç™»å½•æ”¹ä¸º Firebase Authenticationï¼ˆæ›´å®‰å…¨ï¼‰
   - åœ¨ UI ä¸Šæ˜¾ç¤ºå½“å‰æ•°æ®åº“è¿é€šæ€§ / ä¸Šä¼ è¿›åº¦
   æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ å®ç°ã€‚ */
</script>
</body>
</html>
