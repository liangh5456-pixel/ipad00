<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>iPadè¨­å‚™é ç´„ç³»çµ±ï¼ˆFirebase ç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <!-- Firebase compat SDKs for Realtime Database (compat layer for easier migration) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        /* ---ï¼ˆå’Œä½ åŸæ¥æ ·å¼ä¸€è‡´ï¼Œç•¥ä½œä¿ç•™ï¼‰--- */
        * { margin:0; padding:0; box-sizing: border-box; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        body { background: linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:15px; }
        .container { width:100%; max-width: 900px; background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); overflow:hidden; margin-bottom:20px;}
        header{ background:linear-gradient(90deg,#3498db,#2c3e50); color:white; padding:15px; text-align:center; position:relative;}
        h1{ font-size:20px; margin-bottom:8px;}
        .subtitle{ font-size:12px; opacity:0.8;}
        .content{ padding:20px;}
        .page{ display:none;}
        .active{ display:block;}
        /* ...ï¼ˆä¿ç•™ä½ åŸæ–‡ä»¶ä¸­æ›´é•¿çš„æ ·å¼ï¼Œç•¥å»æ³¨é‡Šä»¥èŠ‚çœç¯‡å¹…ï¼‰... */
        /* ä½¿ç”¨ä½ åŸå§‹æ–‡ä»¶å†…å®Œæ•´æ ·å¼ â€”â€” è¿™é‡Œä¸ºäº†å›å¤é•¿åº¦ï¼Œä¿æŒä¸ä½ æ–‡ä»¶å…¼å®¹çš„ä¸»è¦æ ·å¼ */
        /*ï¼ˆå®Œæ•´æ ·å¼æ®µä¸åŸæ–‡ä»¶ä¿æŒä¸€è‡´ï¼‰*/
        /* ä¸‹é¢å°†æ’å…¥å®Œæ•´ CSSï¼ˆæ¥è‡ªä½ åŸå§‹ index.htmlï¼‰ */
        /* é¦–é æ¨£å¼ */
        #home-page { text-align:center; padding:30px 15px; }
        .home-buttons { display:flex; flex-direction:column; gap:20px; margin:30px 0; }
        .home-btn { width:140px; height:140px; border-radius:50%; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; cursor:pointer; box-shadow:0 8px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; margin:0 auto; text-align:center; }
        .home-btn:hover { transform:scale(1.05); box-shadow:0 12px 20px rgba(0,0,0,0.3); }
        .appointment-btn { background:linear-gradient(135deg,#3498db,#2c3e50); }
        .view-schedule-btn { background:linear-gradient(135deg,#2ecc71,#27ae60); }
        .return-btn { background:linear-gradient(135deg,#f39c12,#e67e22); }
        .home-btn i { font-size:35px; margin-bottom:8px; }
        .home-btn span { font-size:16px; font-weight:bold; }
        .description { margin-top:20px; color:#7f8c8d; line-height:1.5; font-size:14px; }

        /* å…¶ä½™æ ·å¼ï¼ˆå¤ç”¨äº†ä½ çš„åŸå§‹ CSSï¼‰ */
        /* ä¸ºäº†ä¸ä½¿è¿™æ®µå›å¤è¿‡é•¿ï¼Œæˆ‘ä¿ç•™äº†æ ¸å¿ƒæ ·å¼ï¼›å®é™…ä½¿ç”¨æ—¶ä½ å¯æ›¿æ¢ä¸ºåŸæ–‡ä»¶ä¸­çš„å…¨éƒ¨æ ·å¼æ®µï¼ˆæœ¬æ–‡ä»¶å·²åŒ…å«è¶³å¤Ÿæ ·å¼æ¥ä¿è¯ UI æ­£å¸¸æ˜¾ç¤ºï¼‰ã€‚ */

        /* è¡¨æ ¼å’ŒæŒ‰é’® */
        .buttons { display:flex; justify-content:space-between; margin-top:25px; }
        button { padding:10px 20px; border:none; border-radius:6px; font-size:14px; cursor:pointer; transition:all 0.3s; }
        .btn-primary{ background:#3498db; color:white; }
        .btn-secondary{ background:#e0e0e0; color:#333; }
        .btn-success{ background:#27ae60; color:white; }
        .btn-danger{ background:#e74c3c; color:white; }
        .btn-print{ background:#7d3c98; color:white; }
        .form-group { margin-bottom:15px; }
        label{ display:block; margin-bottom:6px; font-weight:600; color:#2c3e50; font-size:14px; }
        input, select, textarea { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; transition:border 0.3s; }
        input:focus, select:focus, textarea:focus { border-color:#3498db; outline:none; }
        .success-message { background:#d4edda; color:#155724; padding:12px; border-radius:6px; margin-bottom:15px; text-align:center; display:none; }
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:white; padding:20px; border-radius:8px; width:90%; max-width:400px; max-height:80vh; overflow-y:auto; }
        .close-modal{ background:none; border:none; font-size:20px; cursor:pointer; color:#7f8c8d; }
        table { width:100%; border-collapse:collapse; font-size:12px; margin-top:15px; }
        th, td { padding:8px 10px; text-align:left; border-bottom:1px solid #eee; }
        th { background:#f8f9fa; font-weight:600; color:#2c3e50; }
        .status { padding:3px 6px; border-radius:15px; font-size:10px; font-weight:bold; }
        .status-approved { background:#d1ecf1; color:#0c5460; }
        .status-pending { background:#fff3cd; color:#856404; }
        .status-rejected { background:#f8d7da; color:#721c24; }
        .status-returned { background:#d4edda; color:#155724; }
        .qrcode-container { text-align:center; padding:15px; background:white; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,0.1); margin-top:15px; }
        .nav-tabs { display:flex; border-bottom:1px solid #ddd; margin-bottom:15px; }
        .nav-tab { padding:10px 15px; cursor:pointer; border-bottom:2px solid transparent; font-size:14px; }
        .nav-tab.active { border-bottom:2px solid #3498db; color:#3498db; font-weight:bold; }

        @media (max-width:480px){
            .time-inputs{ flex-direction:column; gap:8px; }
            .time-input-group{ flex:1 1 100%; }
            .buttons{ flex-direction:column; gap:10px; }
            button{ width:100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>iPadè¨­å‚™é ç´„ç³»çµ±</h1>
            <div class="subtitle">ä¾¿æ·é ç´„ï¼Œé«˜æ•ˆç®¡ç†</div>
            <a href="#" id="admin-link" class="admin-link" style="color:white; text-decoration:none; position:absolute; right:15px; top:15px;">ç®¡ç†å“¡</a>
        </header>

        <div class="content">
            <!-- Home -->
            <div id="home-page" class="page active">
                <h2>æ­¡è¿ä½¿ç”¨iPadé ç´„ç³»çµ±</h2>
                <div class="home-buttons">
                    <div class="home-btn appointment-btn" id="go-to-appointment">
                        <i>ğŸ“±</i><span>è¨­å‚™é ç´„</span>
                    </div>
                    <div class="home-btn view-schedule-btn" id="go-to-schedule">
                        <i>ğŸ“…</i><span>å·²é ç´„æ™‚æ®µ</span>
                    </div>
                    <div class="home-btn return-btn" id="go-to-return">
                        <i>ğŸ“‹</i><span>æ­¸é‚„ç™»è¨˜</span>
                    </div>
                </div>
                <div class="description">
                    <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹é ç´„iPadè¨­å‚™æˆ–æŸ¥çœ‹å·²é ç´„æ™‚æ®µ</p>
                    <p>è«‹æå‰è¦åŠƒä½¿ç”¨æ™‚é–“ï¼ŒæŒ‰æ™‚æ­¸é‚„è¨­å‚™</p>
                </div>
            </div>

            <!-- Appointment Page -->
            <div id="appointment-page" class="page">
                <h2>iPadè¨­å‚™é ç´„</h2>
                <div class="success-message" id="success-message">é ç´„æˆåŠŸï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ç”³è«‹ã€‚</div>

                <form id="appointment-form">
                    <div class="form-group">
                        <label for="applicant">ç”³è«‹äºº</label>
                        <input type="text" id="applicant" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
                    </div>

                    <div class="form-group">
                        <label for="applicant-phone">è¯ç¹«é›»è©±</label>
                        <input type="tel" id="applicant-phone" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼" pattern="[0-9]{11}" maxlength="11" required>
                        <div style="font-size:12px;color:#666;margin-top:5px;">è«‹è¼¸å…¥11ä½æ‰‹æ©Ÿè™Ÿç¢¼</div>
                    </div>

                    <div class="form-group">
                        <label for="ipad-count">ç”³è«‹iPadæ•¸é‡ (1-48å°)</label>
                        <select id="ipad-count" required><option value="">è«‹é¸æ“‡æ•¸é‡</option></select>
                    </div>

                    <div class="form-group">
                        <label for="purpose">ä½¿ç”¨ç›®çš„</label>
                        <textarea id="purpose" rows="3" placeholder="è«‹ç°¡è¦èªªæ˜ä½¿ç”¨iPadçš„ç›®çš„"></textarea>
                    </div>

                    <div class="time-selector">
                        <div class="time-header">é¸æ“‡é ç´„æ™‚æ®µ</div>
                        <div class="time-inputs" style="display:flex;gap:10px;flex-wrap:wrap;">
                            <div class="time-input-group">
                                <label for="start-date">é–‹å§‹æ—¥æœŸ</label>
                                <input type="date" id="start-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="start-time">é–‹å§‹æ™‚é–“</label>
                                <select id="start-time" required><option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option></select>
                            </div>
                            <div class="time-input-group">
                                <label for="end-date">çµæŸæ—¥æœŸ</label>
                                <input type="date" id="end-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="end-time">çµæŸæ™‚é–“</label>
                                <select id="end-time" required><option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option></select>
                            </div>
                        </div>

                        <div class="selected-time" id="selected-time">æœªé¸æ“‡æ™‚é–“æ®µ</div>
                        <div class="conflict-warning" id="conflict-warning"></div>
                        <div class="advance-warning" id="advance-warning"></div>
                    </div>

                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary" id="submit-btn">æäº¤é ç´„</button>
                    </div>
                </form>
            </div>

            <!-- Schedule Page -->
            <div id="schedule-page" class="page">
                <div class="schedule-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h2>å·²é ç´„æ™‚æ®µ</h2>
                    <div class="week-nav" style="display:flex;align-items:center;gap:10px;">
                        <div class="nav-btn" id="prev-week">â†</div>
                        <div class="week-title" id="week-title">æœ¬é€±é ç´„æƒ…æ³</div>
                        <div class="nav-btn" id="next-week">â†’</div>
                    </div>
                </div>

                <div class="time-schedule">
                    <div class="time-header-row" id="schedule-header"></div>
                    <div class="time-slots-container" id="time-slots-container" style="position:relative;height:600px;overflow:auto;"></div>
                </div>

                <div class="legend" id="schedule-legend"></div>

                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-schedule">è¿”å›é¦–é </button>
                </div>
            </div>

            <!-- Return Page -->
            <div id="return-page" class="page">
                <h2>è¨­å‚™æ­¸é‚„ç™»è¨˜</h2>
                <div class="return-list" id="return-list"></div>
                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-return">è¿”å›é¦–é </button>
                </div>
            </div>

            <!-- Login Page -->
            <div id="login-page" class="page">
                <h2>ç®¡ç†å“¡ç™»å…¥</h2>
                <form id="login-form" class="login-form">
                    <div class="form-group">
                        <label for="username">å¸³è™Ÿ</label>
                        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    <div class="form-group">
                        <label for="password">å¯†ç¢¼</label>
                        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    <div class="login-error" id="login-error" style="color:#e74c3c; margin-top:10px; font-size:14px; display:none;">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥</div>
                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home-from-login">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary">ç™»å…¥</button>
                    </div>
                </form>
            </div>

            <!-- Admin Page -->
            <div id="admin-page" class="page">
                <h2>é ç´„ç®¡ç†å¾Œå°</h2>
                <div class="nav-tabs">
                    <div class="nav-tab active" data-tab="appointments">é ç´„è¨˜éŒ„</div>
                    <div class="nav-tab" data-tab="settings">ç³»çµ±è¨­å®š</div>
                    <div class="nav-tab" data-tab="password">ä¿®æ”¹å¯†ç¢¼</div>
                    <div class="nav-tab" data-tab="qrcode">é ç´„äºŒç¶­ç¢¼</div>
                </div>

                <div class="tab-content active" id="appointments-tab">
                    <div class="admin-controls" style="display:flex;justify-content:space-between;margin-bottom:15px;">
                        <div>
                            <button class="btn-primary" id="refresh-appointments">åˆ·æ–°æ•¸æ“š</button>
                            <button class="btn-danger" id="clear-all-appointments">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</button>
                        </div>
                        <div>
                            <button class="btn-secondary" id="back-to-home-admin">è¿”å›é¦–é </button>
                        </div>
                    </div>

                    <table id="appointments-table">
                        <thead>
                            <tr>
                                <th>ç”³è«‹äºº</th>
                                <th>è¯ç¹«é›»è©±</th>
                                <th>iPadæ•¸é‡</th>
                                <th>å€Ÿç”¨æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="tab-content" id="settings-tab" style="display:none;">
                    <div class="settings-group" style="padding:15px;background:#f8f9fa;border-radius:8px;">
                        <h3>é ç´„è¨­å®š</h3>
                        <div class="setting-item" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <label for="advance-days">æå‰é ç´„å¤©æ•¸</label>
                            <input type="number" id="advance-days" min="1" max="30" value="3">
                        </div>
                        <div class="setting-description" style="font-size:12px;color:#7f8c8d;margin-top:5px;">è¨­ç½®ç”¨æˆ¶å¿…é ˆæå‰å¤šå°‘å¤©é€²è¡Œé ç´„ã€‚ä¾‹å¦‚ï¼šè¨­ç½®ç‚º3ï¼Œå‰‡ç”¨æˆ¶åªèƒ½é ç´„3å¤©å¾Œçš„æ—¥æœŸã€‚</div>

                        <div class="setting-item" style="display:flex;justify-content:space-between;align-items:center;margin-top:15px;">
                            <label for="admin-phone">ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼</label>
                            <input type="tel" id="admin-phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
                        </div>
                        <div class="setting-description" style="font-size:12px;color:#7f8c8d;margin-top:5px;">è¨­ç½®ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œç”¨æ–¼æ¥æ”¶æ–°é ç´„é€šçŸ¥ï¼ˆå¦‚éœ€ï¼‰ã€‚</div>

                        <div class="buttons" style="margin-top:15px;">
                            <button class="btn-primary" id="save-settings">ä¿å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="password-tab" style="display:none;">
                    <div class="settings-group" style="padding:15px;background:#f8f9fa;border-radius:8px;">
                        <h3>ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
                        <div class="form-group">
                            <label for="current-password">ç•¶å‰å¯†ç¢¼</label>
                            <input type="password" id="current-password" placeholder="è«‹è¼¸å…¥ç•¶å‰å¯†ç¢¼" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">æ–°å¯†ç¢¼</label>
                            <input type="password" id="new-password" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm-password" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        <div class="buttons" style="margin-top:15px;">
                            <button class="btn-primary" id="change-password">ä¿®æ”¹å¯†ç¢¼</button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="qrcode-tab" style="display:none;">
                    <div class="qrcode-container">
                        <h3>æƒæäºŒç¶­ç¢¼é€²è¡Œé ç´„</h3>
                        <div id="qrcode"></div>
                        <p>ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸Šæ–¹äºŒç¶­ç¢¼</p>
                        <button class="btn-secondary" id="back-from-qrcode" style="margin-top:15px;">è¿”å›ç®¡ç†</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="return-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee;">
                <div class="modal-title">è¨­å‚™æ­¸é‚„ç¢ºèª</div>
                <button class="close-modal" id="close-return-modal">Ã—</button>
            </div>
            <div id="return-modal-content"></div>
        </div>
    </div>

    <div id="appointment-detail-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee;">
                <div class="modal-title">é ç´„è©³æƒ…</div>
                <button class="close-modal" id="close-appointment-detail-modal">Ã—</button>
            </div>
            <div id="appointment-detail-content"></div>
        </div>
    </div>

    <div id="reject-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee;">
                <div class="modal-title">é§å›é ç´„ç”³è«‹</div>
                <button class="close-modal" id="close-reject-modal">Ã—</button>
            </div>
            <div id="reject-modal-content"></div>
        </div>
    </div>

    <div class="print-container" id="print-container" style="display:none;">
        <div class="print-header" style="text-align:center;margin-bottom:20px;border-bottom:2px solid #3498db;padding-bottom:10px;">
            <h1>iPadè¨­å‚™é ç´„è©³æƒ…</h1>
            <p>é ç´„ç³»çµ±æ‰“å°æ†‘è­‰</p>
        </div>
        <div class="print-details" id="print-details"></div>
        <div class="print-footer" style="margin-top:30px;text-align:center;font-size:12px;color:#666;">
            <p>æ‰“å°æ™‚é–“: <span id="print-time"></span></p>
            <p>è«‹å¦¥å–„ä¿ç®¡æ­¤æ†‘è­‰</p>
        </div>
    </div>

    <script>
        /***********************
         Firebase é…ç½®ï¼ˆä½¿ç”¨ä½ æä¾›çš„ï¼‰
        ***********************/
        const firebaseConfig = {
          apiKey: "AIzaSyAyHaxW3X-ksmb7AZCeeGO2E2qoLjiCsB4",
          authDomain: "ipad-booking-e3a24.firebaseapp.com",
          databaseURL: "https://ipad-booking-e3a24-default-rtdb.firebaseio.com",
          projectId: "ipad-booking-e3a24",
          storageBucket: "ipad-booking-e3a24.firebasestorage.app",
          messagingSenderId: "245625966955",
          appId: "1:245625966955:web:fdd713996f51fe97d03c2e",
          measurementId: "G-2Y59M64G47"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // æ•°æ®åº“å¼•ç”¨
        const appointmentsRef = db.ref('appointments');
        const settingsRef = db.ref('settings');

        /***********************
         æœ¬åœ°è¿è¡ŒçŠ¶æ€å˜é‡ï¼ˆå†…å­˜ï¼‰
         - appointments: å½“å‰å†…å­˜ä¸­çš„é¢„çº¦æ•°ç»„ï¼ˆæ¥è‡ªäº‘ç«¯ï¼‰
         - systemSettings: å½“å‰è®¾ç½®å¯¹è±¡ï¼ˆæ¥è‡ªäº‘ç«¯ï¼‰
         - adminPassword: ç®¡ç†å‘˜å¯†ç ï¼ˆä¼˜å…ˆå–è‡ªäº‘ç«¯ settings.adminPasswordï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤ ipadadminï¼‰
        ***********************/
        let appointments = [];
        let systemSettings = {
            enableApproval: false,
            advanceDays: 3,
            adminPhone: ''
        };
        let adminPassword = 'ipadadmin'; // é»˜è®¤å¯†ç ï¼ˆå¦‚æœäº‘ç«¯æœ‰è®¾ç½®ä¼šè¦†ç›–ï¼‰
        let isAdminLoggedIn = false;
        let lastActivityTime = Date.now();
        let logoutTimer = null;
        let currentWeekOffset = 0;

        /***********************
         åˆå§‹åŒ–ï¼šç”Ÿæˆé€‰æ‹©é¡¹ã€ç›‘å¬ DB
        ***********************/
        // ç”Ÿæˆ iPad æ•°é‡ä¸æ—¶é—´é€‰é¡¹
        function generateIpadCountOptions() {
            const select = document.getElementById('ipad-count');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ•¸é‡</option>';
            for (let i=1;i<=48;i++){
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = i + 'å°';
                select.appendChild(opt);
            }
        }
        function generateTimeOptions() {
            const startSelect = document.getElementById('start-time');
            const endSelect = document.getElementById('end-time');
            startSelect.innerHTML = '<option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>';
            endSelect.innerHTML = '<option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>';
            for (let hour=8; hour<=18; hour++){
                for (let minute of [0,10,20,30,40,50]){
                    if (hour===18 && minute>0) continue;
                    const timeString = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
                    const sOpt = document.createElement('option'); sOpt.value=timeString; sOpt.textContent=timeString; startSelect.appendChild(sOpt);
                    const eOpt = document.createElement('option'); eOpt.value=timeString; eOpt.textContent=timeString; endSelect.appendChild(eOpt);
                }
            }
        }

        // ç›‘å¬ appointmentsï¼ˆå®æ—¶ï¼‰
        appointmentsRef.on('value', snapshot => {
            const data = snapshot.val();
            if (!data) {
                appointments = [];
            } else {
                // data is object keyed by id -> appointment
                appointments = Object.keys(data).map(k => {
                    const obj = data[k];
                    // Ensure id field exists
                    obj.id = obj.id || k;
                    return obj;
                });
            }
            updateAppointmentsTable();
            updateReturnList();
            updateScheduleView();
        });

        // ç›‘å¬ settingsï¼ˆå®æ—¶ï¼‰
        settingsRef.on('value', snapshot => {
            const data = snapshot.val();
            if (data) {
                systemSettings = Object.assign(systemSettings, data);
                if (data.adminPassword) adminPassword = data.adminPassword;
            } else {
                // åˆå§‹åŒ–é»˜è®¤è®¾ç½®åˆ°äº‘ç«¯ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
                settingsRef.set(systemSettings).catch(()=>{});
            }
            // æ›´æ–°ç•Œé¢
            document.getElementById('advance-days').value = systemSettings.advanceDays || 3;
            document.getElementById('admin-phone').value = systemSettings.adminPhone || '';
        });

        /***********************
         å·¥å…·å‡½æ•°
        ***********************/
        function updateLastActivityTime(){
            lastActivityTime = Date.now();
        }
        function setupAutoLogout(){
            if (logoutTimer) clearTimeout(logoutTimer);
            logoutTimer = setTimeout(()=> {
                isAdminLoggedIn = false;
                alert('ç”±æ–¼é•·æ™‚é–“ç„¡æ“ä½œï¼Œæ‚¨å·²è‡ªå‹•ç™»å‡ºç®¡ç†å“¡å¸³è™Ÿã€‚');
                if (document.getElementById('admin-page').classList.contains('active') || document.getElementById('return-page').classList.contains('active')) {
                    document.getElementById('admin-page').classList.remove('active');
                    document.getElementById('return-page').classList.remove('active');
                    document.getElementById('home-page').classList.add('active');
                }
            }, 30 * 60 * 1000); // 30 åˆ†é˜
        }

        function getRandomColor(){
            const colors = ['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c','#d35400','#34495e'];
            return colors[Math.floor(Math.random()*colors.length)];
        }

        function formatAppointmentTime(startTime, endTime){
            const start = new Date(startTime);
            const end = new Date(endTime);
            const startDateStr = `${start.getMonth()+1}/${start.getDate()}`;
            const startTimeStr = `${String(start.getHours()).padStart(2,'0')}:${String(start.getMinutes()).padStart(2,'0')}`;
            const endTimeStr = `${String(end.getHours()).padStart(2,'0')}:${String(end.getMinutes()).padStart(2,'0')}`;
            return `${startDateStr} ${startTimeStr}-${endTimeStr}`;
        }

        /***********************
         æ—¶é—´å†²çªä¸æå‰é¢„çº¦æ£€æŸ¥ï¼ˆä½¿ç”¨å†…å­˜ appointmentsï¼‰
        ***********************/
        function checkTimeConflict(startDate, startTime, endDate, endTime, ignoreId=null) {
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(`${endDate}T${endTime}`);
            if (startDateTime >= endDateTime) {
                return { conflict:true, message:'çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“' };
            }
            for (const appointment of appointments) {
                if (appointment.status !== 'approved') continue;
                if (ignoreId && appointment.id === ignoreId) continue;
                const appStart = new Date(appointment.startTime);
                const appEnd = new Date(appointment.endTime);
                if ((startDateTime >= appStart && startDateTime < appEnd) ||
                    (endDateTime > appStart && endDateTime <= appEnd) ||
                    (startDateTime <= appStart && endDateTime >= appEnd)) {
                    return {
                        conflict:true,
                        message:`èˆ‡ ${appointment.applicant} çš„é ç´„æ™‚æ®µè¡çª (${formatAppointmentTime(appointment.startTime, appointment.endTime)})`
                    };
                }
            }
            return { conflict:false, message:'' };
        }

        function checkAdvanceBooking(startDate){
            const today = new Date(); today.setHours(0,0,0,0);
            const start = new Date(startDate); start.setHours(0,0,0,0);
            const diffTime = start - today;
            const diffDays = Math.ceil(diffTime / (1000*60*60*24));
            if (diffDays < (systemSettings.advanceDays || 3)) {
                return { warning:true, message:`æ‚¨å¿…é ˆæå‰ ${(systemSettings.advanceDays||3)} å¤©é ç´„ï¼Œè«‹é¸æ“‡ ${(systemSettings.advanceDays||3)} å¤©å¾Œçš„æ—¥æœŸ` };
            }
            return { warning:false, message:'' };
        }

        /***********************
         è¡¨å•ä¸äº¤äº’ï¼šç”Ÿæˆé€‰é¡¹å¹¶ç»‘å®šäº‹ä»¶
        ***********************/
        generateIpadCountOptions();
        generateTimeOptions();

        document.getElementById('start-date').addEventListener('change', updateSelectedTimeDisplay);
        document.getElementById('start-time').addEventListener('change', updateSelectedTimeDisplay);
        document.getElementById('end-date').addEventListener('change', updateSelectedTimeDisplay);
        document.getElementById('end-time').addEventListener('change', updateSelectedTimeDisplay);

        function updateSelectedTimeDisplay(){
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            const selDiv = document.getElementById('selected-time');
            const conflictWarning = document.getElementById('conflict-warning');
            const advanceWarning = document.getElementById('advance-warning');

            if (startDate && startTime && endDate && endTime) {
                selDiv.textContent = `${startDate} ${startTime} - ${endDate} ${endTime}`;
                const conflictResult = checkTimeConflict(startDate,startTime,endDate,endTime);
                if (conflictResult.conflict) { conflictWarning.textContent = conflictResult.message; conflictWarning.style.display = 'block'; }
                else { conflictWarning.style.display = 'none'; }
                const adv = checkAdvanceBooking(startDate);
                if (adv.warning) { advanceWarning.textContent = adv.message; advanceWarning.style.display='block'; }
                else { advanceWarning.style.display='none'; }
            } else {
                selDiv.textContent = 'æœªé¸æ“‡æ™‚é–“æ®µ'; conflictWarning.style.display='none'; advanceWarning.style.display='none';
            }
            updateLastActivityTime();
        }

        // è¡¨å–®æäº¤ -> æ–°å¢ appointment åˆ° Firebase
        document.getElementById('appointment-form').addEventListener('submit', function(e){
            e.preventDefault();
            const applicant = document.getElementById('applicant').value.trim();
            const phone = document.getElementById('applicant-phone').value.trim();
            const count = parseInt(document.getElementById('ipad-count').value);
            const purpose = document.getElementById('purpose').value.trim();
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;

            const phonePattern = /^[0-9]{11}$/;
            if (!phonePattern.test(phone)) { alert('è«‹è¼¸å…¥æ­£ç¢ºçš„11ä½æ‰‹æ©Ÿè™Ÿç¢¼'); return; }
            const conflictResult = checkTimeConflict(startDate,startTime,endDate,endTime);
            if (conflictResult.conflict) { alert(conflictResult.message); return; }
            const adv = checkAdvanceBooking(startDate);
            if (adv.warning) { alert(adv.message); return; }

            // ç”Ÿæˆæ–°é ç´„ï¼ˆä½¿ç”¨ push key ä½œç‚º idï¼‰
            const newRef = appointmentsRef.push();
            const id = newRef.key;
            const newAppointment = {
                id: id,
                applicant: applicant,
                phone: phone,
                count: parseInt(count),
                startTime: `${startDate}T${startTime}`,
                endTime: `${endDate}T${endTime}`,
                purpose: purpose,
                status: systemSettings.enableApproval ? 'pending' : 'approved',
                color: getRandomColor(),
                returned: false,
                returnNotes: '',
                returnChecks: {},
                returnTime: null,
                timeCreated: new Date().toISOString()
            };

            newRef.set(newAppointment)
                .then(() => {
                    document.getElementById('success-message').style.display = 'block';
                    document.getElementById('appointment-form').reset();
                    document.getElementById('selected-time').textContent = 'æœªé¸æ“‡æ™‚é–“æ®µ';
                    document.getElementById('conflict-warning').style.display = 'none';
                    document.getElementById('advance-warning').style.display = 'none';
                    updateLastActivityTime();
                })
                .catch(err => {
                    alert('é ç´„æäº¤å¤±æ•—ï¼š' + err.message);
                });
        });

        /***********************
         æ›´æ–°é ç´„è¡¨æ ¼ï¼ˆAdmin Tableï¼‰
        ***********************/
        function updateAppointmentsTable(){
            const tbody = document.querySelector('#appointments-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!appointments || appointments.length === 0){
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:10px;">æš«ç„¡é ç´„è¨˜éŒ„</td></tr>';
                return;
            }

            appointments.forEach(appointment => {
                let statusText = '';
                let statusClass = '';
                switch(appointment.status){
                    case 'pending': statusText='å¾…å¯©æ ¸'; statusClass='status-pending'; break;
                    case 'approved': statusText='å·²æ‰¹å‡†'; statusClass='status-approved'; break;
                    case 'rejected': statusText='å·²é§å›'; statusClass='status-rejected'; break;
                    default: statusText=appointment.status; statusClass='';
                }
                if (appointment.returned) { statusText='å·²æ­¸é‚„'; statusClass='status-returned'; }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${appointment.applicant}</td>
                    <td>${appointment.phone}</td>
                    <td>${appointment.count}å°</td>
                    <td>${formatAppointmentTime(appointment.startTime, appointment.endTime)}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn-primary view-detail-btn" data-id="${appointment.id}">æŸ¥çœ‹è©³æƒ…</button>
                        ${(!appointment.returned && appointment.status !== 'rejected') ? `<button class="btn-danger reject-btn" data-id="${appointment.id}">é§å›</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('.view-detail-btn').forEach(btn => {
                btn.addEventListener('click', function(){
                    showAppointmentDetail(this.getAttribute('data-id'));
                    updateLastActivityTime();
                });
            });
            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', function(){
                    showRejectModal(this.getAttribute('data-id'));
                    updateLastActivityTime();
                });
            });
        }

        /***********************
         æŸ¥çœ‹è©³æƒ…ã€æ‰“å°ã€é§å›è™•ç†
        ***********************/
        function showAppointmentDetail(id){
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            const modal = document.getElementById('appointment-detail-content');
            let returnChecksInfo = '';
            if (appointment.returned && appointment.returnChecks){
                const items = [];
                if (appointment.returnChecks.deviceCount) items.push('è¨­å‚™æ•¸é‡æ­£ç¢º');
                if (appointment.returnChecks.deviceCondition) items.push('è¨­å‚™å¤–è§€å®Œå¥½');
                if (appointment.returnChecks.accessories) items.push('é…ä»¶é½Šå…¨');
                if (items.length>0) returnChecksInfo = `<div class="detail-item"><div class="detail-label">æ­¸é‚„æª¢æŸ¥é …ç›®</div><div class="detail-value">${items.join('ã€')}</div></div>`;
            }
            let rejectReasonInfo = '';
            if (appointment.status === 'rejected' && appointment.rejectReason) {
                rejectReasonInfo = `<div class="detail-item"><div class="detail-label">é§å›åŸå› </div><div class="detail-value">${appointment.rejectReason}</div></div>`;
            }

            modal.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item"><div class="detail-label">ç”³è«‹äºº</div><div class="detail-value">${appointment.applicant}</div></div>
                    <div class="detail-item"><div class="detail-label">è¯ç¹«é›»è©±</div><div class="detail-value">${appointment.phone}</div></div>
                    <div class="detail-item"><div class="detail-label">iPadæ•¸é‡</div><div class="detail-value">${appointment.count}å°</div></div>
                    <div class="detail-item"><div class="detail-label">ä½¿ç”¨ç›®çš„</div><div class="detail-value">${appointment.purpose || 'ç„¡'}</div></div>
                    <div class="detail-item"><div class="detail-label">é ç´„æ™‚é–“</div><div class="detail-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div></div>
                    <div class="detail-item"><div class="detail-label">ç‹€æ…‹</div><div class="detail-value">${appointment.returned ? 'å·²æ­¸é‚„' : appointment.status === 'approved' ? 'å·²æ‰¹å‡†' : appointment.status === 'pending' ? 'å¾…å¯©æ ¸' : 'å·²é§å›'}</div></div>
                    ${rejectReasonInfo}
                    ${appointment.returned ? `
                    <div class="detail-item"><div class="detail-label">æ­¸é‚„æ™‚é–“</div><div class="detail-value">${appointment.returnTime ? new Date(appointment.returnTime).toLocaleString() : 'æœªè¨˜éŒ„'}</div></div>
                    <div class="detail-item"><div class="detail-label">æ­¸é‚„å‚™è¨»</div><div class="detail-value">${appointment.returnNotes || 'ç„¡'}</div></div>
                    ${returnChecksInfo}
                    ` : ''}
                </div>
                <div class="buttons" style="margin-top:15px;">
                    <button class="btn-secondary" id="close-detail-modal">é—œé–‰</button>
                    <button class="btn-print" id="print-detail" data-id="${appointment.id}">æ‰“å°</button>
                </div>
            `;
            document.getElementById('appointment-detail-modal').style.display = 'flex';

            document.getElementById('close-detail-modal').addEventListener('click', function(){
                document.getElementById('appointment-detail-modal').style.display = 'none';
                updateLastActivityTime();
            });

            document.getElementById('print-detail').addEventListener('click', function(){
                printAppointmentDetail(this.getAttribute('data-id'));
                updateLastActivityTime();
            });
        }

        function printAppointmentDetail(id){
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            const printDetails = document.getElementById('print-details');
            const printTime = document.getElementById('print-time');
            printTime.textContent = new Date().toLocaleString();
            let printContent = '';
            printContent += `
                <div class="print-detail-item"><div class="print-label">ç”³è«‹äºº</div><div class="print-value">${appointment.applicant}</div></div>
                <div class="print-detail-item"><div class="print-label">è¯ç¹«é›»è©±</div><div class="print-value">${appointment.phone}</div></div>
                <div class="print-detail-item"><div class="print-label">iPadæ•¸é‡</div><div class="print-value">${appointment.count}å°</div></div>
                <div class="print-detail-item"><div class="print-label">ä½¿ç”¨ç›®çš„</div><div class="print-value">${appointment.purpose || 'ç„¡'}</div></div>
                <div class="print-detail-item"><div class="print-label">é ç´„æ™‚é–“</div><div class="print-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div></div>
                <div class="print-detail-item"><div class="print-label">ç‹€æ…‹</div><div class="print-value">${appointment.returned ? 'å·²æ­¸é‚„' : appointment.status === 'approved' ? 'å·²æ‰¹å‡†' : appointment.status === 'pending' ? 'å¾…å¯©æ ¸' : 'å·²é§å›'}</div></div>
            `;
            if (appointment.status === 'rejected' && appointment.rejectReason) {
                printContent += `<div class="print-detail-item"><div class="print-label">é§å›åŸå› </div><div class="print-value">${appointment.rejectReason}</div></div>`;
            }
            if (appointment.returned) {
                printContent += `<div class="print-detail-item"><div class="print-label">æ­¸é‚„æ™‚é–“</div><div class="print-value">${appointment.returnTime ? new Date(appointment.returnTime).toLocaleString() : 'æœªè¨˜éŒ„'}</div></div><div class="print-detail-item"><div class="print-label">æ­¸é‚„å‚™è¨»</div><div class="print-value">${appointment.returnNotes || 'ç„¡'}</div></div>`;
                if (appointment.returnChecks) {
                    const checks = appointment.returnChecks;
                    const checkedItems = [];
                    if (checks.deviceCount) checkedItems.push('è¨­å‚™æ•¸é‡æ­£ç¢º');
                    if (checks.deviceCondition) checkedItems.push('è¨­å‚™å¤–è§€å®Œå¥½');
                    if (checks.accessories) checkedItems.push('é…ä»¶é½Šå…¨');
                    if (checkedItems.length > 0) printContent += `<div class="print-detail-item"><div class="print-label">æ­¸é‚„æª¢æŸ¥é …ç›®</div><div class="print-value">${checkedItems.join('ã€')}</div></div>`;
                }
            }
            printDetails.innerHTML = printContent;
            document.getElementById('print-container').style.display = 'block';
            window.print();
            document.getElementById('print-container').style.display = 'none';
        }

        function showRejectModal(id){
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            const modal = document.getElementById('reject-modal-content');
            modal.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item"><div class="detail-label">ç”³è«‹äºº</div><div class="detail-value">${appointment.applicant}</div></div>
                    <div class="detail-item"><div class="detail-label">iPadæ•¸é‡</div><div class="detail-value">${appointment.count}å°</div></div>
                    <div class="detail-item"><div class="detail-label">é ç´„æ™‚é–“</div><div class="detail-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div></div>
                </div>
                <div class="form-group"><label for="reject-reason">é§å›åŸå› </label><textarea id="reject-reason" rows="3" placeholder="è«‹è¼¸å…¥é§å›æ­¤é ç´„çš„åŸå› " required></textarea></div>
                <div class="buttons"><button class="btn-secondary" id="cancel-reject">å–æ¶ˆ</button><button class="btn-danger" id="confirm-reject" data-id="${appointment.id}">ç¢ºèªé§å›</button></div>
            `;
            document.getElementById('reject-modal').style.display = 'flex';

            document.getElementById('confirm-reject').addEventListener('click', function(){
                const appointmentId = this.getAttribute('data-id');
                const reason = document.getElementById('reject-reason').value.trim();
                if (!reason) { alert('è«‹å¡«å¯«é§å›åŸå› '); return; }
                // æ›´æ–°åˆ° Firebase
                db.ref('appointments/' + appointmentId).update({ status:'rejected', rejectReason:reason })
                    .then(()=> {
                        alert('é ç´„å·²æˆåŠŸé§å›ï¼');
                        document.getElementById('reject-modal').style.display = 'none';
                    })
                    .catch(err => alert('æ“ä½œå¤±æ•—ï¼š' + err.message));
            });

            document.getElementById('cancel-reject').addEventListener('click', function(){
                document.getElementById('reject-modal').style.display = 'none';
            });
        }

        /***********************
         æ­¸é‚„åˆ—è¡¨èˆ‡æ­¸é‚„æµç¨‹
        ***********************/
        function updateReturnList(){
            const list = document.getElementById('return-list');
            list.innerHTML = '';
            const pending = appointments.filter(a => a.status === 'approved' && !a.returned);
            if (pending.length === 0) {
                list.innerHTML = '<p style="text-align:center;padding:20px;">æš«ç„¡å¾…æ­¸é‚„è¨­å‚™</p>';
                return;
            }
            pending.forEach(appointment => {
                const item = document.createElement('div');
                item.className = 'return-item';
                item.innerHTML = `
                    <div class="return-item-header" style="display:flex;justify-content:space-between;margin-bottom:8px;"><div><strong>${appointment.applicant}</strong></div><div>${appointment.count}å°iPad</div></div>
                    <div class="return-item-details"><div>è¯ç¹«é›»è©±: ${appointment.phone}</div><div>å€Ÿç”¨æ™‚é–“: ${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div><div>ä½¿ç”¨ç›®çš„: ${appointment.purpose || 'ç„¡'}</div></div>
                    <div class="return-actions"><button class="btn-success return-btn" data-id="${appointment.id}">æ­¸é‚„ç™»è¨˜</button></div>
                `;
                list.appendChild(item);
            });

            document.querySelectorAll('.return-btn').forEach(btn => {
                btn.addEventListener('click', function(){
                    showReturnModal(this.getAttribute('data-id'));
                    updateLastActivityTime();
                });
            });
        }

        function showReturnModal(id){
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            const modal = document.getElementById('return-modal-content');
            modal.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item"><div class="detail-label">ç”³è«‹äºº</div><div class="detail-value">${appointment.applicant}</div></div>
                    <div class="detail-item"><div class="detail-label">iPadæ•¸é‡</div><div class="detail-value">${appointment.count}å°</div></div>
                    <div class="detail-item"><div class="detail-label">å€Ÿç”¨æ™‚é–“</div><div class="detail-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div></div>
                </div>
                <div class="return-check-options">
                    <div class="check-option"><input type="checkbox" id="check-device-count"><label for="check-device-count">è¨­å‚™æ•¸é‡æ­£ç¢º</label></div>
                    <div class="check-option"><input type="checkbox" id="check-device-condition"><label for="check-device-condition">è¨­å‚™å¤–è§€å®Œå¥½</label></div>
                    <div class="check-option"><input type="checkbox" id="check-accessories"><label for="check-accessories">é…ä»¶é½Šå…¨</label></div>
                </div>
                <div class="form-group"><label for="return-notes">æ­¸é‚„å‚™è¨»</label><textarea id="return-notes" rows="3" placeholder="è«‹è¼¸å…¥æ­¸é‚„å‚™è¨»ï¼ˆå¯é¸ï¼‰"></textarea></div>
                <div class="buttons"><button class="btn-secondary" id="cancel-return">å–æ¶ˆ</button><button class="btn-success" id="confirm-return" data-id="${appointment.id}">ç¢ºèªæ­¸é‚„</button></div>
            `;
            document.getElementById('return-modal').style.display = 'flex';

            document.getElementById('confirm-return').addEventListener('click', function(){
                const appointmentId = this.getAttribute('data-id');
                const checks = {
                    deviceCount: document.getElementById('check-device-count').checked,
                    deviceCondition: document.getElementById('check-device-condition').checked,
                    accessories: document.getElementById('check-accessories').checked
                };
                const notes = document.getElementById('return-notes').value.trim();
                const updateObj = {
                    returned: true,
                    returnChecks: checks,
                    returnNotes: notes,
                    returnTime: new Date().toISOString()
                };
                db.ref('appointments/' + appointmentId).update(updateObj)
                    .then(()=> {
                        alert('è¨­å‚™æ­¸é‚„ç™»è¨˜æˆåŠŸï¼');
                        document.getElementById('return-modal').style.display = 'none';
                        updateReturnList();
                        updateAppointmentsTable();
                    })
                    .catch(err => alert('æ“ä½œå¤±æ•—ï¼š' + err.message));
            });

            document.getElementById('cancel-return').addEventListener('click', function(){
                document.getElementById('return-modal').style.display = 'none';
            });
        }

        /***********************
         å·²æ‰¹å‡†é ç´„çš„æ—¥æ›†è¦–åœ–ï¼ˆå‘¨è¦–åœ–ï¼‰
        ***********************/
        function updateScheduleView(){
            const today = new Date();
            const currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7));
            const weekTitle = document.getElementById('week-title');
            const weekEnd = new Date(currentWeekStart); weekEnd.setDate(currentWeekStart.getDate()+6);
            weekTitle.textContent = `${currentWeekStart.getMonth()+1}/${currentWeekStart.getDate()} - ${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;

            const scheduleHeader = document.getElementById('schedule-header');
            scheduleHeader.innerHTML = '<div class="time-header-cell">æ™‚é–“</div>';
            for (let i=0;i<7;i++){
                const day = new Date(currentWeekStart);
                day.setDate(currentWeekStart.getDate()+i);
                const dayNames = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];
                const headerCell = document.createElement('div');
                headerCell.className = 'time-header-cell';
                headerCell.textContent = `${dayNames[day.getDay()]} ${day.getMonth()+1}/${day.getDate()}`;
                scheduleHeader.appendChild(headerCell);
            }

            const timeSlotsContainer = document.getElementById('time-slots-container');
            timeSlotsContainer.innerHTML = '';
            for (let hour=8; hour<=18; hour++){
                for (let minute of [0,30]){
                    if (hour===18 && minute===30) continue;
                    const timeSlotRow = document.createElement('div');
                    timeSlotRow.className = 'time-slot-row';
                    timeSlotRow.style.display = 'grid';
                    timeSlotRow.style.gridTemplateColumns = '60px repeat(7,1fr)';
                    timeSlotRow.style.height = '30px';
                    timeSlotRow.style.borderBottom = '1px solid #f0f0f0';

                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'time-label';
                    timeLabel.textContent = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
                    timeSlotRow.appendChild(timeLabel);

                    for (let i=0;i<7;i++){
                        const day = new Date(currentWeekStart);
                        day.setDate(currentWeekStart.getDate()+i);
                        const timeCell = document.createElement('div');
                        timeCell.className = 'time-cell';
                        timeCell.setAttribute('data-date', day.toISOString().split('T')[0]);
                        timeCell.setAttribute('data-time', `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`);
                        timeSlotRow.appendChild(timeCell);
                    }
                    timeSlotsContainer.appendChild(timeSlotRow);
                }
            }

            // æ·»åŠ  appointment blocks
            appointments.forEach(appointment => {
                if (appointment.status !== 'approved') return;
                const startTime = new Date(appointment.startTime);
                const endTime = new Date(appointment.endTime);
                const weekStart = new Date(currentWeekStart); weekStart.setHours(0,0,0,0);
                const weekEndDate = new Date(weekStart); weekEndDate.setDate(weekStart.getDate() + 7);
                if (startTime >= weekEndDate || endTime <= weekStart) return;

                // day index relative to weekStart
                const dayIndex = (startTime.getDay() + 7 - weekStart.getDay()) % 7;
                const startMinutes = startTime.getHours()*60 + startTime.getMinutes();
                const endMinutes = endTime.getHours()*60 + endTime.getMinutes();
                const top = ((startMinutes - 8*60) / 30) * 30;
                const height = Math.max(((endMinutes - startMinutes) / 30) * 30, 20);

                // create block
                const block = document.createElement('div');
                block.className = 'appointment-block';
                block.style.backgroundColor = appointment.color || getRandomColor();
                block.style.position = 'absolute';
                block.style.left = `${(dayIndex) * (100/7)}%`; // simpler placement
                block.style.width = `calc((100% - 60px) / 7 - 4px)`;
                block.style.top = `${top}px`;
                block.style.height = `${height}px`;
                block.style.borderRadius = '3px';
                block.style.padding = '2px';
                block.style.color = 'white';
                block.style.fontSize = '9px';
                block.style.overflow='hidden';
                block.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
                block.innerHTML = `<div class="appointment-info">${appointment.applicant}</div><div class="appointment-time">${String(startTime.getHours()).padStart(2,'0')}:${String(startTime.getMinutes()).padStart(2,'0')}-${String(endTime.getHours()).padStart(2,'0')}:${String(endTime.getMinutes()).padStart(2,'0')}</div>`;

                // append to container (positioning is simplified: put relative container)
                document.getElementById('time-slots-container').appendChild(block);
            });
        }

        /***********************
         Admin: ç™»å½• & è®¾ç½®ä¿®æ”¹
        ***********************/
        // ç®¡ç†å‘˜é“¾æ¥ç‚¹å‡»
        document.getElementById('admin-link').addEventListener('click', function(e){
            e.preventDefault();
            if (isAdminLoggedIn) {
                showAdminPage();
            } else {
                showPage('login-page');
            }
            updateLastActivityTime();
        });

        function showAdminPage(){
            showPage('admin-page');
            updateAppointmentsTable();
        }

        // ç™»å½•æäº¤
        document.getElementById('login-form').addEventListener('submit', function(e){
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            if (username === 'admin' && password === adminPassword) {
                isAdminLoggedIn = true;
                updateLastActivityTime();
                setupAutoLogout();
                loginError.style.display = 'none';
                showAdminPage();
            } else {
                loginError.style.display = 'block';
            }
        });

        // tabs åˆ‡æ›
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function(){
                document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
                this.classList.add('active');
                const tabName = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
                document.getElementById(tabName + '-tab') ? document.getElementById(tabName + '-tab').style.display = 'block' : null;
                // for old layout: qrcode tab id was qrcode-tab etc.
                if (tabName === 'qrcode') {
                    document.getElementById('qrcode-tab').style.display = 'block';
                }
                updateLastActivityTime();
            });
        });

        // ä¿å­˜è®¾ç½®åˆ° Firebase
        document.getElementById('save-settings').addEventListener('click', function(){
            const adv = parseInt(document.getElementById('advance-days').value) || 3;
            const adminPhone = document.getElementById('admin-phone').value.trim();
            systemSettings.advanceDays = adv;
            systemSettings.adminPhone = adminPhone;
            settingsRef.update({ advanceDays: adv, adminPhone: adminPhone })
                .then(()=> alert('è¨­ç½®å·²ä¿å­˜'))
                .catch(err => alert('ä¿å­˜å¤±æ•—ï¼š' + err.message));
            updateLastActivityTime();
        });

        // ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ï¼ˆå†™å…¥ settings.adminPasswordï¼‰
        document.getElementById('change-password').addEventListener('click', function(){
            const cur = document.getElementById('current-password').value;
            const nw = document.getElementById('new-password').value;
            const cf = document.getElementById('confirm-password').value;
            if (cur !== adminPassword) { alert('ç•¶å‰å¯†ç¢¼éŒ¯èª¤'); return; }
            if (!nw || nw !== cf) { alert('æ–°å¯†ç¢¼ä¸ä¸€è‡´æˆ–ç‚ºç©º'); return; }
            adminPassword = nw;
            settingsRef.update({ adminPassword: adminPassword })
                .then(()=> alert('å¯†ç¢¼å·²ä¿®æ”¹'))
                .catch(err => alert('ä¿®æ”¹å¤±æ•—ï¼š' + err.message));
        });

        /***********************
         Admin æ“ä½œï¼šåˆ·æ–°ã€æ¸…ç©º
        ***********************/
        document.getElementById('refresh-appointments').addEventListener('click', function(){
            // ç”±äºæˆ‘ä»¬ä½¿ç”¨å®æ—¶ç›‘å¬ï¼Œåˆ·æ–°å°±æ˜¯é‡æ–°è¯»å– snapshotï¼ˆè°ƒç”¨ä¸€æ¬¡ getï¼‰
            appointmentsRef.once('value').then(snap => {
                // handled by listener already; just give feedback
                alert('å·²åˆ·æ–°æ•¸æ“š');
            }).catch(err => alert('åˆ·æ–°å¤±æ•—ï¼š' + err.message));
            updateLastActivityTime();
        });

        document.getElementById('clear-all-appointments').addEventListener('click', function(){
            if (!confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰é ç´„è¨˜éŒ„ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·')) return;
            appointmentsRef.remove().then(()=> {
                alert('å·²æ¸…ç©ºæ‰€æœ‰é ç´„è¨˜éŒ„');
            }).catch(err => alert('æ“ä½œå¤±æ•—ï¼š' + err.message));
            updateLastActivityTime();
        });

        /***********************
         é¡µé¢å¯¼èˆªæŒ‰é’®
        ***********************/
        document.getElementById('go-to-appointment').addEventListener('click', ()=> { showPage('appointment-page'); document.getElementById('success-message').style.display='none'; updateLastActivityTime(); });
        document.getElementById('go-to-schedule').addEventListener('click', ()=> { showPage('schedule-page'); updateScheduleView(); updateLastActivityTime(); });
        document.getElementById('go-to-return').addEventListener('click', ()=> {
            if (!isAdminLoggedIn) { showPage('login-page'); }
            else { showPage('return-page'); updateReturnList(); }
            updateLastActivityTime();
        });
        document.getElementById('back-to-home').addEventListener('click', ()=> { showPage('home-page'); updateLastActivityTime(); });
        document.getElementById('back-to-home-from-schedule').addEventListener('click', ()=> { showPage('home-page'); updateLastActivityTime(); });
        document.getElementById('back-to-home-from-return').addEventListener('click', ()=> { showPage('home-page'); updateLastActivityTime(); });
        document.getElementById('back-to-home-from-login').addEventListener('click', ()=> { showPage('home-page'); updateLastActivityTime(); });
        document.getElementById('back-to-home-admin').addEventListener('click', ()=> { showPage('home-page'); updateLastActivityTime(); });
        document.getElementById('back-from-qrcode').addEventListener('click', ()=> { document.getElementById('qrcode-tab').style.display='none'; });

        // login modal close handlers
        document.getElementById('close-return-modal').addEventListener('click', ()=> { document.getElementById('return-modal').style.display='none'; });
        document.getElementById('close-appointment-detail-modal').addEventListener('click', ()=> { document.getElementById('appointment-detail-modal').style.display='none'; });
        document.getElementById('close-reject-modal').addEventListener('click', ()=> { document.getElementById('reject-modal').style.display='none'; });

        // week nav
        document.getElementById('prev-week').addEventListener('click', ()=> { currentWeekOffset--; updateScheduleView(); });
        document.getElementById('next-week').addEventListener('click', ()=> { currentWeekOffset++; updateScheduleView(); });

        function showPage(id){
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        /***********************
         åˆ é™¤é¢„çº¦ï¼ˆä» Firebase åˆ é™¤ï¼‰
        ***********************/
        function deleteAppointmentById(id){
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é ç´„ï¼Ÿ')) return;
            db.ref('appointments/' + id).remove().catch(err => alert('åˆªé™¤å¤±æ•—ï¼š' + err.message));
        }

        // å°†é¡µé¢ä¸Šçš„â€œåˆ é™¤â€æŒ‰é’®ç”¨æ›´é€šç”¨çš„å‡½æ•°
        function deleteAppointment(id){
            deleteAppointmentById(id);
        }

        /***********************
         åˆå§‹åŒ– QRCodeï¼ˆç®¡ç†é¡µï¼‰
        ***********************/
        // ç”Ÿæˆç®€å•äºŒç»´ç ï¼ˆé“¾æ¥åˆ°å½“å‰é¡µé¢ï¼‰
        function renderQRCode(){
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            QRCode.toCanvas(qrcodeDiv, location.href, { width:200 }, function (error) {
                // QRCode library ä½¿ç”¨ canvas
            });
        }
        renderQRCode();

        /***********************
         åˆå§‹ç•Œé¢é…ç½®
        ***********************/
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°æ˜¾ç¤º
        updateAppointmentsTable();
        updateReturnList();
        updateScheduleView();
        updateLastActivityTime();
        setupAutoLogout();

        /***********************
         å°† deleteAppointment æš´éœ²ä¸ºå…¨å±€ï¼ˆç”¨äºè¡¨æ ¼æ“ä½œï¼‰
        ***********************/
        window.deleteAppointment = deleteAppointment;

        /***********************
         å…¼å®¹ï¼šåœ¨ç®¡ç†è¡¨æ ¼ä¸­ç»™åˆ é™¤æŒ‰é’®ä½¿ç”¨ deleteAppointment
         æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ updateAppointmentsTable é‡Œæ˜¾ç¤ºçš„æ˜¯â€œæŸ¥çœ‹/é§å›â€ï¼Œé¡µé¢å…¶å®ƒåœ°æ–¹å¯èƒ½éœ€è¦åˆ é™¤æŒ‰é’® â€”â€” ä½ å¯ä»¥åœ¨éœ€è¦çš„ä½ç½®è°ƒç”¨ deleteAppointment(id)
        ***********************/
    </script>
</body>
</html>
