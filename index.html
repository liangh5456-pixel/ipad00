<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iPad 設備借還系統（Firebase 版）</title>

  <!-- QRCode lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Microsoft JhengHei',sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:15px}
    .container{width:100%;max-width:1000px;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden;margin-bottom:20px}
    header{background:linear-gradient(90deg,#3498db,#2c3e50);color:#fff;padding:15px;text-align:center;position:relative}
    h1{font-size:20px;margin-bottom:8px} .subtitle{font-size:12px;opacity:.9}
    .content{padding:20px}
    .page{display:none} .active{display:block}
    button{padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-size:14px}
    .btn-primary{background:#3498db;color:#fff} .btn-secondary{background:#e0e0e0} .btn-danger{background:#e74c3c;color:#fff} .btn-success{background:#27ae60;color:#fff}
    .home-buttons{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin:20px 0}
    .home-btn{width:140px;height:140px;border-radius:50%;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;cursor:pointer;box-shadow:0 8px 15px rgba(0,0,0,.15)}
    .home-btn span{font-weight:700}
    .appointment-btn{background:linear-gradient(135deg,#3498db,#2c3e50)}
    .view-schedule-btn{background:linear-gradient(135deg,#2ecc71,#27ae60)}
    .return-btn{background:linear-gradient(135deg,#f39c12,#e67e22)}
    .progress-bar{width:100%;height:6px;background:#eee;border-radius:4px;margin-top:6px;overflow:hidden}
    .progress-bar-inner{height:100%;width:0;background:#27ae60;transition:width 0.3s}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>iPad 設備借還系統（Firebase）</h1>
    <div class="subtitle">便捷預約，高效管理</div>
    <a id="admin-link" href="#" style="position:absolute;right:16px;top:16px;color:#fff;text-decoration:none;font-weight:700">管理員</a>
  </header>

  <div class="content">
    <!-- 首頁 -->
    <div id="home-page" class="page active">
      <h2>歡迎使用 iPad 借還系統</h2>
      <div class="home-buttons">
        <div class="home-btn appointment-btn" id="go-to-appointment"><span>設備預約</span></div>
        <div class="home-btn view-schedule-btn" id="go-to-schedule"><span>已預約時段</span></div>
        <div class="home-btn return-btn" id="go-to-return"><span>歸還登記</span></div>
      </div>
    </div>

    <!-- 預約頁 -->
    <div id="appointment-page" class="page">
      <h2>iPad 設備預約</h2>
      <form id="appointment-form">
        <label>申請人<input id="applicant" required></label>
        <label>聯絡電話<input id="applicant-phone" required></label>
        <label>iPad 數量<select id="ipad-count"></select></label>
        <label>用途<textarea id="purpose"></textarea></label>
        <label>開始時間<input type="datetime-local" id="start-time"></label>
        <label>結束時間<input type="datetime-local" id="end-time"></label>
        <div style="margin-top:10px"><button class="btn-primary" type="submit">提交</button><button class="btn-secondary" type="button" id="back-home1">返回</button></div>
      </form>
    </div>

    <!-- 歸還頁 -->
    <div id="return-page" class="page">
      <h2>設備歸還登記</h2>
      <div id="return-list"></div>
      <button class="btn-secondary" id="back-home2">返回首頁</button>
    </div>

    <!-- 管理登入 -->
    <div id="login-page" class="page">
      <h2>管理員登入</h2>
      <form id="login-form">
        <label>Email<input id="login-email" type="email" required></label>
        <label>密碼<input id="login-password" type="password" required></label>
        <div style="margin-top:10px"><button class="btn-primary" type="submit">登入</button><button class="btn-secondary" id="back-home3" type="button">返回首頁</button></div>
      </form>
      <div id="login-error" style="color:#e74c3c;display:none;margin-top:8px"></div>
    </div>

    <!-- 管理頁 -->
    <div id="admin-page" class="page">
      <h2>預約管理</h2>
      <button id="logout-btn" class="btn-danger">登出</button>
      <table id="admin-table" border="1" style="width:100%;margin-top:10px;border-collapse:collapse">
        <thead><tr><th>申請人</th><th>電話</th><th>時間</th><th>狀態</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 歸還確認模態 -->
<div id="return-modal" class="modal-overlay" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
  <div class="modal-content" style="background:#fff;padding:16px;border-radius:8px;max-width:500px;width:90%">
    <h3>設備歸還確認</h3>
    <div id="return-modal-body"></div>
  </div>
</div>

<script>
/* === Firebase 初始化 === */
const firebaseConfig = {
  apiKey: "AIzaSyAyHaxW3X-ksmb7AZCeeGO2E2qoLjiCsB4",
  authDomain: "ipad-booking-e3a24.firebaseapp.com",
  databaseURL: "https://ipad-booking-e3a24-default-rtdb.firebaseio.com",
  projectId: "ipad-booking-e3a24",
  storageBucket: "ipad-booking-e3a24.firebasestorage.app",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();
const auth = firebase.auth();
const appointmentsRef = db.ref("appointments");

let currentUser = null;
let appointments = [];

auth.onAuthStateChanged(u=>{
  currentUser=u;
  if(u){showPage("admin-page");loadAppointments();}
  else showPage("login-page");
});

/* === 頁面控制 === */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
document.getElementById("go-to-appointment").onclick=()=>showPage("appointment-page");
document.getElementById("go-to-return").onclick=()=>showPage("return-page");
document.getElementById("go-to-schedule").onclick=()=>alert("此版本暫未啟用週曆檢視");
document.getElementById("back-home1").onclick=document.getElementById("back-home2").onclick=document.getElementById("back-home3").onclick=()=>showPage("home-page");
document.getElementById("admin-link").onclick=(e)=>{e.preventDefault();auth.currentUser?showPage("admin-page"):showPage("login-page");};
document.getElementById("logout-btn").onclick=()=>auth.signOut();

/* === 登入 === */
document.getElementById("login-form").addEventListener("submit",e=>{
  e.preventDefault();
  const email=document.getElementById("login-email").value;
  const pwd=document.getElementById("login-password").value;
  auth.signInWithEmailAndPassword(email,pwd).catch(err=>{
    document.getElementById("login-error").textContent=err.message;
    document.getElementById("login-error").style.display="block";
  });
});

/* === 預約提交 === */
function fillIpadCount(){
  const sel=document.getElementById("ipad-count");
  sel.innerHTML="<option value=''>請選擇</option>";
  for(let i=1;i<=48;i++){const o=document.createElement("option");o.value=i;o.text=i+"台";sel.appendChild(o);}
}
fillIpadCount();

document.getElementById("appointment-form").addEventListener("submit",e=>{
  e.preventDefault();
  const a={
    applicant:document.getElementById("applicant").value.trim(),
    phone:document.getElementById("applicant-phone").value.trim(),
    count:document.getElementById("ipad-count").value,
    purpose:document.getElementById("purpose").value,
    startTime:document.getElementById("start-time").value,
    endTime:document.getElementById("end-time").value,
    status:"approved",
    returned:false
  };
  appointmentsRef.push(a).then(()=>{alert("預約已提交");showPage("home-page");});
});

/* === 歸還列表 === */
appointmentsRef.on("value",snap=>{
  appointments=[];
  const data=snap.val()||{};
  for(let k in data){appointments.push({...data[k],id:k});}
  renderReturnList();
  renderAdminTable();
});

function renderReturnList(){
  const list=document.getElementById("return-list");
  const unreturned=appointments.filter(a=>a.status==="approved"&&!a.returned);
  if(unreturned.length===0){list.innerHTML="<p>暫無待歸還設備</p>";return;}
  list.innerHTML="";
  unreturned.forEach(a=>{
    const div=document.createElement("div");
    div.innerHTML=`<div><b>${a.applicant}</b> (${a.count}台)</div><div>${a.phone}</div><button class="btn-success" data-id="${a.id}">歸還</button>`;
    div.querySelector("button").onclick=()=>showReturnModal(a.id);
    list.appendChild(div);
  });
}

/* === 歸還模態 === */
function showReturnModal(id){
  const a=appointments.find(x=>x.id===id);
  if(!a)return;
  const body=document.getElementById("return-modal-body");
  body.innerHTML=`
  <p>申請人：${a.applicant}</p>
  <label><input type="checkbox" id="chk1"> 設備數量正確</label><br>
  <label><input type="checkbox" id="chk2"> 設備外觀完好</label><br>
  <label><input type="checkbox" id="chk3"> 配件齊全</label>
  <br><textarea id="return-notes" placeholder="備註" style="width:100%;margin-top:8px"></textarea>
  <input id="return-photos" type="file" accept="image/*" multiple style="margin-top:8px"/>
  <div class="progress-bar"><div class="progress-bar-inner" id="upload-progress"></div></div>
  <div style="margin-top:10px"><button class="btn-success" id="confirm-return">確認歸還</button>
  <button class="btn-secondary" id="cancel-return">取消</button></div>`;
  document.getElementById("return-modal").style.display="flex";

  document.getElementById("cancel-return").onclick=()=>document.getElementById("return-modal").style.display="none";
  document.getElementById("confirm-return").onclick=async()=>{
    if(!chk1.checked||!chk2.checked||!chk3.checked){alert("請勾選所有檢查項目");return;}
    const notes=document.getElementById("return-notes").value;
    const files=Array.from(document.getElementById("return-photos").files||[]);
    const urls=[];
    const progress=document.getElementById("upload-progress");
    let count=0;
    for(const f of files){
      const path=`returns/${id}/${Date.now()}_${f.name}`;
      const ref=storage.ref().child(path);
      const uploadTask=ref.put(f);
      await new Promise((res,rej)=>{
        uploadTask.on("state_changed",snap=>{
          progress.style.width=((++count)/files.length*100)+"%";
        },rej,async()=>{
          urls.push(await ref.getDownloadURL());res();
        });
      });
    }
    await appointmentsRef.child(id).update({
      returned:true,
      returnNotes:notes,
      returnChecks:{deviceCount:true,deviceCondition:true,accessories:true},
      returnPhotos:urls
    });
    alert("歸還完成");
    document.getElementById("return-modal").style.display="none";
  };
}

/* === 管理表 === */
function renderAdminTable(){
  const tb=document.querySelector("#admin-table tbody");
  tb.innerHTML="";
  appointments.forEach(a=>{
    if(a.returned)return; // 不顯示已歸還
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${a.applicant}</td><td>${a.phone}</td><td>${a.startTime}~${a.endTime}</td><td>${a.status}</td>`;
    tb.appendChild(tr);
  });
}
function loadAppointments(){appointmentsRef.once("value");}
</script>
</body>
</html>
