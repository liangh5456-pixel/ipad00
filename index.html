<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iPadè®¾å¤‡é¢„çº¦ç³»ç»Ÿï¼ˆFirebase ç‰ˆï¼‰</title>

  <!-- QRCode lib (ç”¨äºç”ŸæˆäºŒç»´ç ) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Firebase compat SDKs: app, auth, database, storage -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <style>
    /* ========== åŸºæœ¬æ ·å¼ï¼ˆä¿ç•™å’Œå…¼å®¹ä½ åŸæ¥çš„ UIï¼‰ ========== */
    *{box-sizing:border-box;margin:0;padding:0;font-family:'PingFang SC','Microsoft YaHei',sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:15px}
    .container{width:100%;max-width:1000px;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden;margin-bottom:20px}
    header{background:linear-gradient(90deg,#3498db,#2c3e50);color:#fff;padding:15px;text-align:center;position:relative}
    h1{font-size:20px;margin-bottom:8px} .subtitle{font-size:12px;opacity:.9}
    .content{padding:20px}
    .page{display:none} .active{display:block}

    /* æŒ‰é’®å’Œè¡¨å• */
    .buttons{display:flex;justify-content:space-between;margin-top:15px;gap:10px}
    button{padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-size:14px}
    .btn-primary{background:#3498db;color:#fff} .btn-secondary{background:#e0e0e0} .btn-danger{background:#e74c3c;color:#fff}
    .btn-success{background:#27ae60;color:#fff} .btn-print{background:#7d3c98;color:#fff}

    .form-group{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#2c3e50}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    input:focus,select:focus,textarea:focus{border-color:#3498db;outline:none}

    .success-message{background:#d4edda;color:#155724;padding:10px;border-radius:6px;margin-bottom:10px;display:none}

    /* é¦–é¡µæŒ‰é’® */
    .home-buttons{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin:20px 0}
    .home-btn{width:140px;height:140px;border-radius:50%;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;cursor:pointer;box-shadow:0 8px 15px rgba(0,0,0,.15);text-align:center}
    .home-btn i{font-size:36px;margin-bottom:8px} .home-btn span{font-weight:700}
    .appointment-btn{background:linear-gradient(135deg,#3498db,#2c3e50)} .view-schedule-btn{background:linear-gradient(135deg,#2ecc71,#27ae60)} .return-btn{background:linear-gradient(135deg,#f39c12,#e67e22)}

    /* ç®¡ç†é¡µè¡¨æ ¼ */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    th{background:#f8f9fa;font-weight:700;color:#2c3e50}

    .status{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:700}
    .status-approved{background:#d1ecf1;color:#0c5460} .status-pending{background:#fff3cd;color:#856404}
    .status-rejected{background:#f8d7da;color:#721c24} .status-returned{background:#d4edda;color:#155724}

    /* æ¨¡æ€ */
    .modal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:2000}
    .modal-content{background:#fff;padding:18px;border-radius:8px;width:92%;max-width:520px;max-height:85vh;overflow:auto}
    .close-modal{background:none;border:none;font-size:20px;cursor:pointer;color:#7f8c8d}

    /* æ—¥å†æ ·å¼ï¼ˆå‘¨è§†å›¾ï¼‰ */
    .schedule-wrapper{border:1px solid #eaeef2;border-radius:6px;overflow:hidden}
    .week-header{display:grid;grid-template-columns:60px repeat(7,1fr);background:#f8f9fa}
    .week-header .time-label{padding:8px;border-right:1px solid #eaeef2;font-weight:700;text-align:center}
    .week-header .day-cell{padding:8px;text-align:center;border-left:1px solid #eaeef2;font-weight:700}
    /* grid å®¹å™¨ï¼šè‡ªåŠ¨è¡Œé«˜30px */
    .grid-container{position:relative;display:grid;grid-template-columns:60px repeat(7,1fr);grid-auto-rows:30px}
    .grid-time-cell{padding:6px;text-align:right;padding-right:10px;border-bottom:1px solid #f1f4f7;border-right:1px solid #eaeef2;font-size:12px;color:#666}
    .grid-day-cell{border-bottom:1px solid #f1f4f7;border-right:1px solid #eaeef2;position:relative}
    /* é¢„çº¦å—ä½¿ç”¨ grid-row / grid-column */
    .appointment-block{position:relative;border-radius:3px;padding:4px 6px;font-size:11px;color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.12);overflow:hidden}
    .appointment-info{font-weight:700;font-size:12px}
    .appointment-time{font-size:10px;opacity:.9}

    /* æ—¶é—´é€‰é¡¹ä¸å¯ç‚¹å‡»æ—¶æ˜¾ç¤ºç°è‰² */
    select option.disabled-opt { color:#999; background:#f3f3f3; }
    select option[disabled] { color:#999; }

    /* Return UI è°ƒæ•´ */
    .return-item{padding:12px;border:1px solid #e6eaee;border-radius:6px;margin-bottom:10px;background:#fbfcfd}
    .return-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .return-item-details{font-size:13px;color:#666;margin-bottom:8px}
    .return-actions{display:flex;gap:8px}
    .return-photos-container{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{width:80px;height:80px;border-radius:6px;object-fit:cover;border:1px solid #ddd}

    /* ä¸Šä¼ è¿›åº¦ */
    .file-wrap{position:relative;display:inline-block;margin-right:8px}
    .progress{width:80px;height:6px;background:#eee;border-radius:4px;margin-top:6px;overflow:hidden}
    .progress > i{display:block;height:100%;width:0%;background:#3498db}

    /* æ¸…ç©ºç¡®è®¤å¼¹çª— */
    .confirm-clear { display:flex;flex-direction:column;gap:10px }

    @media (max-width:720px){
      .home-buttons{gap:12px}
      .home-btn{width:120px;height:120px}
      .grid-container{grid-auto-rows:28px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>iPadè®¾å¤‡é¢„çº¦ç³»ç»Ÿï¼ˆFirebaseï¼‰</h1>
      <div class="subtitle">ä¾¿æ·é¢„çº¦ï¼Œé«˜æ•ˆç®¡ç†</div>
      <a id="admin-link" href="#" style="position:absolute;right:16px;top:16px;color:#fff;text-decoration:none;font-weight:700">ç®¡ç†å“¡</a>
    </header>

    <div class="content">
      <!-- Home -->
      <div id="home-page" class="page active">
        <h2>æ¬¢è¿ä½¿ç”¨ iPad é¢„çº¦ç³»ç»Ÿ</h2>
        <div class="home-buttons">
          <div class="home-btn appointment-btn" id="go-to-appointment"><i>ğŸ“±</i><span>è®¾å¤‡é¢„çº¦</span></div>
          <div class="home-btn view-schedule-btn" id="go-to-schedule"><i>ğŸ“…</i><span>å·²é¢„çº¦æ—¶æ®µ</span></div>
          <div class="home-btn return-btn" id="go-to-return"><i>ğŸ“‹</i><span>å½’è¿˜ç™»è®°</span></div>
        </div>
        <div style="text-align:center;color:#7f8c8d">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹é¢„çº¦æˆ–ç®¡ç†è®¾å¤‡</div>
      </div>

      <!-- Appointment Page -->
      <div id="appointment-page" class="page">
        <h2>iPadè®¾å¤‡é¢„çº¦</h2>
        <div class="success-message" id="success-message">é¢„çº¦å·²æäº¤ï¼ˆå¦‚å¯ç”¨å®¡æ ¸åˆ™ç­‰å¾…å®¡æ ¸ï¼‰</div>

        <!-- å¦‚æœå¸Œæœ›ç”¨æˆ·é€šè¿‡å¾®ä¿¡ç»‘å®šåé¢„çº¦ï¼Œä¸‹é¢ä¼šå°è¯•è¯»å–æœ¬åœ° wechatId -->
        <div style="margin-bottom:8px;color:#6c757d">è¯·å…ˆç”¨å¾®ä¿¡ç™»å½•å¹¶ç»‘å®šï¼ˆå¦‚æœéœ€è¦ç»‘å®šï¼Œè¯·ç‚¹å‡»ä¸‹é¢æŒ‰é’®ï¼‰ï¼š
          <button id="wechat-login-btn" class="btn-primary" style="margin-left:8px">å¾®ä¿¡ç™»å½•å¹¶ç»‘å®š</button>
        </div>

        <form id="appointment-form">
          <div class="form-group">
            <label for="applicant">ç”³è¯·äºº</label>
            <input id="applicant" type="text" placeholder="è¯·è¾“å…¥å§“å" required />
          </div>

          <div class="form-group">
            <label for="applicant-phone">è”ç³»ç”µè¯</label>
            <input id="applicant-phone" type="tel" placeholder="11ä½æ‰‹æœºå·" pattern="[0-9]{11}" maxlength="11" required />
          </div>

          <div class="form-group">
            <label for="ipad-count">ç”³è¯· iPad æ•°é‡</label>
            <select id="ipad-count" required><option value="">è¯·é€‰æ‹©æ•°é‡</option></select>
          </div>

          <div class="form-group">
            <label for="purpose">ä½¿ç”¨ç›®çš„</label>
            <textarea id="purpose" rows="3" placeholder="ç®€è¦è¯´æ˜ç”¨é€”"></textarea>
          </div>

          <div class="time-selector">
            <div class="form-group" style="display:flex;gap:12px;flex-wrap:wrap">
              <div style="flex:1;min-width:160px">
                <label for="start-date">å¼€å§‹æ—¥æœŸ</label>
                <input id="start-date" type="date" required />
              </div>
              <div style="flex:1;min-width:160px">
                <label for="start-time">å¼€å§‹æ—¶é—´</label>
                <select id="start-time" required><option value="">è¯·é€‰æ‹©å¼€å§‹æ—¶é—´</option></select>
              </div>
              <div style="flex:1;min-width:160px">
                <label for="end-date">ç»“æŸæ—¥æœŸ</label>
                <input id="end-date" type="date" required />
              </div>
              <div style="flex:1;min-width:160px">
                <label for="end-time">ç»“æŸæ—¶é—´</label>
                <select id="end-time" required><option value="">è¯·é€‰æ‹©ç»“æŸæ—¶é—´</option></select>
              </div>
            </div>
            <div style="margin-top:10px;">
              <div id="selected-time" style="font-size:14px;color:#333">æœªé€‰æ‹©æ—¶é—´æ®µ</div>
              <div id="conflict-warning" style="display:none;margin-top:6px;padding:8px;background:#f8d7da;color:#721c24;border-radius:6px"></div>
              <div id="advance-warning" style="display:none;margin-top:6px;padding:8px;background:#fff3cd;color:#856404;border-radius:6px"></div>
            </div>
          </div>

          <div class="buttons" style="margin-top:18px">
            <button type="button" id="back-to-home" class="btn-secondary">è¿”å›é¦–é¡µ</button>
            <button type="submit" id="submit-btn" class="btn-primary">æäº¤é¢„çº¦</button>
          </div>
        </form>
      </div>

      <!-- Schedule Page (å‘¨è§†å›¾) -->
      <div id="schedule-page" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2>å·²é¢„çº¦æ—¶æ®µ</h2>
          <div style="display:flex;gap:10px;align-items:center">
            <button id="prev-week" class="btn-secondary">â†</button>
            <div id="week-title" style="font-weight:700"></div>
            <button id="next-week" class="btn-secondary">â†’</button>
            <button id="back-to-home-from-schedule" class="btn-secondary">è¿”å›é¦–é¡µ</button>
          </div>
        </div>

        <div class="schedule-wrapper">
          <div class="week-header" id="week-header"></div>
          <!-- grid å®¹å™¨ï¼šgrid-auto-rows:30px -->
          <div id="calendar-grid" class="grid-container" style="position:relative"></div>
        </div>
      </div>

      <!-- Return Page -->
      <div id="return-page" class="page">
        <h2>è®¾å¤‡å½’è¿˜ç™»è®°</h2>
        <div id="return-list" style="margin-top:12px"></div>
        <div style="margin-top:12px">
          <button id="back-to-home-from-return" class="btn-secondary">è¿”å›é¦–é¡µ</button>
        </div>
      </div>

      <!-- Login Pageï¼ˆç®¡ç†å‘˜ï¼šä½¿ç”¨ Firebase Authï¼‰ -->
      <div id="login-page" class="page">
        <h2>ç®¡ç†å‘˜ç™»å½•ï¼ˆFirebase Authï¼‰</h2>
        <form id="login-form" style="max-width:360px;margin:10px auto">
          <div class="form-group"><label for="admin-email">é‚®ç®±</label><input id="admin-email" type="email" required placeholder="ç®¡ç†å‘˜é‚®ç®±" /></div>
          <div class="form-group"><label for="admin-password">å¯†ç </label><input id="admin-password" type="password" required /></div>
          <div id="login-error" style="display:none;color:#e74c3c;margin-bottom:8px">ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±ä¸å¯†ç </div>
          <div class="buttons"><button type="button" id="back-to-home-from-login" class="btn-secondary">è¿”å›é¦–é¡µ</button><button type="submit" class="btn-primary">ç™»å½•</button></div>
        </form>
      </div>

      <!-- Admin Page -->
      <div id="admin-page" class="page">
        <h2>é¢„çº¦ç®¡ç†åå°</h2>
        <div style="display:flex;gap:12px;border-bottom:1px solid #eaeef2;margin-bottom:12px">
          <div style="padding:8px 12px;background:#f8f9fa;border-radius:6px">ç®¡ç†å‘˜ï¼š<span id="admin-email-display">æœªçŸ¥</span></div>
          <button id="admin-logout" class="btn-secondary">ç™»å‡º</button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="display:flex;gap:8px">
            <button id="refresh-appointments" class="btn-primary">åˆ·æ–°æ•°æ®</button>
            <button id="clear-all-appointments" class="btn-danger">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
          </div>
          <div><button id="back-to-home-admin" class="btn-secondary">è¿”å›é¦–é¡µ</button></div>
        </div>

        <table id="appointments-table">
          <thead><tr><th>ç”³è¯·äºº</th><th>è”ç³»ç”µè¯</th><th>iPadæ•°é‡</th><th>å€Ÿç”¨æ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- è¿”å›æ¨¡æ€ -->
  <div id="return-modal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>è®¾å¤‡å½’è¿˜ç¡®è®¤</h3>
        <button class="close-modal" id="close-return-modal">Ã—</button>
      </div>
      <div id="return-modal-body"></div>
    </div>
  </div>

  <!-- é¢„çº¦è¯¦æƒ…æ¨¡æ€ -->
  <div id="appointment-detail-modal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>é¢„çº¦è¯¦æƒ…</h3>
        <button class="close-modal" id="close-appointment-detail-modal">Ã—</button>
      </div>
      <div id="appointment-detail-body"></div>
    </div>
  </div>

  <!-- æ¸…ç©ºç¡®è®¤å¯†ç æ¨¡æ€ -->
  <div id="clear-confirm-modal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <h3>è¯·è¾“å…¥ç¡®è®¤å¯†ç ä»¥æ¸…ç©ºæ‰€æœ‰è®°å½•</h3>
      <div class="confirm-clear" style="margin-top:12px">
        <input id="clear-confirm-input" type="password" placeholder="è¯·è¾“å…¥ç¡®è®¤å¯†ç " />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="clear-confirm-cancel" class="btn-secondary">å–æ¶ˆ</button>
          <button id="clear-confirm-ok" class="btn-danger">ç¡®è®¤æ¸…ç©º</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== Firebase åˆå§‹åŒ–ï¼ˆä½¿ç”¨ä½ æä¾›çš„é…ç½®ï¼‰ ==================
   æ³¨æ„ï¼šæ›¿æ¢ä¸ºä½ çš„ firebaseConfigï¼ˆä¿æŒä½ åŸæ¥çš„é…ç½®ï¼‰
   è¿™é‡Œä½¿ç”¨äº† firebase-auth-compat.js æ¥æ”¯æŒ Authenticationï¼ˆé‚®ç®±/å¯†ç ç™»å½•ï¼‰
=================================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyAyHaxW3X-ksmb7AZCeeGO2E2qoLjiCsB4",
  authDomain: "ipad-booking-e3a24.firebaseapp.com",
  databaseURL: "https://ipad-booking-e3a24-default-rtdb.firebaseio.com",
  projectId: "ipad-booking-e3a24",
  storageBucket: "ipad-booking-e3a24.firebasestorage.app",
  messagingSenderId: "245625966955",
  appId: "1:245625966955:web:fdd713996f51fe97d03c2e",
  measurementId: "G-2Y59M64G47"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();
const appointmentsRef = db.ref('appointments');
const settingsRef = db.ref('settings');

/* ================== æœ¬åœ°çŠ¶æ€ ================== */
let appointments = []; // ä»äº‘ç«¯åŒæ­¥
let systemSettings = { enableApproval:false, advanceDays:3, adminPhone:'' };
let isAdminLoggedIn = false;
let currentWeekOffset = 0;

/* ================== åˆå§‹åŒ– UI é€‰é¡¹ï¼ˆiPad æ•°é‡ã€æ—¶é—´ï¼‰ ================== */
function generateIpadCountOptions(){
  const sel = document.getElementById('ipad-count');
  sel.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°é‡</option>';
  for (let i=1;i<=48;i++){
    const opt = document.createElement('option'); opt.value = i; opt.textContent = i + 'å°';
    sel.appendChild(opt);
  }
}
function generateTimeOptions(){
  const start = document.getElementById('start-time');
  const end = document.getElementById('end-time');
  start.innerHTML = '<option value="">è¯·é€‰æ‹©å¼€å§‹æ—¶é—´</option>';
  end.innerHTML = '<option value="">è¯·é€‰æ‹©ç»“æŸæ—¶é—´</option>';
  for (let hour=8; hour<=18; hour++){
    for (let minute of [0,10,20,30,40,50]){
      if (hour===18 && minute>0) continue;
      const t = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
      const o1 = document.createElement('option'); o1.value=t; o1.textContent=t;
      const o2 = document.createElement('option'); o2.value=t; o2.textContent=t;
      start.appendChild(o1); end.appendChild(o2);
    }
  }
}
generateIpadCountOptions();
generateTimeOptions();

/* ================== ç›‘å¬ settingsï¼ˆå®æ—¶ï¼‰ ================== */
settingsRef.on('value', snap => {
  const data = snap.val();
  if (data) {
    systemSettings = Object.assign(systemSettings, data);
  } else {
    // å¦‚æœæ²¡æœ‰ settingsï¼Œå†™å…¥é»˜è®¤è®¾ç½®ï¼ˆç¡®ä¿ cloud æœ‰å€¼ï¼‰
    settingsRef.set(systemSettings).catch(()=>{});
  }
  document.getElementById('advance-days').value = systemSettings.advanceDays || 0;
  document.getElementById('admin-phone') && (document.getElementById('admin-phone').value = systemSettings.adminPhone || '');
  updateDateMinConstraints();
});

/* ================== ç›‘å¬ appointmentsï¼ˆå®æ—¶ï¼‰ ================== */
appointmentsRef.on('value', snap => {
  const data = snap.val();
  if (!data) appointments = [];
  else appointments = Object.keys(data).map(k => {
    const o = data[k]; o.id = o.id || k; return o;
  });
  updateAppointmentsTable();
  updateReturnList();
  updateScheduleView();
});

/* ================== å·¥å…·å‡½æ•° ================ */
function formatAppointmentTime(startTime, endTime){
  const s = new Date(startTime), e = new Date(endTime);
  const sdate = `${s.getMonth()+1}/${s.getDate()}`;
  const st = `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}`;
  const et = `${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`;
  return `${sdate} ${st}-${et}`;
}
function getRandomColor(){
  const colors = ['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c','#d35400','#34495e'];
  return colors[Math.floor(Math.random()*colors.length)];
}

/* ================== æ—¶é—´å†²çªä¸æå‰é¢„çº¦æ£€æŸ¥ ================ */
function checkTimeConflict(startDate, startTime, endDate, endTime, ignoreId=null){
  const s = new Date(`${startDate}T${startTime}`);
  const e = new Date(`${endDate}T${endTime}`);
  if (s >= e) return { conflict:true, message:'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´' };
  for (const a of appointments){
    if (a.status !== 'approved' || a.returned) continue; // ä»…ä¸æœ‰æ•ˆçš„ã€æœªå½’è¿˜çš„é¢„çº¦å†²çª
    if (ignoreId && a.id === ignoreId) continue;
    const as = new Date(a.startTime), ae = new Date(a.endTime);
    if ((s >= as && s < ae) || (e > as && e <= ae) || (s <= as && e >= ae)){
      return { conflict:true, message:`ä¸ ${a.applicant} çš„é¢„çº¦å†²çª (${formatAppointmentTime(a.startTime, a.endTime)})` };
    }
  }
  return { conflict:false, message:'' };
}

function checkAdvanceBooking(startDate){
  const adv = Number(systemSettings.advanceDays || 0);
  if (adv <= 0) return { warning:false, message:'' };
  const today = new Date(); today.setHours(0,0,0,0);
  const start = new Date(startDate); start.setHours(0,0,0,0);
  const diffDays = Math.ceil((start - today) / (1000*60*60*24));
  if (diffDays < adv) {
    return { warning:true, message:`éœ€æå‰ ${adv} å¤©é¢„çº¦ï¼Œè¯·é€‰æ‹© ${adv} å¤©åæˆ–æ›´æ™š` };
  }
  return { warning:false, message:'' };
}

/* ================== æ—¥æœŸ/æ—¶é—´é€‰æ‹©ç¦ç”¨ï¼ˆæŒ‰ advanceDaysï¼‰ ================ */
function updateDateMinConstraints(){
  const adv = Number(systemSettings.advanceDays || 0);
  const minDate = new Date();
  minDate.setDate(minDate.getDate() + adv);
  const minStr = minDate.toISOString().split('T')[0];
  document.getElementById('start-date').min = minStr;
  document.getElementById('end-date').min = minStr;
  ['start-date','end-date'].forEach(id=>{
    const el = document.getElementById(id);
    if (el.value && el.value < minStr) el.value = '';
  });
  refreshTimeOptionStates();
}

function refreshTimeOptionStates(){
  const startTimeSel = document.getElementById('start-time');
  const endTimeSel = document.getElementById('end-time');
  [startTimeSel, endTimeSel].forEach(sel => {
    if (!sel) return;
    for (let i=0;i<sel.options.length;i++){
      sel.options[i].disabled = false;
      sel.options[i].classList.remove('disabled-opt');
    }
  });

  const sDate = document.getElementById('start-date').value;
  const eDate = document.getElementById('end-date').value;
  const minStart = document.getElementById('start-date').min;
  const minEnd = document.getElementById('end-date').min;
  if (sDate && sDate < minStart){
    for (let i=0;i<startTimeSel.options.length;i++){
      startTimeSel.options[i].disabled = true;
      startTimeSel.options[i].classList.add('disabled-opt');
    }
  }
  if (eDate && eDate < minEnd){
    for (let i=0;i<endTimeSel.options.length;i++){
      endTimeSel.options[i].disabled = true;
      endTimeSel.options[i].classList.add('disabled-opt');
    }
  }
}

/* ç»‘å®šæ—¥æœŸ/æ—¶é—´ change äº‹ä»¶ */
['start-date','start-time','end-date','end-time'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener('change', ()=>{
    updateSelectedTimeDisplay();
    refreshTimeOptionStates();
  });
});

/* æ›´æ–°å·²é€‰æ‹©æ—¶é—´æ–‡æœ¬å¹¶æ£€æµ‹å†²çª/æå‰è§„åˆ™ */
function updateSelectedTimeDisplay(){
  const sd = document.getElementById('start-date').value;
  const st = document.getElementById('start-time').value;
  const ed = document.getElementById('end-date').value;
  const et = document.getElementById('end-time').value;
  const selDiv = document.getElementById('selected-time');
  const conflictDiv = document.getElementById('conflict-warning');
  const advDiv = document.getElementById('advance-warning');
  if (sd && st && ed && et){
    selDiv.textContent = `${sd} ${st} - ${ed} ${et}`;
    const c = checkTimeConflict(sd,st,ed,et);
    if (c.conflict){ conflictDiv.textContent = c.message; conflictDiv.style.display='block'; } else { conflictDiv.style.display='none'; }
    const a = checkAdvanceBooking(sd);
    if (a.warning){ advDiv.textContent = a.message; advDiv.style.display='block'; } else { advDiv.style.display='none'; }
  } else {
    selDiv.textContent = 'æœªé€‰æ‹©æ—¶é—´æ®µ';
    conflictDiv.style.display='none'; advDiv.style.display='none';
  }
}

/* ================== æäº¤é¢„çº¦ï¼ˆå†™å…¥ Firebaseï¼‰ ================== */
document.getElementById('appointment-form').addEventListener('submit', function(e){
  e.preventDefault();
  const applicant = document.getElementById('applicant').value.trim();
  const phone = document.getElementById('applicant-phone').value.trim();
  const count = parseInt(document.getElementById('ipad-count').value);
  const purpose = document.getElementById('purpose').value.trim();
  const sd = document.getElementById('start-date').value;
  const st = document.getElementById('start-time').value;
  const ed = document.getElementById('end-date').value;
  const et = document.getElementById('end-time').value;

  if (!applicant || !phone || !count || !sd || !st || !ed || !et) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
  if (!/^[0-9]{11}$/.test(phone)) { alert('è¯·è¾“å…¥11ä½æ‰‹æœºå·'); return; }
  const c = checkTimeConflict(sd,st,ed,et);
  if (c.conflict) { alert(c.message); return; }
  const a = checkAdvanceBooking(sd);
  if (a.warning) { alert(a.message); return; }

  // è·å–æœ¬åœ°å·²ç»‘å®šçš„ wechat openidï¼ˆå¦‚æœæœ‰ï¼‰
  const wechatId = localStorage.getItem('wechatOpenId') || null;

  const newRef = appointmentsRef.push();
  const id = newRef.key;
  const obj = {
    id: id,
    applicant, phone, count: count,
    startTime: `${sd}T${st}`,
    endTime: `${ed}T${et}`,
    purpose, status: systemSettings.enableApproval ? 'pending' : 'approved',
    color: getRandomColor(),
    returned: false,
    returnNotes: '',
    returnChecks: {},
    returnPhotos: [],
    returnTime: null,
    timeCreated: new Date().toISOString(),
    wechatId: wechatId // ä¿å­˜ç»‘å®šçš„å¾®ä¿¡å·ï¼ˆè‹¥æœ‰ï¼‰
  };

  newRef.set(obj)
    .then(()=> {
      document.getElementById('success-message').style.display='block';
      setTimeout(()=>document.getElementById('success-message').style.display='none',3000);
      document.getElementById('appointment-form').reset();
      updateSelectedTimeDisplay();
    })
    .catch(err=>alert('æäº¤å¤±è´¥ï¼š' + err.message));
});

/* ================== æ›´æ–°ç®¡ç†è¡¨æ ¼ ================ */
function updateAppointmentsTable(){
  const tbody = document.querySelector('#appointments-table tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!appointments || appointments.length===0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:12px">æš‚æ— é¢„çº¦è®°å½•</td></tr>'; return;
  }
  // æŒ‰æ—¶é—´æ’åºï¼ˆå¼€å§‹æ—¶é—´ï¼‰ï¼Œå¹¶ä¸”**éšè—å·²å½’è¿˜çš„è®°å½•**ï¼ˆè‹¥éœ€æ˜¾ç¤ºå¯å¢åŠ å¼€å…³ï¼‰
  const sorted = appointments.slice().sort((a,b)=> new Date(a.startTime) - new Date(b.startTime))
    .filter(a => !a.returned); // <-- å…³é”®ï¼šä¸æ˜¾ç¤ºå·²å½’è¿˜

  if (sorted.length===0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:12px">æš‚æ— ï¼ˆæˆ–å…¨éƒ¨å·²å½’è¿˜ï¼‰</td></tr>'; return;
  }

  sorted.forEach(a=>{
    let statusText=''; let cls='';
    if (a.returned){ statusText='å·²å½’è¿˜'; cls='status-returned'; }
    else if (a.status==='approved'){ statusText='å·²æ‰¹å‡†'; cls='status-approved'; }
    else if (a.status==='pending'){ statusText='å¾…å®¡æ ¸'; cls='status-pending'; }
    else if (a.status==='rejected'){ statusText='å·²é©³å›'; cls='status-rejected'; }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.applicant}</td>
      <td>${a.phone}</td>
      <td>${a.count}å°</td>
      <td>${formatAppointmentTime(a.startTime,a.endTime)}</td>
      <td><span class="status ${cls}">${statusText}</span></td>
      <td>
        <button class="btn-primary view-detail-btn" data-id="${a.id}">æŸ¥çœ‹è¯¦æƒ…</button>
        ${(!a.returned && a.status!=='rejected') ? `<button class="btn-danger reject-btn" data-id="${a.id}">é©³å›</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });

  // ç»‘å®šæ“ä½œ
  document.querySelectorAll('.view-detail-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> showAppointmentDetail(btn.getAttribute('data-id')));
  });
  document.querySelectorAll('.reject-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> showRejectModal(btn.getAttribute('data-id')));
  });
}

/* ================== æŸ¥çœ‹è¯¦æƒ…ã€æ‰“å°ï¼ˆå¹¶æŠŠæ£€æŸ¥é¡¹æ˜¾ç¤ºä¸ºä¸­æ–‡ï¼‰ ================ */
const CHECK_LABELS = {
  deviceCount: 'è®¾å¤‡æ•°é‡æ­£ç¡®',
  deviceCondition: 'è®¾å¤‡å¤–è§‚å®Œå¥½',
  accessories: 'é…ä»¶é½å…¨'
};

function showAppointmentDetail(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  const body = document.getElementById('appointment-detail-body');
  let returnPhotosHtml = '';
  if (a.returnPhotos && a.returnPhotos.length>0){
    returnPhotosHtml = `<div style="margin-top:8px"><strong>å½’è¿˜ç…§ç‰‡ï¼š</strong><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">` +
      a.returnPhotos.map(url=>`<img src="${url}" style="width:120px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #ddd" />`).join('') + `</div></div>`;
  }
  // æ˜¾ç¤ºä¸­æ–‡æ£€æŸ¥é¡¹
  let checksHtml = '';
  if (a.returnChecks && Object.keys(a.returnChecks).length>0){
    const checked = Object.keys(a.returnChecks).filter(k=>a.returnChecks[k]);
    checksHtml = checked.map(k => CHECK_LABELS[k] || k).join('ã€') || 'æ— ';
  }

  body.innerHTML = `
    <div><strong>ç”³è¯·äººï¼š</strong> ${a.applicant}</div>
    <div><strong>è”ç³»æ–¹å¼ï¼š</strong> ${a.phone}</div>
    <div><strong>æ•°é‡ï¼š</strong> ${a.count} å°</div>
    <div><strong>ç›®çš„ï¼š</strong> ${a.purpose || 'æ— '}</div>
    <div><strong>æ—¶é—´ï¼š</strong> ${formatAppointmentTime(a.startTime,a.endTime)}</div>
    <div><strong>çŠ¶æ€ï¼š</strong> ${a.returned ? 'å·²å½’è¿˜' : a.status}</div>
    ${a.status==='rejected' && a.rejectReason ? `<div><strong>é©³å›åŸå› ï¼š</strong>${a.rejectReason}</div>` : ''}
    ${a.returned ? `<div><strong>å½’è¿˜æ—¶é—´ï¼š</strong>${a.returnTime ? new Date(a.returnTime).toLocaleString() : 'æœªè®°å½•'}</div>
      <div><strong>å½’è¿˜å¤‡æ³¨ï¼š</strong>${a.returnNotes || 'æ— '}</div>
      <div><strong>æ£€æŸ¥é¡¹ï¼š</strong>${checksHtml || 'æ— '}</div>
      ${returnPhotosHtml}` : ''}
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="close-detail" class="btn-secondary">å…³é—­</button>
      <button id="print-detail" class="btn-print" data-id="${a.id}">æ‰“å°</button>
    </div>
  `;
  document.getElementById('appointment-detail-modal').style.display='flex';
  document.getElementById('close-detail').addEventListener('click', ()=> document.getElementById('appointment-detail-modal').style.display='none');
  document.getElementById('print-detail').addEventListener('click', ()=> { printAppointment(a.id); });
}
function printAppointment(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  let html = `<h1>é¢„çº¦è¯¦æƒ…</h1>`;
  html += `<div>ç”³è¯·äººï¼š${a.applicant}</div><div>è”ç³»æ–¹å¼ï¼š${a.phone}</div><div>æ•°é‡ï¼š${a.count}å°</div><div>æ—¶é—´ï¼š${formatAppointmentTime(a.startTime,a.endTime)}</div><div>çŠ¶æ€ï¼š${a.status}</div>`;
  const w = window.open('about:blank','print');
  w.document.write(`<html><head><title>æ‰“å°</title></head><body>${html}</body></html>`);
  w.document.close(); w.print();
}

/* ================== é©³å›æµç¨‹ ================ */
function showRejectModal(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  const reason = prompt(`è¯·è¾“å…¥é©³å›åŸå› ï¼ˆç”³è¯·äººï¼š${a.applicant}ï¼‰:`);
  if (!reason) return;
  appointmentsRef.child(id).update({ status:'rejected', rejectReason: reason }).then(()=> {
    alert('å·²é©³å›');
  }).catch(err=>alert('é”™è¯¯ï¼š'+err.message));
}

/* ================== å½’è¿˜æµç¨‹ï¼ˆæ”¯æŒæ‹ç…§ä¸Šä¼  + è¿›åº¦æ¡ + éªŒè¯ä¸‰ä¸ªå‹¾é€‰é¡¹ï¼‰ ================ */
function updateReturnList(){
  const list = document.getElementById('return-list'); list.innerHTML='';
  // ä»…å±•ç¤ºå·²æ‰¹å‡†ä¸”æœªå½’è¿˜çš„é¢„çº¦
  const pending = appointments.filter(a => a.status === 'approved' && !a.returned).sort((x,y)=> new Date(x.startTime)-new Date(y.startTime));
  if (pending.length===0){ list.innerHTML='<p style="text-align:center;padding:18px;color:#666">æš‚æ— å¾…å½’è¿˜è®¾å¤‡</p>'; return; }
  pending.forEach(a=>{
    const div = document.createElement('div'); div.className='return-item';
    div.innerHTML = `<div class="return-item-header"><div><strong>${a.applicant}</strong></div><div>${a.count}å°</div></div>
      <div class="return-item-details">è”ç³»æ–¹å¼ï¼š${a.phone}<br>æ—¶é—´ï¼š${formatAppointmentTime(a.startTime,a.endTime)}<br>ç”¨é€”ï¼š${a.purpose || 'æ— '}</div>
      <div class="return-actions"><button class="btn-success return-btn" data-id="${a.id}">å½’è¿˜ç™»è®°</button></div>`;
    list.appendChild(div);
  });
  document.querySelectorAll('.return-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> showReturnModal(btn.getAttribute('data-id')));
  });
}

/* Helper: create a progress element for a file (returns element and a function to update) */
function createFileProgressElement(filename){
  const wrap = document.createElement('div'); wrap.className='file-wrap';
  const img = document.createElement('img'); img.className='thumb'; img.alt = filename;
  const progressContain = document.createElement('div'); progressContain.className='progress';
  const progBar = document.createElement('i'); progBar.style.width='0%';
  progressContain.appendChild(progBar);
  wrap.appendChild(img); wrap.appendChild(progressContain);
  return {wrap, img, setProgress: (p) => { progBar.style.width = Math.round(p*100)+'%'; }};
}

async function showReturnModal(id){
  const a = appointments.find(x=>x.id===id); if(!a) return;
  const body = document.getElementById('return-modal-body');
  body.innerHTML = `
    <div><strong>ç”³è¯·äººï¼š</strong>${a.applicant}</div>
    <div><strong>æ•°é‡ï¼š</strong>${a.count}å°</div>
    <div style="margin-top:8px">
      <label>æ£€æŸ¥é¡¹ç›®ï¼ˆéœ€å…¨éƒ¨å‹¾é€‰ï¼‰</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <label style="display:flex;align-items:center;gap:6px"><input id="check-device-count" type="checkbox" /> è®¾å¤‡æ•°é‡æ­£ç¡®</label>
        <label style="display:flex;align-items:center;gap:6px"><input id="check-device-condition" type="checkbox" /> è®¾å¤‡å¤–è§‚å®Œå¥½</label>
        <label style="display:flex;align-items:center;gap:6px"><input id="check-accessories" type="checkbox" /> é…ä»¶é½å…¨</label>
      </div>
    </div>
    <div style="margin-top:10px"><label>å½’è¿˜å¤‡æ³¨</label><textarea id="return-notes" rows="3" style="width:100%"></textarea></div>
    <div style="margin-top:10px"><label>ä¸Šä¼ ç…§ç‰‡ï¼ˆå¯å¤šå¼ ï¼‰</label>
      <input id="return-photos" type="file" accept="image/*" multiple capture="environment" style="margin-top:6px" />
      <div id="return-photo-previews" class="return-photos-container"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="cancel-return" class="btn-secondary">å–æ¶ˆ</button>
      <button id="confirm-return" class="btn-success">ç¡®è®¤å½’è¿˜</button>
    </div>
  `;
  document.getElementById('return-modal').style.display='flex';

  const photoInput = document.getElementById('return-photos');
  const previews = document.getElementById('return-photo-previews');

  // é¢„è§ˆæœ¬åœ°é€‰ä¸­å›¾ç‰‡ï¼ˆå¹¶ç”Ÿæˆå¯æ›´æ–°çš„ progress æ§ä»¶ï¼‰
  photoInput.addEventListener('change', ()=>{
    previews.innerHTML = '';
    const files = Array.from(photoInput.files || []);
    files.forEach((file, idx)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {wrap, img, setProgress} = createFileProgressElement(file.name);
        img.src = e.target.result;
        // æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆé€šè¿‡ DataTransfer é‡æ–°æ„å»º FileListï¼‰
        const del = document.createElement('button'); del.textContent='Ã—'; del.style.position='absolute'; del.style.right='4px'; del.style.top='4px'; del.style.background='rgba(0,0,0,0.5)'; del.style.color='#fff'; del.style.border='none'; del.style.borderRadius='50%'; del.style.width='22px'; del.style.height='22px'; del.style.cursor='pointer';
        del.addEventListener('click', ()=>{
          const currentFiles = Array.from(photoInput.files || []);
          currentFiles.splice(idx,1);
          const dt = new DataTransfer();
          currentFiles.forEach(f=>dt.items.add(f));
          photoInput.files = dt.files;
          // è§¦å‘ change äº‹ä»¶åˆ·æ–°é¢„è§ˆ
          const ev = new Event('change'); photoInput.dispatchEvent(ev);
        });
        wrap.style.position = 'relative';
        wrap.appendChild(del);
        // å­˜ progress setter åˆ° DOM ä»¥ä¾¿ä¸Šä¼ æ—¶æ›´æ–°
        wrap._setProgress = setProgress;
        previews.appendChild(wrap);
      };
      reader.readAsDataURL(file);
    });
  });

  document.getElementById('cancel-return').addEventListener('click', ()=> document.getElementById('return-modal').style.display='none');

  document.getElementById('confirm-return').addEventListener('click', async ()=>{
    const checkDeviceCount = document.getElementById('check-device-count').checked;
    const checkDeviceCondition = document.getElementById('check-device-condition').checked;
    const checkAccessories = document.getElementById('check-accessories').checked;
    // å¼ºåˆ¶ä¸‰é¡¹å¿…é¡»å‹¾é€‰
    if (!checkDeviceCount || !checkDeviceCondition || !checkAccessories){
      alert('è¯·å‹¾é€‰æ‰€æœ‰æ£€æŸ¥é¡¹åå†ç¡®è®¤å½’è¿˜ï¼ˆè®¾å¤‡æ•°é‡ã€å¤–è§‚ã€é…ä»¶ï¼‰ã€‚'); return;
    }
    const checks = { deviceCount: checkDeviceCount, deviceCondition: checkDeviceCondition, accessories: checkAccessories };
    const notes = document.getElementById('return-notes').value.trim();
    const files = Array.from(photoInput.files || []);

    // ä¸Šä¼ ï¼šæ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆé€ä¸ªä¸Šä¼ ï¼‰
    let uploadedUrls = [];
    try {
      // è·å– previews å­èŠ‚ç‚¹ï¼ˆå¯¹åº”é¡ºåºï¼‰
      const previewChildren = Array.from(previews.children || []);
      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
      const confirmBtn = document.getElementById('confirm-return');
      confirmBtn.disabled = true; confirmBtn.textContent = 'ä¸Šä¼ ä¸­...';

      for (let i=0;i<files.length;i++){
        const file = files[i];
        const path = `returns/${id}/${Date.now()}_${file.name}`;
        const ref = storage.ref().child(path);
        // ä½¿ç”¨ put å¹¶ç›‘å¬ä¸Šä¼ è¿›åº¦
        await new Promise((resolve, reject) => {
          const uploadTask = ref.put(file);
          uploadTask.on('state_changed',
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes);
              // æ‰¾åˆ°å¯¹åº”çš„ preview å…ƒç´ å¹¶æ›´æ–°è¿›åº¦ï¼ˆå®‰å…¨é˜²æŠ¤ï¼‰
              const pv = previewChildren[i];
              if (pv && pv._setProgress) pv._setProgress(progress);
            },
            (error) => {
              reject(error);
            },
            async () => {
              try {
                const url = await uploadTask.snapshot.ref.getDownloadURL();
                uploadedUrls.push(url);
                resolve();
              } catch (err2) { reject(err2); }
            }
          );
        });
      }
    } catch (err) {
      alert('ç…§ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + err.message);
      // é‡æ–°å¯ç”¨æŒ‰é’®
      const confirmBtn = document.getElementById('confirm-return');
      confirmBtn.disabled = false; confirmBtn.textContent = 'ç¡®è®¤å½’è¿˜';
      return;
    }

    // æ›´æ–° appointment
    const updateObj = { returned:true, returnChecks:checks, returnNotes:notes, returnTime:new Date().toISOString() };
    if (uploadedUrls.length>0) updateObj.returnPhotos = uploadedUrls;
    appointmentsRef.child(id).update(updateObj).then(()=>{
      alert('å½’è¿˜ç™»è®°æˆåŠŸ');
      document.getElementById('return-modal').style.display='none';
    }).catch(err=>{
      alert('æ›´æ–°å¤±è´¥ï¼š' + err.message);
    }).finally(()=>{
      const confirmBtn = document.getElementById('confirm-return');
      confirmBtn.disabled = false; confirmBtn.textContent = 'ç¡®è®¤å½’è¿˜';
    });
  });
}

/* ================== æ—¥å†ï¼šç½‘æ ¼æ¸²æŸ“ï¼ˆå·²ä¿®å¤ï¼šä¸å†æ˜¾ç¤ºå·²å½’è¿˜ï¼‰ ================ */
function updateScheduleView(){
  const cal = document.getElementById('calendar-grid');
  const header = document.getElementById('week-header');
  cal.innerHTML=''; header.innerHTML='';

  // è®¡ç®—æœ¬å‘¨èµ·å§‹ï¼ˆæ—¥æ›œä¸º0ï¼‰
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay() + currentWeekOffset*7);
  weekStart.setHours(0,0,0,0);
  const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
  document.getElementById('week-title').textContent = `${weekStart.getMonth()+1}/${weekStart.getDate()} - ${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;

  // header: æ—¶é—´åˆ— + 7 å¤©
  const timeHeader = document.createElement('div'); timeHeader.className='time-label'; timeHeader.textContent='æ—¶é—´';
  header.appendChild(timeHeader);
  for (let i=0;i<7;i++){
    const day = new Date(weekStart); day.setDate(weekStart.getDate()+i);
    const dCell = document.createElement('div'); dCell.className='day-cell';
    const dayNames = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
    dCell.textContent = `${dayNames[day.getDay()]} ${day.getMonth()+1}/${day.getDate()}`;
    header.appendChild(dCell);
  }

  // grid åŸºç¡€ï¼šç”Ÿæˆæ—¶é—´è¡Œï¼ˆ08:00 - 18:00 æ¯ 30 åˆ†ï¼‰
  const rows = [];
  for (let hour=8; hour<=18; hour++){
    for (let minute of [0,30]){
      if (hour===18 && minute===30) continue;
      const rowIndex = rows.length + 1;
      // æ—¶é—´æ ‡ç­¾åˆ—
      const timeCell = document.createElement('div'); timeCell.className='grid-time-cell'; timeCell.style.gridColumn='1';
      timeCell.textContent = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
      timeCell.style.gridRow = rowIndex;
      cal.appendChild(timeCell);
      // 7 å¤©çš„ç©ºç™½å•å…ƒæ ¼
      for (let d=0; d<7; d++){
        const cell = document.createElement('div'); cell.className='grid-day-cell';
        cell.style.gridColumn = (d+2);
        cell.style.gridRow = rowIndex;
        cal.appendChild(cell);
      }
      rows.push({hour, minute});
    }
  }

  // å°† appointments ä¸­çš„å·²æ‰¹å‡†é¡¹ç»˜åˆ¶ä¸ºå—ï¼ˆè·¨å¤šè¡Œï¼‰
  const rowCount = rows.length;
  const slotsStartMinutes = 8*60; // 08:00
  appointments.forEach(a=>{
    if (a.status !== 'approved' || a.returned) return; // <-- ä¸æ˜¾ç¤ºå·²å½’è¿˜
    const s = new Date(a.startTime);
    const e = new Date(a.endTime);

    // å¦‚æœä¸åœ¨æœ¬å‘¨èŒƒå›´åˆ™è·³è¿‡
    if (e <= weekStart || s >= new Date(weekStart.getTime() + 7*24*3600*1000)) return;

    // dayIndex relative to weekStart (0..6)
    const dayIndex = (s.getDay() + 7 - weekStart.getDay()) % 7;

    const sMinutes = s.getHours()*60 + s.getMinutes();
    const eMinutes = e.getHours()*60 + e.getMinutes();

    let startRow = Math.floor((sMinutes - slotsStartMinutes) / 30) + 1;
    let endRow = Math.ceil((eMinutes - slotsStartMinutes) / 30) + 1;
    if (startRow < 1) startRow = 1;
    if (endRow > rowCount+1) endRow = rowCount+1;

    const block = document.createElement('div');
    block.className = 'appointment-block';
    block.style.gridColumn = (dayIndex + 2);
    block.style.gridRow = `${startRow} / ${endRow}`;
    block.style.backgroundColor = a.color || getRandomColor();
    block.innerHTML = `<div class="appointment-info">${a.applicant}</div><div class="appointment-time">${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}-${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}</div>`;
    block.addEventListener('click', ()=> showAppointmentDetail(a.id));
    cal.appendChild(block);
  });
}

/* ================== ç®¡ç†å‘˜ç™»å½•ä¸è®¾ç½®ï¼ˆæ”¹ä¸º Firebase Authï¼‰ ================ */
document.getElementById('admin-link').addEventListener('click', (e)=>{ e.preventDefault(); if (isAdminLoggedIn) showAdmin(); else showPage('login-page'); });

function showAdmin(){ showPage('admin-page'); updateAppointmentsTable(); }

auth.onAuthStateChanged(user => {
  if (user){
    isAdminLoggedIn = true;
    document.getElementById('admin-email-display').textContent = user.email || 'ç®¡ç†å‘˜';
    // æ˜¾ç¤º admin page
    // (è‹¥å½“å‰ç•Œé¢ä¸æ˜¯ adminï¼Œä¿æŒå½“å‰ä½ç½®)
  } else {
    isAdminLoggedIn = false;
    document.getElementById('admin-email-display') && (document.getElementById('admin-email-display').textContent = 'æœªç™»å½•');
  }
});

document.getElementById('login-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const email = document.getElementById('admin-email').value.trim();
  const pwd = document.getElementById('admin-password').value;
  const err = document.getElementById('login-error');
  auth.signInWithEmailAndPassword(email, pwd).then(cred=>{
    err.style.display='none';
    isAdminLoggedIn = true;
    showAdmin();
  }).catch(errr=>{
    err.style.display='block';
    console.error(errr);
  });
});

document.getElementById('admin-logout').addEventListener('click', ()=>{
  auth.signOut().then(()=> {
    isAdminLoggedIn = false;
    alert('å·²ç™»å‡º');
    showPage('home-page');
  });
});

/* ä¿å­˜è®¾ç½®ï¼ˆä¿ç•™ï¼‰ */
document.getElementById('save-settings') && document.getElementById('save-settings').addEventListener('click', ()=>{
  const adv = Number(document.getElementById('advance-days').value || 0);
  const phone = document.getElementById('admin-phone').value.trim();
  systemSettings.advanceDays = adv;
  systemSettings.adminPhone = phone;
  settingsRef.update({ advanceDays: adv, adminPhone: phone }).then(()=> {
    alert('è®¾ç½®å·²ä¿å­˜');
    updateDateMinConstraints();
  }).catch(err=>alert('ä¿å­˜å¤±è´¥ï¼š' + err.message));
});

/* render QRCode */
function renderQRCode(){
  const q = document.getElementById('qrcode');
  if (!q) return;
  q.innerHTML='';
  QRCode.toCanvas(q, location.href, { width:200 }, function(err){});
}

/* ================== admin: åˆ·æ–°ã€æ¸…ç©ºï¼ˆæ¸…ç©ºéœ€å¯†ç ç¡®è®¤ï¼‰ ================ */
document.getElementById('refresh-appointments') && document.getElementById('refresh-appointments').addEventListener('click', ()=>{
  appointmentsRef.once('value').then(()=> alert('å·²åˆ·æ–°')).catch(err=>alert('åˆ·æ–°å¤±è´¥ï¼š'+err.message));
});

const CLEAR_CONFIRM_PASSWORD = '545600';
document.getElementById('clear-all-appointments') && document.getElementById('clear-all-appointments').addEventListener('click', ()=>{
  document.getElementById('clear-confirm-modal').style.display='flex';
});
document.getElementById('clear-confirm-cancel') && document.getElementById('clear-confirm-cancel').addEventListener('click', ()=> document.getElementById('clear-confirm-modal').style.display='none');
document.getElementById('clear-confirm-ok') && document.getElementById('clear-confirm-ok').addEventListener('click', ()=>{
  const val = document.getElementById('clear-confirm-input').value;
  if (val !== CLEAR_CONFIRM_PASSWORD){ alert('ç¡®è®¤å¯†ç é”™è¯¯'); return; }
  appointmentsRef.remove().then(()=> {
    alert('å·²æ¸…ç©ºæ‰€æœ‰é¢„çº¦è®°å½•');
    document.getElementById('clear-confirm-input').value='';
    document.getElementById('clear-confirm-modal').style.display='none';
  }).catch(err=>alert('æ“ä½œå¤±è´¥ï¼š'+err.message));
});

/* ================== é¡µé¢å¯¼èˆªï¼ˆä¿®å¤ go-to-returnï¼šç›´æ¥è¿›å…¥å½’è¿˜ç•Œé¢ï¼‰ ================== */
document.getElementById('go-to-appointment').addEventListener('click', ()=> showPage('appointment-page'));
document.getElementById('go-to-schedule').addEventListener('click', ()=> { showPage('schedule-page'); updateScheduleView(); });
// ä¿®æ”¹ï¼šç‚¹å‡»â€œå½’è¿˜ç™»è®°â€ç›´æ¥è¿›å…¥å½’è¿˜ç•Œé¢ï¼ˆåŸæ¥åˆ¤æ–­ admin ç™»å½•å¹¶è·³è½¬ç™»å½•é¡µé¢ï¼‰
document.getElementById('go-to-return').addEventListener('click', ()=> { showPage('return-page'); updateReturnList(); });

document.getElementById('back-to-home').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-from-schedule').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-from-return').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-from-login').addEventListener('click', ()=> showPage('home-page'));
document.getElementById('back-to-home-admin') && document.getElementById('back-to-home-admin').addEventListener('click', ()=> showPage('home-page'));

document.getElementById('prev-week').addEventListener('click', ()=> { currentWeekOffset--; updateScheduleView(); });
document.getElementById('next-week').addEventListener('click', ()=> { currentWeekOffset++; updateScheduleView(); });

document.getElementById('close-return-modal').addEventListener('click', ()=> document.getElementById('return-modal').style.display='none');
document.getElementById('close-appointment-detail-modal').addEventListener('click', ()=> document.getElementById('appointment-detail-modal').style.display='none');

/* ================== åˆ é™¤é¢„çº¦ï¼ˆåœ¨éœ€è¦å¤„ä½¿ç”¨ï¼‰ ================ */
function deleteAppointment(id){
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤é¢„çº¦ï¼Ÿ')) return;
  appointmentsRef.child(id).remove().catch(err=>alert('åˆ é™¤å¤±è´¥ï¼š'+err.message));
}
window.deleteAppointment = deleteAppointment;

/* ================== é¦–æ¬¡çº¦æŸè®¾ç½® ================== */
updateDateMinConstraints();
updateSelectedTimeDisplay();
updateScheduleView();

function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

/* ================== å¾®ä¿¡ç™»å½•ç»‘å®šï¼ˆç¤ºä¾‹ + å®¢æˆ·ç«¯æ¼”ç¤ºï¼‰ ==================
è¯´æ˜ï¼š
- å®Œæ•´çš„å¾®ä¿¡æˆæƒç™»å½•éœ€è¦æœåŠ¡ç«¯é…åˆï¼ˆç”¨ code æ¢å– access_tokenï¼›ç„¶åä» access_token æ¢ openid å’Œç”¨æˆ·ä¿¡æ¯ï¼‰ã€‚
- è¿™é‡Œç»™å‡ºå®¢æˆ·ç«¯è·³è½¬ç¤ºä¾‹ã€‚ä½ éœ€è¦åœ¨åå°æŒ‰å¾®ä¿¡å¼€æ”¾å¹³å°/å…¬ä¼—å·çš„è¯´æ˜å®ç° code -> openid çš„äº¤æ¢ï¼Œå¹¶åœ¨é‡å®šå‘åˆ°å‰ç«¯æ—¶æä¾› openidï¼ˆæˆ–æŠŠ openid å†™å…¥ DBï¼‰ã€‚
- ä¸‹é¢çš„ä»£ç åšäº†ä¸¤ä»¶äº‹ï¼š
  1) æä¾›ä¸€ä¸ª "å¾®ä¿¡ç™»å½•å¹¶ç»‘å®š" æŒ‰é’®ï¼Œè·³è½¬åˆ°å¾®ä¿¡ OAuthï¼ˆè¯·å°† WECHAT_APPID ä¸ redirect_uri æ›¿æ¢ä¸ºçœŸå®å€¼ï¼‰
  2) åŒæ—¶æ”¯æŒå¼€å‘/æµ‹è¯•æ¨¡å¼ï¼šå¦‚æœä½ åœ¨å›è°ƒ URL ä¸­é™„åŠ  ?wechatOpenId=XXXï¼Œé¡µé¢ä¼šæŠŠå®ƒå­˜åˆ° localStorageï¼ˆä»…æ¼”ç¤ºï¼‰ï¼Œå¹¶åœ¨åˆ›å»ºé¢„çº¦æ—¶å†™å…¥ wechatId å­—æ®µã€‚
- å®‰å…¨æç¤ºï¼šçœŸå®ç¯å¢ƒè¯·åœ¨æœåŠ¡ç«¯åš code äº¤æ¢å¹¶å¯¹ openid åšæ ¡éªŒï¼Œä¸è¦æŠŠæ•æ„Ÿå¯†é’¥å†™åˆ°å‰ç«¯ã€‚

ä½¿ç”¨æ–¹å¼ï¼ˆå¼€å‘æµç¨‹ï¼‰ï¼š
1. åœ¨å¾®ä¿¡å¼€æ”¾å¹³å° / å…¬ä¼—å·åå°é…ç½®æˆæƒå›è°ƒåŸŸåï¼ˆredirect_uriï¼‰ã€‚
2. åœ¨åç«¯å®ç°ä¸€ä¸ªè·¯ç”±ï¼šæ¥æ”¶å¾®ä¿¡å›è°ƒçš„ codeï¼Œä½¿ç”¨ appid/secret å»æ¢ access_token ä¸ openidï¼Œç„¶åæŠŠ openidï¼ˆæˆ–ç”Ÿæˆçš„ç™»å½• tokenï¼‰é‡å®šå‘å›å‰ç«¯é¡µé¢ï¼ˆä¾‹å¦‚ /?wechatOpenId=xxxxx æˆ–å¸¦ç€è‡ªç­¾ tokenï¼‰ã€‚
3. å‰ç«¯è¯»å– wechatOpenId å¹¶ä¿å­˜ï¼ˆlocalStorageï¼‰æˆ–åœ¨ç™»å½•åæŠŠ openid å…³è”åˆ°ç”¨æˆ·è®°å½•ã€‚

ä¸‹é¢æ˜¯æœ€ç®€å•çš„å®¢æˆ·ç«¯é€»è¾‘ï¼ˆæ¼”ç¤ºï¼‰ï¼š
================================================================= */
document.getElementById('wechat-login-btn').addEventListener('click', ()=>{
  // !! è¯·ç”¨çœŸå®çš„ WECHAT_APPID å’Œ redirect_uriï¼ˆå·²åœ¨å¾®ä¿¡å¹³å°é…ç½®ï¼‰
  const WECHAT_APPID = 'WECHAT_APPID_REPLACE_ME';
  const REDIRECT_URI = encodeURIComponent(window.location.origin + window.location.pathname); // æˆ–è€…ä½ çš„å›è°ƒè·¯å¾„
  // å¾®ä¿¡æ‰«ç æˆ–æˆæƒé¡µï¼ˆä¸‹é¢ä½¿ç”¨ snsapi_userinfo ä½œä¸ºç¤ºä¾‹ï¼‰
  const wxAuthUrl = `https://open.weixin.qq.com/connect/qrconnect?appid=${WECHAT_APPID}&redirect_uri=${REDIRECT_URI}&response_type=code&scope=snsapi_login&state=wechat_bind#wechat_redirect`;
  // æ³¨æ„ï¼šä¸Šé¢ä¸ºã€Œç½‘é¡µæ‰«ç ç™»å½•ã€é“¾æ¥ç¤ºä¾‹ï¼Œé¡»æ ¹æ®ä½ çš„å¹³å°ï¼ˆå…¬ä¼—å·/æ‰«ç /å°ç¨‹åºï¼‰é€‰æ‹©æ­£ç¡® OAuth æµç¨‹
  // æˆ‘åœ¨è¿™é‡Œç›´æ¥è·³è½¬åˆ°ç¤ºä¾‹åœ°å€ï¼›åœ¨ç”Ÿäº§è¯·èµ°æœåŠ¡ç«¯->å¾®ä¿¡->æœåŠ¡ç«¯->å‰ç«¯ çš„å®Œæ•´æµç¨‹
  window.location.href = wxAuthUrl;
});

// æ”¯æŒå¼€å‘æµ‹è¯•æ¨¡å¼ï¼šå¦‚æœ URL ä¸ŠåŒ…å« wechatOpenId=xxxï¼ˆç”±ä½ çš„åç«¯å›è°ƒè·³è½¬æ¥ï¼‰ï¼Œå°±ä¿å­˜å®ƒ
(function handleWechatCallback(){
  const params = new URLSearchParams(window.location.search);
  const wid = params.get('wechatOpenId');
  if (wid){
    // å°† wechatOpenId å­˜å‚¨åˆ° localStorageï¼Œé¢„çº¦æäº¤æ—¶ä¼šé™„å¸¦æ­¤å­—æ®µ
    localStorage.setItem('wechatOpenId', wid);
    // å¹¶æç¤ºç”¨æˆ·ç»‘å®šæˆåŠŸ
    alert('å¾®ä¿¡å·²ç»‘å®šï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰ï¼š' + wid);
    // æ¸…ç† URLï¼ˆå¯é€‰ï¼‰
    const url = new URL(window.location);
    url.searchParams.delete('wechatOpenId');
    window.history.replaceState({}, '', url.toString());
  }
})();

/* ================== ç»“æŸ ================== */
/* è¯´æ˜ä¸å¯é€‰æ‰©å±•ï¼š
 - æˆ‘å·²ç»æŠŠâ€œå½’è¿˜åä»æ˜¾ç¤ºåœ¨é¢„çº¦ä¸­â€çš„é—®é¢˜ä¿®å¤ï¼ˆåœ¨è¡¨æ ¼ä¸æ—¥å†æ¸²æŸ“å¤„è¿‡æ»¤ returnedï¼‰
 - ç…§ç‰‡ä¸Šä¼ æ”¹ä¸ºå¸¦è¿›åº¦çš„é€ä¸ªä¸Šä¼ ï¼Œå¹¶åœ¨ UI ä¸Šæ˜¾ç¤ºè¿›åº¦æ¡ä¸ç¼©ç•¥å›¾
 - ç®¡ç†å‘˜ç™»å½•æ”¹ä¸º Firebase Authï¼ˆä½ éœ€åœ¨ Firebase Console åˆ›å»ºç®¡ç†å‘˜é‚®ç®±/å¯†ç ï¼‰
 - å¾®ä¿¡ç™»å½•ç»‘å®šéƒ¨åˆ†åªæä¾›å®¢æˆ·ç«¯è·³è½¬ä¸å›è°ƒè¯»å–ç¤ºä¾‹ï¼Œå®é™…å¾®ä¿¡ code->openid äº¤æ¢éœ€è¦æœåŠ¡ç«¯æ”¯æŒ
 - å¦‚æœä½ éœ€è¦æˆ‘ç»§ç»­ï¼š
    1) å¸®ä½ æŠŠåç«¯å¾®ä¿¡ç™»å½•å›è°ƒæ ·ä¾‹ä»£ç å†™å¥½ï¼ˆä¾‹å¦‚ç”¨ Node/Expressï¼‰ï¼Œæˆ–
    2) æŠŠä¸Šä¼ çš„å›¾ç‰‡å’Œæ•°æ®åº“å†™å…¥é…åˆæ›´ä¸¥æ ¼çš„ Firebase Storage / Database Rulesï¼ˆç”Ÿäº§å¿…åšï¼‰
    3) å¢åŠ â€œæ˜¾ç¤ºå·²å½’è¿˜è®°å½•â€çš„å¼€å…³ï¼ˆç®¡ç†å‘˜å¯é€‰æ‹©æŸ¥çœ‹æ‰€æœ‰å†å²æˆ–ä»…æœªå½’è¿˜ï¼‰
   æˆ‘å¯ä»¥ç»§ç»­ä¸ºä½ å®ç°ã€‚
*/
</script>
</body>
</html>
