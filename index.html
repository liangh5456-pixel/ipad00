<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPadè¨­å‚™é ç´„ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        header {
            background: linear-gradient(90deg, #3498db, #2c3e50);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .content {
            padding: 20px;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        /* é¦–é æ¨£å¼ */
        #home-page {
            text-align: center;
            padding: 30px 15px;
        }
        
        .home-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 30px 0;
        }
        
        .home-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            margin: 0 auto;
            text-align: center;
        }
        
        .home-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }
        
        .appointment-btn {
            background: linear-gradient(135deg, #3498db, #2c3e50);
        }
        
        .view-schedule-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .return-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .home-btn i {
            font-size: 35px;
            margin-bottom: 8px;
        }
        
        .home-btn span {
            font-size: 16px;
            font-weight: bold;
        }
        
        .description {
            margin-top: 20px;
            color: #7f8c8d;
            line-height: 1.5;
            font-size: 14px;
        }
        
        /* é ç´„è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* æ™‚é–“æ®µé¸æ“‡æ¨£å¼ */
        .time-selector {
            margin-top: 15px;
        }
        
        .time-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .time-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-input-group {
            flex: 1 1 45%;
            min-width: 0;
        }
        
        .selected-time {
            margin-top: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .conflict-warning {
            margin-top: 8px;
            padding: 8px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        
        .advance-warning {
            margin-top: 8px;
            padding: 8px;
            background: #fff3cd;
            color: #856404;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-print {
            background: #7d3c98;
            color: white;
        }
        
        .btn-print:hover {
            background: #6c3483;
        }
        
        .btn-disabled {
            background: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
        }
        
        /* å·²é ç´„æ™‚æ®µé é¢æ¨£å¼ */
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .week-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .nav-btn:hover {
            background: #2980b9;
        }
        
        .week-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .time-schedule {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        .time-header-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            background: #f8f9fa;
        }
        
        .time-header-cell {
            padding: 8px 3px;
            text-align: center;
            font-weight: 600;
            border-right: 1px solid #e0e0e0;
            font-size: 11px;
        }
        
        .time-slots-container {
            position: relative;
            height: 600px;
        }
        
        .time-slot-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            height: 30px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .time-label {
            padding: 3px;
            text-align: right;
            font-size: 10px;
            color: #666;
            border-right: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        .time-cell {
            border-right: 1px solid #e0e0e0;
            position: relative;
        }
        
        .appointment-block {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 3px;
            padding: 2px;
            font-size: 9px;
            color: white;
            overflow: hidden;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .appointment-block:hover {
            z-index: 20;
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .appointment-info {
            font-weight: bold;
            margin-bottom: 1px;
        }
        
        .appointment-time {
            font-size: 8px;
            opacity: 0.9;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 6px;
        }
        
        /* å¾Œå°ç®¡ç†æ¨£å¼ */
        .admin-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 3px 6px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .status-approved {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-returned {
            background: #d4edda;
            color: #155724;
        }
        
        /* äºŒç¶­ç¢¼æ¨£å¼ */
        .qrcode-container {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-top: 15px;
        }
        
        #qrcode {
            margin: 0 auto;
            max-width: 200px;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .nav-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }
        
        .nav-tab.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-link {
            color: white;
            text-decoration: none;
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 14px;
        }
        
        /* ç™»å…¥é é¢æ¨£å¼ */
        #login-page {
            text-align: center;
            padding: 30px 15px;
        }
        
        .login-form {
            max-width: 300px;
            margin: 0 auto;
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* ç³»çµ±è¨­å®šæ¨£å¼ */
        .settings-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setting-description {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        /* æ­¸é‚„ç™»è¨˜é é¢æ¨£å¼ */
        .return-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .return-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .return-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .return-item-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .return-actions {
            display: flex;
            gap: 8px;
        }
        
        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .return-check-options {
            margin-bottom: 15px;
        }
        
        .check-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .check-option input {
            width: auto;
            margin-right: 10px;
        }
        
        .check-option label {
            margin-bottom: 0;
            font-weight: normal;
        }
        
        /* é ç´„è©³æƒ…æ¨¡æ…‹æ¡†æ¨£å¼ */
        .appointment-details {
            margin-bottom: 15px;
        }
        
        .detail-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #555;
        }
        
        /* ç…§ç‰‡ä¸Šå‚³æ¨£å¼ */
        .photo-upload {
            margin-top: 15px;
            border: 1px dashed #ddd;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .upload-btn:hover {
            background: #2980b9;
        }
        
        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 480px) {
            .time-inputs {
                flex-direction: column;
                gap: 8px;
            }
            
            .time-input-group {
                flex: 1 1 100%;
            }
            
            .time-header-cell {
                font-size: 10px;
                padding: 6px 2px;
            }
            
            .time-label {
                font-size: 9px;
            }
            
            .buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
            }
            
            .return-actions {
                flex-direction: column;
            }
        }
        
        /* æ‰“å°æ¨£å¼ */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container,
            .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 9999;
                display: block !important;
                padding: 20px;
            }
            .buttons {
                display: none !important;
            }
        }
        
        /* æ‰“å°å°ˆç”¨å®¹å™¨ */
        .print-container {
            display: none;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .print-details {
            width: 100%;
        }
        
        .print-detail-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .print-label {
            font-weight: bold;
            width: 30%;
        }
        
        .print-value {
            width: 65%;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        /* æˆåŠŸæç¤º */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        /* åŠ è¼‰æŒ‡ç¤ºå™¨ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>iPadè¨­å‚™é ç´„ç³»çµ±</h1>
            <div class="subtitle">ä¾¿æ·é ç´„ï¼Œé«˜æ•ˆç®¡ç†</div>
            <a href="#" id="admin-link" class="admin-link">ç®¡ç†å“¡</a>
        </header>
        
        <div class="content">
            <!-- é¦–é  -->
            <div id="home-page" class="page active">
                <h2>æ­¡è¿ä½¿ç”¨iPadé ç´„ç³»çµ±</h2>
                <div class="home-buttons">
                    <div class="home-btn appointment-btn" id="go-to-appointment">
                        <i>ğŸ“±</i>
                        <span>è¨­å‚™é ç´„</span>
                    </div>
                    <div class="home-btn view-schedule-btn" id="go-to-schedule">
                        <i>ğŸ“…</i>
                        <span>å·²é ç´„æ™‚æ®µ</span>
                    </div>
                    <div class="home-btn return-btn" id="go-to-return">
                        <i>ğŸ“‹</i>
                        <span>æ­¸é‚„ç™»è¨˜</span>
                    </div>
                </div>
                <div class="description">
                    <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹é ç´„iPadè¨­å‚™æˆ–æŸ¥çœ‹å·²é ç´„æ™‚æ®µ</p>
                    <p>è«‹æå‰è¦åŠƒä½¿ç”¨æ™‚é–“ï¼ŒæŒ‰æ™‚æ­¸é‚„è¨­å‚™</p>
                </div>
            </div>
            
            <!-- é ç´„é é¢ -->
            <div id="appointment-page" class="page">
                <h2>iPadè¨­å‚™é ç´„</h2>
                <div class="success-message" id="success-message">
                    é ç´„æˆåŠŸï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ç”³è«‹ã€‚
                </div>
                <form id="appointment-form">
                    <div class="form-group">
                        <label for="applicant">ç”³è«‹äºº</label>
                        <input type="text" id="applicant" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="applicant-phone">è¯ç¹«é›»è©±</label>
                        <input type="tel" id="applicant-phone" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼" pattern="[0-9]{11}" maxlength="11" required>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">è«‹è¼¸å…¥11ä½æ‰‹æ©Ÿè™Ÿç¢¼</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ipad-count">ç”³è«‹iPadæ•¸é‡ (1-48å°)</label>
                        <select id="ipad-count" required>
                            <option value="">è«‹é¸æ“‡æ•¸é‡</option>
                            <!-- é¸é …å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="purpose">ä½¿ç”¨ç›®çš„</label>
                        <textarea id="purpose" rows="3" placeholder="è«‹ç°¡è¦èªªæ˜ä½¿ç”¨iPadçš„ç›®çš„"></textarea>
                    </div>
                    
                    <div class="time-selector">
                        <div class="time-header">é¸æ“‡é ç´„æ™‚æ®µ</div>
                        
                        <div class="time-inputs">
                            <div class="time-input-group">
                                <label for="start-date">é–‹å§‹æ—¥æœŸ</label>
                                <input type="date" id="start-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="start-time">é–‹å§‹æ™‚é–“</label>
                                <select id="start-time" required>
                                    <option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>
                                    <!-- é¸é …å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                                </select>
                            </div>
                            <div class="time-input-group">
                                <label for="end-date">çµæŸæ—¥æœŸ</label>
                                <input type="date" id="end-date" required>
                            </div>
                            <div class="time-input-group">
                                <label for="end-time">çµæŸæ™‚é–“</label>
                                <select id="end-time" required>
                                    <option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>
                                    <!-- é¸é …å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="selected-time" id="selected-time">
                            æœªé¸æ“‡æ™‚é–“æ®µ
                        </div>
                        
                        <div class="conflict-warning" id="conflict-warning">
                            <!-- è¡çªè­¦å‘Šå°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        
                        <div class="advance-warning" id="advance-warning">
                            <!-- æå‰é ç´„è­¦å‘Šå°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary" id="submit-btn">æäº¤é ç´„</button>
                    </div>
                </form>
            </div>
            
            <!-- å·²é ç´„æ™‚æ®µé é¢ -->
            <div id="schedule-page" class="page">
                <div class="schedule-header">
                    <h2>å·²é ç´„æ™‚æ®µ</h2>
                    <div class="week-nav">
                        <div class="nav-btn" id="prev-week">â†</div>
                        <div class="week-title" id="week-title">æœ¬é€±é ç´„æƒ…æ³</div>
                        <div class="nav-btn" id="next-week">â†’</div>
                    </div>
                </div>
                
                <div class="time-schedule">
                    <div class="time-header-row" id="schedule-header">
                        <!-- è¡¨é ­å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="time-slots-container" id="time-slots-container">
                        <!-- æ™‚é–“æ®µå°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="legend" id="schedule-legend">
                    <!-- åœ–ä¾‹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-schedule">è¿”å›é¦–é </button>
                </div>
            </div>
            
            <!-- æ­¸é‚„ç™»è¨˜é é¢ -->
            <div id="return-page" class="page">
                <h2>è¨­å‚™æ­¸é‚„ç™»è¨˜</h2>
                <div class="return-list" id="return-list">
                    <!-- æ­¸é‚„åˆ—è¡¨å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
                <div class="buttons">
                    <button type="button" class="btn-secondary" id="back-to-home-from-return">è¿”å›é¦–é </button>
                </div>
            </div>
            
            <!-- ç™»å…¥é é¢ -->
            <div id="login-page" class="page">
                <h2>ç®¡ç†å“¡ç™»å…¥</h2>
                <form id="login-form" class="login-form">
                    <div class="form-group">
                        <label for="username">å¸³è™Ÿ</label>
                        <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">å¯†ç¢¼</label>
                        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    
                    <div class="login-error" id="login-error">
                        å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="btn-secondary" id="back-to-home-from-login">è¿”å›é¦–é </button>
                        <button type="submit" class="btn-primary">ç™»å…¥</button>
                    </div>
                </form>
            </div>
            
            <!-- å¾Œå°ç®¡ç†é é¢ -->
            <div id="admin-page" class="page">
                <h2>é ç´„ç®¡ç†å¾Œå°</h2>
                
                <div class="nav-tabs">
                    <div class="nav-tab active" data-tab="appointments">é ç´„è¨˜éŒ„</div>
                    <div class="nav-tab" data-tab="settings">ç³»çµ±è¨­å®š</div>
                    <div class="nav-tab" data-tab="password">ä¿®æ”¹å¯†ç¢¼</div>
                    <div class="nav-tab" data-tab="qrcode">é ç´„äºŒç¶­ç¢¼</div>
                </div>
                
                <div class="tab-content active" id="appointments-tab">
                    <div class="admin-controls">
                        <button class="btn-primary" id="refresh-appointments">åˆ·æ–°æ•¸æ“š</button>
                        <button class="btn-secondary" id="back-to-home-admin">è¿”å›é¦–é </button>
                    </div>
                    
                    <table id="appointments-table">
                        <thead>
                            <tr>
                                <th>ç”³è«‹äºº</th>
                                <th>è¯ç¹«é›»è©±</th>
                                <th>iPadæ•¸é‡</th>
                                <th>å€Ÿç”¨æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- é ç´„æ•¸æ“šå°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-content" id="settings-tab">
                    <div class="settings-group">
                        <h3>é ç´„è¨­å®š</h3>
                        <div class="setting-item">
                            <label for="advance-days">æå‰é ç´„å¤©æ•¸</label>
                            <input type="number" id="advance-days" min="1" max="30" value="3">
                        </div>
                        <div class="setting-description">
                            è¨­ç½®ç”¨æˆ¶å¿…é ˆæå‰å¤šå°‘å¤©é€²è¡Œé ç´„ã€‚ä¾‹å¦‚ï¼šè¨­ç½®ç‚º3ï¼Œå‰‡ç”¨æˆ¶åªèƒ½é ç´„3å¤©å¾Œçš„æ—¥æœŸã€‚
                        </div>
                        
                        <div class="setting-item">
                            <label for="admin-phone">ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼</label>
                            <input type="tel" id="admin-phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
                        </div>
                        <div class="setting-description">
                            è¨­ç½®ç®¡ç†å“¡æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œç”¨æ–¼æ¥æ”¶æ–°é ç´„é€šçŸ¥ã€‚
                        </div>
                        
                        <div class="buttons" style="margin-top: 15px;">
                            <button class="btn-primary" id="save-settings">ä¿å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="password-tab">
                    <div class="settings-group">
                        <h3>ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
                        <div class="form-group">
                            <label for="current-password">ç•¶å‰å¯†ç¢¼</label>
                            <input type="password" id="current-password" placeholder="è«‹è¼¸å…¥ç•¶å‰å¯†ç¢¼" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password">æ–°å¯†ç¢¼</label>
                            <input type="password" id="new-password" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm-password" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" required>
                        </div>
                        
                        <div class="buttons" style="margin-top: 15px;">
                            <button class="btn-primary" id="change-password">ä¿®æ”¹å¯†ç¢¼</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="qrcode-tab">
                    <div class="qrcode-container">
                        <h3>æƒæäºŒç¶­ç¢¼é€²è¡Œé ç´„</h3>
                        <div id="qrcode"></div>
                        <p>ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸Šæ–¹äºŒç¶­ç¢¼</p>
                        <button class="btn-secondary" id="back-from-qrcode" style="margin-top: 15px;">è¿”å›ç®¡ç†</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ­¸é‚„ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="return-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">è¨­å‚™æ­¸é‚„ç¢ºèª</div>
                <button class="close-modal" id="close-return-modal">Ã—</button>
            </div>
            <div id="return-modal-content">
                <!-- å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- é ç´„è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="appointment-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">é ç´„è©³æƒ…</div>
                <button class="close-modal" id="close-appointment-detail-modal">Ã—</button>
            </div>
            <div id="appointment-detail-content">
                <!-- å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- é§å›ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="reject-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">é§å›é ç´„ç”³è«‹</div>
                <button class="close-modal" id="close-reject-modal">Ã—</button>
            </div>
            <div id="reject-modal-content">
                <!-- å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ‰“å°å°ˆç”¨å®¹å™¨ -->
    <div class="print-container" id="print-container">
        <div class="print-header">
            <h1>iPadè¨­å‚™é ç´„è©³æƒ…</h1>
            <p>é ç´„ç³»çµ±æ‰“å°æ†‘è­‰</p>
        </div>
        <div class="print-details" id="print-details">
            <!-- æ‰“å°å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="print-footer">
            <p>æ‰“å°æ™‚é–“: <span id="print-time"></span></p>
            <p>è«‹å¦¥å–„ä¿ç®¡æ­¤æ†‘è­‰</p>
        </div>
    </div>

    <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading"></div>
        <span>æ­£åœ¨åŠ è¼‰æ•¸æ“š...</span>
    </div>

    <script>
        // ä½¿ç”¨JSONBin.ioä½œä¸ºå…è´¹çš„æ•°æ®å­˜å‚¨æœåŠ¡
        const JSONBIN_BIN_ID = '67d9b6eae41b4d34e4a8c0e3'; // è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹IDï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦åˆ›å»ºè‡ªå·±çš„bin
        const JSONBIN_API_KEY = '$2a$10$6HhX7p3p8Q9rT2uV1w3x4y5z6A7B8C9D0E1F2G3H4I5J6K7L8M9N0O1P2Q'; // ç¤ºä¾‹APIå¯†é’¥
        
        // ç³»ç»Ÿè®¾ç½®
        let systemSettings = {
            enableApproval: false,
            advanceDays: 3,
            adminPhone: ""
        };
        
        // ç®¡ç†å‘˜å¯†ç 
        let adminPassword = 'ipadadmin';
        
        // å½“å‰æŸ¥çœ‹çš„å‘¨æ¬¡
        let currentWeekOffset = 0;
        let isAdminLoggedIn = false;
        let lastActivityTime = Date.now();
        let logoutTimer;
        
        // é¢„çº¦æ•°æ®
        let appointments = [];
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        // ä»JSONBin.ioåŠ è½½æ•°æ®
        async function loadDataFromServer() {
            try {
                showLoading();
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                hideLoading();
                
                if (data.record) {
                    // åŠ è½½é¢„çº¦æ•°æ®
                    if (data.record.appointments) {
                        appointments = data.record.appointments;
                    }
                    
                    // åŠ è½½ç³»ç»Ÿè®¾ç½®
                    if (data.record.systemSettings) {
                        systemSettings = data.record.systemSettings;
                        updateSettingsForm();
                    }
                    
                    // åŠ è½½ç®¡ç†å‘˜å¯†ç 
                    if (data.record.adminPassword) {
                        adminPassword = data.record.adminPassword;
                    }
                    
                    console.log('æ•°æ®åŠ è½½æˆåŠŸ');
                    return true;
                }
            } catch (error) {
                hideLoading();
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                // å¦‚æœç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡
                loadFromLocalStorage();
            }
            return false;
        }
        
        // ä¿å­˜æ•°æ®åˆ°JSONBin.io
        async function saveDataToServer() {
            try {
                const dataToSave = {
                    appointments: appointments,
                    systemSettings: systemSettings,
                    adminPassword: adminPassword
                };
                
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
                
                console.log('æ•°æ®ä¿å­˜æˆåŠŸ');
                // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºç¼“å­˜
                saveToLocalStorage();
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                // å¦‚æœç½‘ç»œä¿å­˜å¤±è´¥ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveToLocalStorage();
                return false;
            }
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
        function loadFromLocalStorage() {
            const savedAppointments = localStorage.getItem('ipadAppointments');
            const savedSettings = localStorage.getItem('ipadSystemSettings');
            const savedPassword = localStorage.getItem('adminPassword');
            
            if (savedAppointments) {
                appointments = JSON.parse(savedAppointments);
            }
            
            if (savedSettings) {
                systemSettings = JSON.parse(savedSettings);
                updateSettingsForm();
            }
            
            if (savedPassword) {
                adminPassword = savedPassword;
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
        function saveToLocalStorage() {
            localStorage.setItem('ipadAppointments', JSON.stringify(appointments));
            localStorage.setItem('ipadSystemSettings', JSON.stringify(systemSettings));
            localStorage.setItem('adminPassword', adminPassword);
        }
        
        // æ›´æ–°ç³»ç»Ÿè®¾ç½®è¡¨å•
        function updateSettingsForm() {
            document.getElementById('advance-days').value = systemSettings.advanceDays;
            document.getElementById('admin-phone').value = systemSettings.adminPhone || '';
        }
        
        // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
        function updateLastActivityTime() {
            lastActivityTime = Date.now();
        }
        
        // è®¾ç½®è‡ªåŠ¨ç™»å‡ºè®¡æ—¶å™¨
        function setupAutoLogout() {
            // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
            if (logoutTimer) {
                clearTimeout(logoutTimer);
            }
            
            // è®¾ç½®æ–°çš„è®¡æ—¶å™¨ï¼ˆ30åˆ†é’Ÿåè‡ªåŠ¨ç™»å‡ºï¼‰
            logoutTimer = setTimeout(() => {
                isAdminLoggedIn = false;
                alert('ç”±äºé•¿æ—¶é—´æ— æ“ä½œï¼Œæ‚¨å·²è‡ªåŠ¨ç™»å‡ºç®¡ç†å‘˜è´¦å·ã€‚');
                
                // å¦‚æœå½“å‰åœ¨ç®¡ç†é¡µé¢ï¼Œè¿”å›é¦–é¡µ
                if (document.getElementById('admin-page').classList.contains('active') || 
                    document.getElementById('return-page').classList.contains('active')) {
                    document.getElementById('admin-page').classList.remove('active');
                    document.getElementById('return-page').classList.remove('active');
                    document.getElementById('home-page').classList.add('active');
                }
            }, 30 * 60 * 1000); // 30åˆ†é’Ÿ
        }
        
        // é¡µé¢åˆ‡æ¢é€»è¾‘
        document.getElementById('go-to-appointment').addEventListener('click', function() {
            document.getElementById('home-page').classList.remove('active');
            document.getElementById('appointment-page').classList.add('active');
            document.getElementById('success-message').style.display = 'none';
            updateLastActivityTime();
        });
        
        document.getElementById('go-to-schedule').addEventListener('click', function() {
            document.getElementById('home-page').classList.remove('active');
            document.getElementById('schedule-page').classList.add('active');
            updateScheduleView();
            updateLastActivityTime();
        });
        
        document.getElementById('go-to-return').addEventListener('click', function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å…¥ç®¡ç†å‘˜
            if (!isAdminLoggedIn) {
                document.getElementById('home-page').classList.remove('active');
                document.getElementById('login-page').classList.add('active');
            } else {
                document.getElementById('home-page').classList.remove('active');
                document.getElementById('return-page').classList.add('active');
                updateReturnList();
            }
            updateLastActivityTime();
        });
        
        document.getElementById('back-to-home').addEventListener('click', function() {
            document.getElementById('appointment-page').classList.remove('active');
            document.getElementById('home-page').classList.add('active');
            updateLastActivityTime();
        });
        
        document.getElementById('back-to-home-from-schedule').addEventListener('click', function() {
            document.getElementById('schedule-page').classList.remove('active');
            document.getElementById('home-page').classList.add('active');
            updateLastActivityTime();
        });
        
        document.getElementById('back-to-home-from-return').addEventListener('click', function() {
            document.getElementById('return-page').classList.remove('active');
            document.getElementById('home-page').classList.add('active');
            updateLastActivityTime();
        });
        
        document.getElementById('back-to-home-from-login').addEventListener('click', function() {
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('home-page').classList.add('active');
            updateLastActivityTime();
        });
        
        document.getElementById('back-to-home-admin').addEventListener('click', function() {
            document.getElementById('admin-page').classList.remove('active');
            document.getElementById('home-page').classList.add('active');
            updateLastActivityTime();
        });
        
        document.getElementById('admin-link').addEventListener('click', function(e) {
            e.preventDefault();
            if (isAdminLoggedIn) {
                document.getElementById('home-page').classList.remove('active');
                document.getElementById('admin-page').classList.add('active');
                updateAppointmentsTable();
            } else {
                document.getElementById('home-page').classList.remove('active');
                document.getElementById('login-page').classList.add('active');
            }
            updateLastActivityTime();
        });

        // ç™»å…¥è¡¨å•æäº¤
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            
            if (username === 'admin' && password === adminPassword) {
                isAdminLoggedIn = true;
                updateLastActivityTime();
                setupAutoLogout();
                
                document.getElementById('login-page').classList.remove('active');
                document.getElementById('admin-page').classList.add('active');
                loginError.style.display = 'none';
                updateAppointmentsTable();
            } else {
                loginError.style.display = 'block';
            }
            updateLastActivityTime();
        });

        // ç”ŸæˆiPadæ•°é‡é€‰é¡¹
        function generateIpadCountOptions() {
            const select = document.getElementById('ipad-count');
            for (let i = 1; i <= 48; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}å°`;
                select.appendChild(option);
            }
        }
        
        // ç”Ÿæˆæ—¶é—´é€‰é¡¹ (08:00-18:00)
        function generateTimeOptions() {
            const startSelect = document.getElementById('start-time');
            const endSelect = document.getElementById('end-time');
            
            startSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å¼€å§‹æ—¶é—´</option>';
            endSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç»“æŸæ—¶é—´</option>';
            
            for (let hour = 8; hour <= 18; hour++) {
                for (let minute of [0, 10, 20, 30, 40, 50]) {
                    if (hour === 18 && minute > 0) continue;
                    
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    const startOption = document.createElement('option');
                    startOption.value = timeString;
                    startOption.textContent = timeString;
                    startSelect.appendChild(startOption);
                    
                    const endOption = document.createElement('option');
                    endOption.value = timeString;
                    endOption.textContent = timeString;
                    endSelect.appendChild(endOption);
                }
            }
        }
        
        // æ£€æŸ¥æ—¶é—´å†²çª
        function checkTimeConflict(startDate, startTime, endDate, endTime) {
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(`${endDate}T${endTime}`);
            
            if (startDateTime >= endDateTime) {
                return { conflict: true, message: 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´' };
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰é¢„çº¦å†²çª
            for (const appointment of appointments) {
                if (appointment.status !== 'approved') continue;
                
                const appStart = new Date(appointment.startTime);
                const appEnd = new Date(appointment.endTime);
                
                if ((startDateTime >= appStart && startDateTime < appEnd) ||
                    (endDateTime > appStart && endDateTime <= appEnd) ||
                    (startDateTime <= appStart && endDateTime >= appEnd)) {
                    return { 
                        conflict: true, 
                        message: `ä¸ ${appointment.applicant} çš„é¢„çº¦æ—¶æ®µå†²çª (${appointment.startTime.split('T')[0]} ${appointment.startTime.split('T')[1]} - ${appointment.endTime.split('T')[1]})` 
                    };
                }
            }
            
            return { conflict: false, message: '' };
        }
        
        // æ£€æŸ¥æå‰é¢„çº¦è§„åˆ™
        function checkAdvanceBooking(startDate) {
            const today = new Date();
            const start = new Date(startDate);
            const diffTime = start - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < systemSettings.advanceDays) {
                return { 
                    warning: true, 
                    message: `æ‚¨å¿…é¡»æå‰ ${systemSettings.advanceDays} å¤©é¢„çº¦ï¼Œè¯·é€‰æ‹© ${systemSettings.advanceDays} å¤©åçš„æ—¥æœŸ` 
                };
            }
            
            return { warning: false, message: '' };
        }
        
        // æ›´æ–°é€‰æ‹©çš„æ—¶é—´æ˜¾ç¤º
        function updateSelectedTimeDisplay() {
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            
            const selectedTimeDiv = document.getElementById('selected-time');
            const conflictWarning = document.getElementById('conflict-warning');
            const advanceWarning = document.getElementById('advance-warning');
            
            if (startDate && startTime && endDate && endTime) {
                selectedTimeDiv.textContent = `${startDate} ${startTime} - ${endDate} ${endTime}`;
                
                // æ£€æŸ¥æ—¶é—´å†²çª
                const conflictResult = checkTimeConflict(startDate, startTime, endDate, endTime);
                if (conflictResult.conflict) {
                    conflictWarning.textContent = conflictResult.message;
                    conflictWarning.style.display = 'block';
                } else {
                    conflictWarning.style.display = 'none';
                }
                
                // æ£€æŸ¥æå‰é¢„çº¦
                const advanceResult = checkAdvanceBooking(startDate);
                if (advanceResult.warning) {
                    advanceWarning.textContent = advanceResult.message;
                    advanceWarning.style.display = 'block';
                } else {
                    advanceWarning.style.display = 'none';
                }
            } else {
                selectedTimeDiv.textContent = 'æœªé€‰æ‹©æ—¶é—´æ®µ';
                conflictWarning.style.display = 'none';
                advanceWarning.style.display = 'none';
            }
            updateLastActivityTime();
        }
        
        // é¢„çº¦è¡¨å•æäº¤
        document.getElementById('appointment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const applicant = document.getElementById('applicant').value;
            const phone = document.getElementById('applicant-phone').value;
            const count = document.getElementById('ipad-count').value;
            const purpose = document.getElementById('purpose').value;
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;
            
            // æ£€æŸ¥æ‰‹æœºå·ç æ ¼å¼
            const phonePattern = /^[0-9]{11}$/;
            if (!phonePattern.test(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                return;
            }
            
            // æ£€æŸ¥æ—¶é—´å†²çª
            const conflictResult = checkTimeConflict(startDate, startTime, endDate, endTime);
            if (conflictResult.conflict) {
                alert(conflictResult.message);
                return;
            }
            
            // æ£€æŸ¥æå‰é¢„çº¦
            const advanceResult = checkAdvanceBooking(startDate);
            if (advanceResult.warning) {
                alert(advanceResult.message);
                return;
            }
            
            // ç”Ÿæˆæ–°é¢„çº¦
            const newAppointment = {
                id: appointments.length > 0 ? Math.max(...appointments.map(a => a.id)) + 1 : 1,
                applicant: applicant,
                phone: phone,
                count: parseInt(count),
                startTime: `${startDate}T${startTime}`,
                endTime: `${endDate}T${endTime}`,
                purpose: purpose,
                status: systemSettings.enableApproval ? 'pending' : 'approved',
                color: getRandomColor(),
                returned: false,
                returnNotes: '',
                returnPhotos: [],
                returnChecks: {},
                returnTime: null,
                createTime: new Date().toISOString()
            };
            
            appointments.push(newAppointment);
            
            // ä¿å­˜åˆ°æœåŠ¡å™¨
            const success = await saveDataToServer();
            if (!success) {
                alert('é¢„çº¦æäº¤æˆåŠŸï¼Œä½†æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            document.getElementById('success-message').style.display = 'block';
            document.getElementById('appointment-form').reset();
            document.getElementById('selected-time').textContent = 'æœªé€‰æ‹©æ—¶é—´æ®µ';
            document.getElementById('conflict-warning').style.display = 'none';
            document.getElementById('advance-warning').style.display = 'none';
            
            updateLastActivityTime();
        });
        
        // ç”Ÿæˆéšæœºé¢œè‰²
        function getRandomColor() {
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#d35400', '#34495e'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // æ›´æ–°é¢„çº¦è¡¨æ ¼
        function updateAppointmentsTable() {
            const tbody = document.querySelector('#appointments-table tbody');
            tbody.innerHTML = '';
            
            // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
            const sortedAppointments = [...appointments].sort((a, b) => 
                new Date(b.createTime) - new Date(a.createTime)
            );
            
            sortedAppointments.forEach(appointment => {
                const row = document.createElement('tr');
                
                // çŠ¶æ€æ˜¾ç¤º
                let statusText = '';
                let statusClass = '';
                switch(appointment.status) {
                    case 'pending':
                        statusText = 'å¾…å®¡æ ¸';
                        statusClass = 'status-pending';
                        break;
                    case 'approved':
                        statusText = 'å·²æ‰¹å‡†';
                        statusClass = 'status-approved';
                        break;
                    case 'rejected':
                        statusText = 'å·²é©³å›';
                        statusClass = 'status-rejected';
                        break;
                }
                
                if (appointment.returned) {
                    statusText = 'å·²å½’è¿˜';
                    statusClass = 'status-returned';
                }
                
                // åªæœ‰æœªå½’è¿˜ä¸”ä¸æ˜¯å·²é©³å›çš„é¢„çº¦æ‰æ˜¾ç¤ºé©³å›æŒ‰é’®
                const rejectButton = (!appointment.returned && appointment.status !== 'rejected') ? 
                    `<button class="btn-danger reject-btn" data-id="${appointment.id}">é©³å›</button>` : '';
                
                row.innerHTML = `
                    <td>${appointment.applicant}</td>
                    <td>${appointment.phone}</td>
                    <td>${appointment.count}å°</td>
                    <td>${formatAppointmentTime(appointment.startTime, appointment.endTime)}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn-primary view-detail-btn" data-id="${appointment.id}">æŸ¥çœ‹è¯¦æƒ…</button>
                        ${rejectButton}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.view-detail-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    showAppointmentDetail(id);
                    updateLastActivityTime();
                });
            });
            
            // æ·»åŠ é©³å›æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.reject-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    showRejectModal(id);
                    updateLastActivityTime();
                });
            });
        }
        
        // æ˜¾ç¤ºé©³å›ç¡®è®¤æ¨¡æ€æ¡†
        function showRejectModal(id) {
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            
            const modalContent = document.getElementById('reject-modal-content');
            modalContent.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">ç”³è¯·äºº</div>
                        <div class="detail-value">${appointment.applicant}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">iPadæ•°é‡</div>
                        <div class="detail-value">${appointment.count}å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é¢„çº¦æ—¶é—´</div>
                        <div class="detail-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reject-reason">é©³å›åŸå› </label>
                    <textarea id="reject-reason" rows="3" placeholder="è¯·è¾“å…¥é©³å›æ­¤é¢„çº¦çš„åŸå› " required></textarea>
                </div>
                
                <div class="buttons">
                    <button class="btn-secondary" id="cancel-reject">å–æ¶ˆ</button>
                    <button class="btn-danger" id="confirm-reject" data-id="${appointment.id}">ç¡®è®¤é©³å›</button>
                </div>
            `;
            
            document.getElementById('reject-modal').style.display = 'flex';
            
            // ç¡®è®¤é©³å›æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-reject').addEventListener('click', async function() {
                const appointmentId = parseInt(this.getAttribute('data-id'));
                const appointmentIndex = appointments.findIndex(a => a.id === appointmentId);
                const rejectReason = document.getElementById('reject-reason').value;
                
                if (appointmentIndex !== -1 && rejectReason.trim() !== '') {
                    // æ›´æ–°é¢„çº¦çŠ¶æ€ä¸ºé©³å›
                    appointments[appointmentIndex].status = 'rejected';
                    appointments[appointmentIndex].rejectReason = rejectReason;
                    
                    // ä¿å­˜åˆ°æœåŠ¡å™¨
                    const success = await saveDataToServer();
                    if (!success) {
                        alert('æ“ä½œæˆåŠŸï¼Œä½†æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    alert('é¢„çº¦å·²æˆåŠŸé©³å›ï¼');
                    document.getElementById('reject-modal').style.display = 'none';
                    updateAppointmentsTable();
                } else {
                    alert('è¯·å¡«å†™é©³å›åŸå› ');
                }
                updateLastActivityTime();
            });
            
            // å–æ¶ˆé©³å›æŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-reject').addEventListener('click', function() {
                document.getElementById('reject-modal').style.display = 'none';
                updateLastActivityTime();
            });
        }
        
        // æ˜¾ç¤ºé¢„çº¦è¯¦æƒ…
        function showAppointmentDetail(id) {
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            
            const modalContent = document.getElementById('appointment-detail-content');
            
            // ç”Ÿæˆå½’è¿˜æ£€æŸ¥ä¿¡æ¯
            let returnChecksInfo = '';
            if (appointment.returned && appointment.returnChecks) {
                const checks = appointment.returnChecks;
                const checkedItems = [];
                
                if (checks.deviceCount) checkedItems.push('è®¾å¤‡æ•°é‡æ­£ç¡®');
                if (checks.deviceCondition) checkedItems.push('è®¾å¤‡å¤–è§‚å®Œå¥½');
                if (checks.accessories) checkedItems.push('é…ä»¶é½å…¨');
                
                if (checkedItems.length > 0) {
                    returnChecksInfo = `
                        <div class="detail-item">
                            <div class="detail-label">å½’è¿˜æ£€æŸ¥é¡¹ç›®</div>
                            <div class="detail-value">${checkedItems.join('ã€')}</div>
                        </div>
                    `;
                }
            }
            
            // é©³å›åŸå› 
            let rejectReasonInfo = '';
            if (appointment.status === 'rejected' && appointment.rejectReason) {
                rejectReasonInfo = `
                    <div class="detail-item">
                        <div class="detail-label">é©³å›åŸå› </div>
                        <div class="detail-value">${appointment.rejectReason}</div>
                    </div>
                `;
            }
            
            // å½’è¿˜ç…§ç‰‡
            let returnPhotosInfo = '';
            if (appointment.returned && appointment.returnPhotos && appointment.returnPhotos.length > 0) {
                returnPhotosInfo = `
                    <div class="detail-item">
                        <div class="detail-label">å½’è¿˜ç…§ç‰‡</div>
                        <div class="detail-value">
                            <div class="photo-preview">
                                ${appointment.returnPhotos.map(photo => `
                                    <div class="photo-item">
                                        <img src="${photo}" alt="å½’è¿˜ç…§ç‰‡">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">ç”³è¯·äºº</div>
                        <div class="detail-value">${appointment.applicant}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è”ç³»ç”µè¯</div>
                        <div class="detail-value">${appointment.phone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">iPadæ•°é‡</div>
                        <div class="detail-value">${appointment.count}å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä½¿ç”¨ç›®çš„</div>
                        <div class="detail-value">${appointment.purpose}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é¢„çº¦æ—¶é—´</div>
                        <div class="detail-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">çŠ¶æ€</div>
                        <div class="detail-value">
                            ${appointment.returned ? 'å·²å½’è¿˜' : 
                              appointment.status === 'approved' ? 'å·²æ‰¹å‡†' : 
                              appointment.status === 'pending' ? 'å¾…å®¡æ ¸' : 'å·²é©³å›'}
                        </div>
                    </div>
                    ${rejectReasonInfo}
                    ${appointment.returned ? `
                    <div class="detail-item">
                        <div class="detail-label">å½’è¿˜æ—¶é—´</div>
                        <div class="detail-value">${appointment.returnTime ? new Date(appointment.returnTime).toLocaleString() : 'æœªè®°å½•'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å½’è¿˜å¤‡æ³¨</div>
                        <div class="detail-value">${appointment.returnNotes || 'æ— '}</div>
                    </div>
                    ${returnChecksInfo}
                    ${returnPhotosInfo}
                    ` : ''}
                </div>
                <div class="buttons" style="margin-top: 15px;">
                    <button class="btn-secondary" id="close-detail-modal">å…³é—­</button>
                    <button class="btn-print" id="print-detail" data-id="${appointment.id}">æ‰“å°</button>
                </div>
            `;
            
            document.getElementById('appointment-detail-modal').style.display = 'flex';
            
            // æ·»åŠ æ‰“å°æŒ‰é’®äº‹ä»¶
            document.getElementById('print-detail').addEventListener('click', function() {
                const appointmentId = parseInt(this.getAttribute('data-id'));
                printAppointmentDetail(appointmentId);
                updateLastActivityTime();
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('close-detail-modal').addEventListener('click', function() {
                document.getElementById('appointment-detail-modal').style.display = 'none';
                updateLastActivityTime();
            });
        }
        
        // æ‰“å°é¢„çº¦è¯¦æƒ…
        function printAppointmentDetail(id) {
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            
            // æ›´æ–°æ‰“å°å†…å®¹
            const printDetails = document.getElementById('print-details');
            const printTime = document.getElementById('print-time');
            
            // è®¾ç½®æ‰“å°æ—¶é—´
            printTime.textContent = new Date().toLocaleString();
            
            // ç”Ÿæˆæ‰“å°å†…å®¹
            let printContent = '';
            
            printContent += `
                <div class="print-detail-item">
                    <div class="print-label">ç”³è¯·äºº</div>
                    <div class="print-value">${appointment.applicant}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">è”ç³»ç”µè¯</div>
                    <div class="print-value">${appointment.phone}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">iPadæ•°é‡</div>
                    <div class="print-value">${appointment.count}å°</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">ä½¿ç”¨ç›®çš„</div>
                    <div class="print-value">${appointment.purpose}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">é¢„çº¦æ—¶é—´</div>
                    <div class="print-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div>
                </div>
                <div class="print-detail-item">
                    <div class="print-label">çŠ¶æ€</div>
                    <div class="print-value">
                        ${appointment.returned ? 'å·²å½’è¿˜' : 
                          appointment.status === 'approved' ? 'å·²æ‰¹å‡†' : 
                          appointment.status === 'pending' ? 'å¾…å®¡æ ¸' : 'å·²é©³å›'}
                    </div>
                </div>
            `;
            
            if (appointment.status === 'rejected' && appointment.rejectReason) {
                printContent += `
                    <div class="print-detail-item">
                        <div class="print-label">é©³å›åŸå› </div>
                        <div class="print-value">${appointment.rejectReason}</div>
                    </div>
                `;
            }
            
            if (appointment.returned) {
                printContent += `
                    <div class="print-detail-item">
                        <div class="print-label">å½’è¿˜æ—¶é—´</div>
                        <div class="print-value">${appointment.returnTime ? new Date(appointment.returnTime).toLocaleString() : 'æœªè®°å½•'}</div>
                    </div>
                    <div class="print-detail-item">
                        <div class="print-label">å½’è¿˜å¤‡æ³¨</div>
                        <div class="print-value">${appointment.returnNotes || 'æ— '}</div>
                    </div>
                `;
                
                if (appointment.returnChecks) {
                    const checks = appointment.returnChecks;
                    const checkedItems = [];
                    
                    if (checks.deviceCount) checkedItems.push('è®¾å¤‡æ•°é‡æ­£ç¡®');
                    if (checks.deviceCondition) checkedItems.push('è®¾å¤‡å¤–è§‚å®Œå¥½');
                    if (checks.accessories) checkedItems.push('é…ä»¶é½å…¨');
                    
                    if (checkedItems.length > 0) {
                        printContent += `
                            <div class="print-detail-item">
                                <div class="print-label">å½’è¿˜æ£€æŸ¥é¡¹ç›®</div>
                                <div class="print-value">${checkedItems.join('ã€')}</div>
                            </div>
                        `;
                    }
                }
            }
            
            printDetails.innerHTML = printContent;
            
            // æ˜¾ç¤ºæ‰“å°å®¹å™¨å¹¶è§¦å‘æ‰“å°
            document.getElementById('print-container').style.display = 'block';
            window.print();
            document.getElementById('print-container').style.display = 'none';
        }
        
        // æ ¼å¼åŒ–é¢„çº¦æ—¶é—´æ˜¾ç¤º
        function formatAppointmentTime(startTime, endTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            const startDateStr = `${start.getMonth() + 1}/${start.getDate()}`;
            const startTimeStr = `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}`;
            const endTimeStr = `${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`;
            
            return `${startDateStr} ${startTimeStr}-${endTimeStr}`;
        }
        
        // æ›´æ–°å½’è¿˜åˆ—è¡¨
        function updateReturnList() {
            const returnList = document.getElementById('return-list');
            returnList.innerHTML = '';
            
            const pendingReturns = appointments.filter(a => a.status === 'approved' && !a.returned);
            
            if (pendingReturns.length === 0) {
                returnList.innerHTML = '<p style="text-align: center; padding: 20px;">æš‚æ— å¾…å½’è¿˜è®¾å¤‡</p>';
                return;
            }
            
            pendingReturns.forEach(appointment => {
                const returnItem = document.createElement('div');
                returnItem.className = 'return-item';
                
                returnItem.innerHTML = `
                    <div class="return-item-header">
                        <div><strong>${appointment.applicant}</strong></div>
                        <div>${appointment.count}å°iPad</div>
                    </div>
                    <div class="return-item-details">
                        <div>è”ç³»ç”µè¯: ${appointment.phone}</div>
                        <div>å€Ÿç”¨æ—¶é—´: ${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div>
                        <div>ä½¿ç”¨ç›®çš„: ${appointment.purpose}</div>
                    </div>
                    <div class="return-actions">
                        <button class="btn-success return-btn" data-id="${appointment.id}">å½’è¿˜ç™»è®°</button>
                    </div>
                `;
                
                returnList.appendChild(returnItem);
            });
            
            // æ·»åŠ å½’è¿˜æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.return-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    showReturnModal(id);
                    updateLastActivityTime();
                });
            });
        }
        
        // æ˜¾ç¤ºå½’è¿˜ç¡®è®¤æ¨¡æ€æ¡†
        function showReturnModal(id) {
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;
            
            const modalContent = document.getElementById('return-modal-content');
            modalContent.innerHTML = `
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">ç”³è¯·äºº</div>
                        <div class="detail-value">${appointment.applicant}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">iPadæ•°é‡</div>
                        <div class="detail-value">${appointment.count}å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å€Ÿç”¨æ—¶é—´</div>
                        <div class="detail-value">${formatAppointmentTime(appointment.startTime, appointment.endTime)}</div>
                    </div>
                </div>
                
                <div class="return-check-options">
                    <div class="check-option">
                        <input type="checkbox" id="check-device-count" name="check-device-count">
                        <label for="check-device-count">è®¾å¤‡æ•°é‡æ­£ç¡®</label>
                    </div>
                    <div class="check-option">
                        <input type="checkbox" id="check-device-condition" name="check-device-condition">
                        <label for="check-device-condition">è®¾å¤‡å¤–è§‚å®Œå¥½</label>
                    </div>
                    <div class="check-option">
                        <input type="checkbox" id="check-accessories" name="check-accessories">
                        <label for="check-accessories">é…ä»¶é½å…¨</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="return-notes">å½’è¿˜å¤‡æ³¨</label>
                    <textarea id="return-notes" rows="3" placeholder="è¯·è¾“å…¥å½’è¿˜å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                
                <div class="photo-upload">
                    <label>è®¾å¤‡çŠ¶å†µç…§ç‰‡ï¼ˆå¦‚æœ‰æŸåè¯·æ‹ç…§ä¸Šä¼ ï¼‰</label>
                    <input type="file" id="photo-upload-input" accept="image/*" multiple style="display: none;">
                    <div class="upload-btn" id="upload-photo-btn">é€‰æ‹©ç…§ç‰‡</div>
                    <div class="photo-preview" id="photo-preview"></div>
                </div>
                
                <div class="buttons">
                    <button class="btn-secondary" id="cancel-return">å–æ¶ˆ</button>
                    <button class="btn-success" id="confirm-return" data-id="${appointment.id}">ç¡®è®¤å½’è¿˜</button>
                </div>
            `;
            
            document.getElementById('return-modal').style.display = 'flex';
            
            // ç…§ç‰‡ä¸Šä¼ åŠŸèƒ½
            const uploadInput = document.getElementById('photo-upload-input');
            const uploadBtn = document.getElementById('upload-photo-btn');
            const photoPreview = document.getElementById('photo-preview');
            let uploadedPhotos = [];
            
            uploadBtn.addEventListener('click', function() {
                uploadInput.click();
            });
            
            uploadInput.addEventListener('change', function(e) {
                const files = e.target.files;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const photoData = e.target.result;
                            uploadedPhotos.push(photoData);
                            
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-item';
                            
                            const img = document.createElement('img');
                            img.src = photoData;
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-photo';
                            removeBtn.innerHTML = 'Ã—';
                            removeBtn.addEventListener('click', function() {
                                const index = uploadedPhotos.indexOf(photoData);
                                if (index !== -1) {
                                    uploadedPhotos.splice(index, 1);
                                }
                                photoItem.remove();
                            });
                            
                            photoItem.appendChild(img);
                            photoItem.appendChild(removeBtn);
                            photoPreview.appendChild(photoItem);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
            
            // ç¡®è®¤å½’è¿˜æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-return').addEventListener('click', async function() {
                const appointmentId = parseInt(this.getAttribute('data-id'));
                const appointmentIndex = appointments.findIndex(a => a.id === appointmentId);
                
                if (appointmentIndex !== -1) {
                    // æ”¶é›†æ£€æŸ¥ç»“æœ
                    const checks = {
                        deviceCount: document.getElementById('check-device-count').checked,
                        deviceCondition: document.getElementById('check-device-condition').checked,
                        accessories: document.getElementById('check-accessories').checked
                    };
                    
                    const notes = document.getElementById('return-notes').value;
                    
                    // æ›´æ–°é¢„çº¦è®°å½•
                    appointments[appointmentIndex].returned = true;
                    appointments[appointmentIndex].returnChecks = checks;
                    appointments[appointmentIndex].returnNotes = notes;
                    appointments[appointmentIndex].returnPhotos = uploadedPhotos;
                    appointments[appointmentIndex].returnTime = new Date().toISOString();
                    
                    // ä¿å­˜åˆ°æœåŠ¡å™¨
                    const success = await saveDataToServer();
                    if (!success) {
                        alert('å½’è¿˜ç™»è®°æˆåŠŸï¼Œä½†æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    alert('è®¾å¤‡å½’è¿˜ç™»è®°æˆåŠŸï¼');
                    document.getElementById('return-modal').style.display = 'none';
                    updateReturnList();
                    updateAppointmentsTable();
                }
                updateLastActivityTime();
            });
            
            // å–æ¶ˆå½’è¿˜æŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-return').addEventListener('click', function() {
                document.getElementById('return-modal').style.display = 'none';
                updateLastActivityTime();
            });
        }
        
        // æ›´æ–°é¢„çº¦è§†å›¾
        function updateScheduleView() {
            // è·å–å½“å‰å‘¨çš„æ—¥æœŸèŒƒå›´
            const today = new Date();
            const currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7));
            
            // æ›´æ–°å‘¨æ ‡é¢˜
            const weekTitle = document.getElementById('week-title');
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            weekTitle.textContent = `${currentWeekStart.getMonth() + 1}/${currentWeekStart.getDate()} - ${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`;
            
            // ç”Ÿæˆè¡¨å¤´
            const scheduleHeader = document.getElementById('schedule-header');
            scheduleHeader.innerHTML = '<div class="time-header-cell">æ—¶é—´</div>';
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(currentWeekStart);
                day.setDate(currentWeekStart.getDate() + i);
                
                const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                const dayName = dayNames[day.getDay()];
                const dateStr = `${day.getMonth() + 1}/${day.getDate()}`;
                
                const headerCell = document.createElement('div');
                headerCell.className = 'time-header-cell';
                headerCell.textContent = `${dayName} ${dateStr}`;
                scheduleHeader.appendChild(headerCell);
            }
            
            // ç”Ÿæˆæ—¶é—´æ®µ (08:00-18:00)
            const timeSlotsContainer = document.getElementById('time-slots-container');
            timeSlotsContainer.innerHTML = '';
            
            for (let hour = 8; hour <= 18; hour++) {
                for (let minute of [0, 30]) {
                    if (hour === 18 && minute === 30) continue;
                    
                    const timeSlotRow = document.createElement('div');
                    timeSlotRow.className = 'time-slot-row';
                    
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'time-label';
                    timeLabel.textContent = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    timeSlotRow.appendChild(timeLabel);
                    
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(currentWeekStart);
                        day.setDate(currentWeekStart.getDate() + i);
                        
                        const timeCell = document.createElement('div');
                        timeCell.className = 'time-cell';
                        timeCell.setAttribute('data-date', day.toISOString().split('T')[0]);
                        timeCell.setAttribute('data-time', `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                        timeSlotRow.appendChild(timeCell);
                    }
                    
                    timeSlotsContainer.appendChild(timeSlotRow);
                }
            }
            
            // æ·»åŠ é¢„çº¦å—
            appointments.forEach(appointment => {
                if (appointment.status !== 'approved') return;
                
                const startTime = new Date(appointment.startTime);
                const endTime = new Date(appointment.endTime);
                
                // æ£€æŸ¥é¢„çº¦æ˜¯å¦åœ¨å½“å‰å‘¨
                const weekStart = new Date(currentWeekStart);
                weekStart.setHours(0, 0, 0, 0);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                
                if (startTime >= weekEnd || endTime <= weekStart) return;
                
                // è®¡ç®—é¢„çº¦å—ä½ç½®
                const dayIndex = (startTime.getDay() + 7 - weekStart.getDay()) % 7;
                const startMinutes = startTime.getHours() * 60 + startTime.getMinutes();
                const endMinutes = endTime.getHours() * 60 + endTime.getMinutes();
                
                const top = ((startMinutes - 8 * 60) / 30) * 30;
                const height = ((endMinutes - startMinutes) / 30) * 30;
                
                // åˆ›å»ºé¢„çº¦å—
                const appointmentBlock = document.createElement('div');
                appointmentBlock.className = 'appointment-block';
                appointmentBlock.style.backgroundColor = appointment.color;
                appointmentBlock.style.top = `${top}px`;
                appointmentBlock.style.height = `${height}px`;
                
                const startTimeStr = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')}`;
                const endTimeStr = `${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
                
                appointmentBlock.innerHTML = `
                    <div class="appointment-info">${appointment.applicant}</div>
                    <div class="appointment-time">${startTimeStr}-${endTimeStr}</div>
                `;
                
                // æ‰¾åˆ°å¯¹åº”çš„æ—¥æœŸå•å…ƒæ ¼
                const dateStr = startTime.toISOString().split('T')[0];
                const timeCells = document.querySelectorAll(`.time-cell[data-date="${dateStr}"]`);
                
                if (timeCells.length > 0) {
                    timeCells[0].appendChild(appointmentBlock);
                }
            });
            
            // æ›´æ–°å›¾ä¾‹
            updateScheduleLegend();
            updateLastActivityTime();
        }
        
        // æ›´æ–°å›¾ä¾‹
        function updateScheduleLegend() {
            const legend = document.getElementById('schedule-legend');
            legend.innerHTML = '';
            
            const uniqueAppointments = [];
            appointments.forEach(appointment => {
                if (appointment.status !== 'approved') return;
                
                if (!uniqueAppointments.some(a => a.applicant === appointment.applicant)) {
                    uniqueAppointments.push(appointment);
                }
            });
            
            uniqueAppointments.forEach(appointment => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = appointment.color;
                
                const label = document.createElement('span');
                label.textContent = appointment.applicant;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legend.appendChild(legendItem);
            });
        }
        
        // å‘¨å¯¼èˆª
        document.getElementById('prev-week').addEventListener('click', function() {
            currentWeekOffset--;
            updateScheduleView();
        });
        
        document.getElementById('next-week').addEventListener('click', function() {
            currentWeekOffset++;
            updateScheduleView();
        });
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ ‡ç­¾å’Œå†…å®¹çš„activeç±»
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾å’Œå¯¹åº”å†…å®¹
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // å¦‚æœæ˜¯äºŒç»´ç æ ‡ç­¾ï¼Œç”ŸæˆäºŒç»´ç 
                if (tabId === 'qrcode') {
                    generateQRCode();
                }
                updateLastActivityTime();
            });
        });
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            // ç”Ÿæˆå½“å‰é¡µé¢çš„URLä½œä¸ºäºŒç»´ç å†…å®¹
            const currentUrl = window.location.href;
            
            QRCode.toCanvas(qrcodeContainer, currentUrl, function(error) {
                if (error) console.error(error);
            });
            updateLastActivityTime();
        }
        
        // ä¿å­˜ç³»ç»Ÿè®¾å®š
        document.getElementById('save-settings').addEventListener('click', async function() {
            systemSettings.advanceDays = parseInt(document.getElementById('advance-days').value);
            systemSettings.adminPhone = document.getElementById('admin-phone').value;
            
            // ä¿å­˜åˆ°æœåŠ¡å™¨
            const success = await saveDataToServer();
            if (success) {
                alert('ç³»ç»Ÿè®¾å®šå·²ä¿å­˜ï¼');
            } else {
                alert('ä¿å­˜æˆåŠŸï¼Œä½†æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
            
            // æ›´æ–°æ—¥æœŸè¾“å…¥çš„æœ€å°å€¼
            updateDateInputMin();
            updateLastActivityTime();
        });
        
        // æ›´æ–°æ—¥æœŸè¾“å…¥çš„æœ€å°å€¼
        function updateDateInputMin() {
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + systemSettings.advanceDays);
            
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            startDateInput.min = minDate.toISOString().split('T')[0];
            endDateInput.min = minDate.toISOString().split('T')[0];
        }
        
        // ä¿®æ”¹å¯†ç 
        document.getElementById('change-password').addEventListener('click', async function() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (currentPassword !== adminPassword) {
                alert('å½“å‰å¯†ç é”™è¯¯ï¼');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('æ–°å¯†ç ä¸ç¡®è®¤å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('æ–°å¯†ç é•¿åº¦è‡³å°‘éœ€è¦6ä½ï¼');
                return;
            }
            
            adminPassword = newPassword;
            
            // ä¿å­˜åˆ°æœåŠ¡å™¨
            const success = await saveDataToServer();
            if (success) {
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            } else {
                alert('ä¿®æ”¹æˆåŠŸï¼Œä½†æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
            
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            updateLastActivityTime();
        });
        
        // åˆ·æ–°é¢„çº¦æ•°æ®
        document.getElementById('refresh-appointments').addEventListener('click', async function() {
            const success = await loadDataFromServer();
            if (success) {
                updateAppointmentsTable();
                alert('æ•°æ®å·²åˆ·æ–°ï¼');
            } else {
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
            updateLastActivityTime();
        });
        
        // å…³é—­æ¨¡æ€æ¡†
        document.getElementById('close-return-modal').addEventListener('click', function() {
            document.getElementById('return-modal').style.display = 'none';
            updateLastActivityTime();
        });
        
        document.getElementById('close-appointment-detail-modal').addEventListener('click', function() {
            document.getElementById('appointment-detail-modal').style.display = 'none';
            updateLastActivityTime();
        });
        
        document.getElementById('close-reject-modal').addEventListener('click', function() {
            document.getElementById('reject-modal').style.display = 'none';
            updateLastActivityTime();
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('return-modal')) {
                document.getElementById('return-modal').style.display = 'none';
                updateLastActivityTime();
            }
            if (event.target === document.getElementById('appointment-detail-modal')) {
                document.getElementById('appointment-detail-modal').style.display = 'none';
                updateLastActivityTime();
            }
            if (event.target === document.getElementById('reject-modal')) {
                document.getElementById('reject-modal').style.display = 'none';
                updateLastActivityTime();
            }
        });
        
        // ç›‘å¬ç”¨æˆ·æ´»åŠ¨
        document.addEventListener('click', updateLastActivityTime);
        document.addEventListener('keypress', updateLastActivityTime);
        document.addEventListener('scroll', updateLastActivityTime);
        document.addEventListener('mousemove', updateLastActivityTime);
        
        // åˆå§‹åŒ–
        async function init() {
            generateIpadCountOptions();
            generateTimeOptions();
            
            // ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
            await loadDataFromServer();
            
            updateAppointmentsTable();
            
            // è®¾ç½®æ—¥æœŸè¾“å…¥çš„æœ€å°å€¼
            updateDateInputMin();
            
            // æ·»åŠ æ—¥æœŸå’Œæ—¶é—´å˜æ›´äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('start-date').addEventListener('change', updateSelectedTimeDisplay);
            document.getElementById('start-time').addEventListener('change', updateSelectedTimeDisplay);
            document.getElementById('end-date').addEventListener('change', updateSelectedTimeDisplay);
            document.getElementById('end-time').addEventListener('change', updateSelectedTimeDisplay);
            
            // è®¾ç½®å¼€å§‹æ—¥æœŸå˜æ›´æ—¶æ›´æ–°ç»“æŸæ—¥æœŸçš„æœ€å°å€¼
            document.getElementById('start-date').addEventListener('change', function() {
                document.getElementById('end-date').min = this.value;
                updateLastActivityTime();
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
